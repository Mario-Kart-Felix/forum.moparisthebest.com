<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/auto-cache-downloader-crashes/480706 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:07:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Auto Cache Downloader Crashes - Game Development - moparisthebest.com</title>
    <meta name="description" content="Hello, I have just been trying to finish up my client and when I came to test the cache downloader, my client freezes with no errors in the console. 

Here is my code: 

 import java.io.BufferedInputStream;
import java.i&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="480706.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Auto Cache Downloader Crashes&#39;" href="480706.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/auto-cache-downloader-crashes/480706" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/auto-cache-downloader-crashes/480706" />
<meta property="og:title" content="Auto Cache Downloader Crashes" />
<meta name="twitter:title" content="Auto Cache Downloader Crashes" />
<meta property="og:description" content="Hello, I have just been trying to finish up my client and when I came to test the cache downloader, my client freezes with no errors in the console.  Here is my code:  [CODE]import java.io.BufferedInputStream;  import java.io.BufferedOutputStream;  import java.io.BufferedWriter;  import java.io.File;  import java.io.FileInputStream;  import java.io.FileOutputStream;  import java.io.FileWriter;  import java.io.IOException;  import java.io.InputStream;  import java.net.URL;  import java.net.URLCon..." />
<meta name="twitter:description" content="Hello, I have just been trying to finish up my client and when I came to test the cache downloader, my client freezes with no errors in the console.  Here is my code:  [CODE]import java.io.BufferedInputStream;  import java.io.BufferedOutputStream;  import java.io.BufferedWriter;  import java.io.File;  import java.io.FileInputStream;  import java.io.FileOutputStream;  import java.io.FileWriter;  import java.io.IOException;  import java.io.InputStream;  import java.net.URL;  import java.net.URLCon..." />
<meta property="article:published_time" content="2013-01-30T03:19:14+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="480706.html">Auto Cache Downloader Crashes</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/general-programming.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>General Programming</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/general-programming/game-development.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Game Development</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/ProTayToe.html'><span itemprop='name'>ProTayToe</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2013-01-30T03:19:14Z'>
            <time itemprop='dateModified' datetime='2016-08-04T02:27:42Z' class='post-time'>
              August 4, 2016,  2:27am
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hello, I have just been trying to finish up my client and when I came to test the cache downloader, my client freezes with no errors in the console.</p>
<p>Here is my code:</p>
<p>[CODE]import java.io.BufferedInputStream;<br>
import java.io.BufferedOutputStream;<br>
import java.io.BufferedWriter;<br>
import java.io.File;<br>
import java.io.FileInputStream;<br>
import java.io.FileOutputStream;<br>
import java.io.FileWriter;<br>
import java.io.IOException;<br>
import java.io.InputStream;<br>
import java.net.URL;<br>
import java.net.URLConnection;<br>
import java.util.zip.ZipEntry;<br>
import java.util.zip.ZipInputStream;</p>
<p>public class CacheDownloader {</p>
<p>private Client client;<br>
private final int BUFFER = 1024;<br>
private final int VERSION = 1;<br>
private String cacheLink = “Cache link”; // obviously i have put my download link here, i just removed it so i could post it to you guys <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"><br>
private String fileToExtract = this.getCacheDir() + this.getArchivedName();</p>
<p>public CacheDownloader(Client client) {<br>
this.client = client;<br>
}</p>
<p>private void drawLoadingText(String text) {<br>
this.client.drawLoadingText(35, text);<br>
System.out.println(text);<br>
}</p>
<p>private void drawLoadingText(int amount, String text) {<br>
this.client.drawLoadingText(amount, text);<br>
System.out.println(text);<br>
}</p>
<p>private String getCacheDir() {<br>
return SignLink.findcachedir();<br>
}</p>
<p>private String getCacheLink() {<br>
return this.cacheLink;<br>
}</p>
<p>private int getCacheVersion() {<br>
return 1;<br>
}</p>
<p>public CacheDownloader downloadCache() {<br>
try {<br>
File e = new File(this.getCacheDir());<br>
File version = new File(this.getCacheDir() + “/cacheVersion” + this.getCacheVersion() + “.dat”);<br>
BufferedWriter versionFile;<br>
if(!e.exists()) {<br>
this.downloadFile(this.getCacheLink(), this.getArchivedName());<br>
this.unZip();<br>
System.out.println(“UNZIP”);<br>
versionFile = new BufferedWriter(new FileWriter(this.getCacheDir() + “/cacheVersion” + this.getCacheVersion() + “.dat”));<br>
versionFile.close();<br>
} else {<br>
if(version.exists()) {<br>
return null;<br>
}</p>
<pre><code>        this.downloadFile(this.getCacheLink(), this.getArchivedName());
        this.unZip();
        System.out.println("UNZIP");
        versionFile = new BufferedWriter(new FileWriter(this.getCacheDir() + "/cacheVersion" + this.getCacheVersion() + ".dat"));
        versionFile.close();
     }
  } catch (Exception var4) {
     ;
  }

  return null;
</code></pre>
<p>}</p>
<p>private void downloadFile(String adress, String localFileName) {<br>
BufferedOutputStream out = null;<br>
InputStream in = null;</p>
<pre><code>  try {
     URL ioe = new URL(adress);
     out = new BufferedOutputStream(new FileOutputStream(this.getCacheDir() + "/" + localFileName));
     URLConnection conn = ioe.openConnection();
     in = conn.getInputStream();
     byte[] data = new byte[1024];
     long numWritten = 0L;
     int length = conn.getContentLength();

     int numRead;
     while((numRead = in.read(data)) != -1) {
        out.write(data, 0, numRead);
        numWritten += (long)numRead;
        int percentage = (int)((double)numWritten / (double)length * 100.0D);
        this.drawLoadingText(percentage, "Downloading Cache " + percentage + "%");
     }

     System.out.println(localFileName + "\t" + numWritten);
     this.drawLoadingText("Finished downloading " + this.getArchivedName() + "!");
  } catch (Exception var21) {
     var21.printStackTrace();
  } finally {
     try {
        if(in != null) {
           in.close();
        }

        if(out != null) {
           out.close();
        }
     } catch (IOException var20) {
        ;
     }

  }
</code></pre>
<p>}</p>
<p>private String getArchivedName() {<br>
int lastSlashIndex = this.getCacheLink().lastIndexOf(47);<br>
if(lastSlashIndex &gt;= 0 &amp;&amp; lastSlashIndex &lt; this.getCacheLink().length() - 1) {<br>
return this.getCacheLink().substring(lastSlashIndex + 1);<br>
} else {<br>
System.err.println(“Download link.”);<br>
return “”;<br>
}<br>
}</p>
<p>private void unZip() {<br>
try {<br>
BufferedInputStream e = new BufferedInputStream(new FileInputStream(this.fileToExtract));</p>
<pre><code>     ZipInputStream zin;
     ZipEntry e1;
     for(zin = new ZipInputStream(e); (e1 = zin.getNextEntry()) != null; System.out.println("unzipping2 " + e1.getName())) {
        if(e1.isDirectory()) {
           (new File(this.getCacheDir() + e1.getName())).mkdir();
        } else {
           if(e1.getName().equals(this.fileToExtract)) {
              this.unzip(zin, this.fileToExtract);
              break;
           }

           this.unzip(zin, this.getCacheDir() + e1.getName());
        }
     }

     zin.close();
  } catch (Exception var4) {
     var4.printStackTrace();
  }
</code></pre>
<p>}</p>
<p>private void unzip(ZipInputStream zin, String s) throws IOException {<br>
FileOutputStream out = new FileOutputStream(s);<br>
byte[] b = new byte[1024];<br>
boolean len = false;</p>
<pre><code>  int len1;
  while((len1 = zin.read(b)) != -1) {
     out.write(b, 0, len1);
  }

  out.close();
</code></pre>
<p>}<br>
}<br>
[/CODE]</p>
<p>And before someone says, yes I have added my cache link in cacheLink = “”; i just removed it so i could post it here. I use dropbox as my cache storage and if I enter the link into a browser i get the direct download (e.g. <a href="http://dl.dropbox.com/blahblahblah/cache.zip" data-bbcode="true" rel="nofollow noopener">http://dl.dropbox.com/blahblahblah/cache.zip</a>). So if anyone could help that would be very nice <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"><br>
Oh and all that i have in my console is</p>
<p><code>Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%
Downloading Cache 0%</code></p>
<p>Strangely, only 16kb of the cache’s download every time?</p>
<p>So I decided to change from a cacherdownloader to a gameupdater that checks what files you have and what files you need so you do not need to download the whole zipped cache files. This does the exact same thing too! 16kb!</p>
<p>[code]import java.io.BufferedOutputStream;<br>
import java.io.File;<br>
import java.io.FileInputStream;<br>
import java.io.FileOutputStream;<br>
import java.io.IOException;<br>
import java.io.InputStream;<br>
import java.io.OutputStream;<br>
import java.net.URL;<br>
import java.net.URLConnection;<br>
import java.security.MessageDigest;</p>
<p>import javax.xml.parsers.DocumentBuilder;<br>
import javax.xml.parsers.DocumentBuilderFactory;</p>
<p>import org.w3c.dom.Document;<br>
import org.w3c.dom.Element;</p>
<p>/**</p>
<ul>
<li>Game Updater, Update from CacheDownloader</li>
<li>
</li>
<li>
<span class="mention">@author</span> SoFlawLess_</li>
<li><span class="mention">@creditto</span></li>
<li>
<pre><code>      http://www.mkyong.com/java/how-to-generate-a-file-checksum-value-in-
</code></pre>
</li>
<li>
<pre><code>      java/ for md5 file checksum
</code></pre>
</li>
</ul>
<p>*/<br>
public class GameUpdater {</p>
<pre><code>// Uploaded folder containing the update.php file
private final static String SERVER = "http://127.0.0.1/game_update/";

// Cache location
// Make sure your findcachedir() method ends with a forward slash (/)
private final static String CACHE = SignLink.findcachedir();

private GameUpdater() {

}

/**
 * Checks for updates
 * 
 * @param c
 */
public static void checkForUpdates(Client c) {
	c.drawLoadingText(0, "Checking for updates");

	if (!SERVER.endsWith("/")) {
		System.err.println("Server must end with a forward slash (/)");
		return;
	} else if (!SERVER.startsWith("http://")) {
		System.err.println("Server must start with http://");
		return;
	}

	try {
		DocumentBuilderFactory documentbuilderfactory = DocumentBuilderFactory
				.newInstance();
		DocumentBuilder documentbuilder = documentbuilderfactory
				.newDocumentBuilder();
		Document document = documentbuilder.parse(new URL(SERVER
				.concat("update.php")).openStream());
		org.w3c.dom.NodeList nodelist = document
				.getElementsByTagName("Part");

		cleanCache(c, nodelist, new File(CACHE));
	} catch (Exception exception) {
		exception.printStackTrace();
	}
}

/**
 * Deletes files and folders that are not needed
 * 
 * @param c
 * @param list
 * @param file
 */
private static void cleanCache(Client c, org.w3c.dom.NodeList list,
		File file) {
	File[] directory = file.listFiles();

	FileLoop: for (File f : directory) {
		if (f.isDirectory()) {
			cleanCache(c, list, f);
		} else {
			for (int j = 0; j &lt; list.getLength(); j++) {
				org.w3c.dom.Node node = list.item(j);

				if (node.getNodeType() != 1) {
					continue;
				}

				Element e = (Element) node;

				String filePath = CACHE.concat(getElement(e, "Name"));
				File filePath_ = new File(filePath);
				String adress = SERVER.concat("cache/"
						+ getElement(e, "Name").replaceAll("\\s", "%20"));

				if (f.equals(filePath_)) {
					String currentChecksum = getMD5Checksum(f
							.getAbsolutePath());

					if (currentChecksum != null) {
						String checksum = getElement(e, "Hash");

						if (!checksum.equals(currentChecksum)) {
							downloadFile(c, adress, filePath_);
						}
					}
					continue FileLoop;
				} else if (!filePath_.exists()) {
					int index = filePath_.getAbsolutePath().lastIndexOf(
							File.separator);

					if (index != -1) {
						File checkFolder = new File(filePath_
								.getAbsolutePath().substring(0, index));

						if (!checkFolder.exists()) {
							checkFolder.mkdirs();
						}

					}

					downloadFile(c, adress, filePath_);
				}
			}

			f.delete();

			int index = f.getAbsolutePath().lastIndexOf(File.separator);

			if (index != -1) {
				File checkFolder = new File(f.getAbsolutePath().substring(
						0, index));

				if (checkFolder.listFiles().length == 0) {
					checkFolder.delete();
				}

			}
		}
	}
}

/**
 * Download a file :D Credits to whoever the hell added it or where it came
 * from in the first CacheDownloader
 * 
 * @param c
 * @param adress
 * @param filePath_
 */
private static void downloadFile(Client c, String adress, File filePath_) {
	OutputStream out = null;
	URLConnection conn;
	InputStream in = null;
	String fileName = null;
	int index = adress.lastIndexOf('/');

	if (index != -1) {
		fileName = adress.substring(index + 1, adress.length());
	}

	try {
		URL url = new URL(adress);
		out = new BufferedOutputStream(new FileOutputStream(filePath_));
		conn = url.openConnection();
		in = conn.getInputStream();
		byte[] data = new byte[1024];
		int numRead;
		long numWritten = 0;
		int length = conn.getContentLength();
		while ((numRead = in.read(data)) != -1) {
			out.write(data, 0, numRead);
			numWritten += numRead;
			int percentage = (int) (((double) numWritten / (double) length) * 100D);
			c.drawLoadingText(percentage,
					"Updating " + fileName.replaceAll("%20", " ") + " ... "
							+ percentage + "%");
		}
	} catch (Exception exception) {
		exception.printStackTrace();
	} finally {
		try {
			if (in != null) {
				in.close();
			}
			if (out != null) {
				out.close();
			}
		} catch (IOException ioe) {
		}
	}
}

/**
 * Faster way of getting an element value
 * 
 * @param e
 * @param key
 * @return
 */
private static String getElement(Element e, String key) {
	return ((Element) e.getElementsByTagName(key).item(0)).getChildNodes()
			.item(0).getNodeValue();
}

/**
 * 
 * @param filename
 * @return
 */
public static String getMD5Checksum(String fileName) {
	String result = null;
	try {

		MessageDigest md = MessageDigest.getInstance("MD5");
		FileInputStream fis = new FileInputStream(fileName);
		byte[] dataBytes = new byte[1024];

		int nread = 0;

		while ((nread = fis.read(dataBytes)) != -1) {
			md.update(dataBytes, 0, nread);
		}
		;

		byte[] mdbytes = md.digest();

		// convert the byte to hex format
		StringBuffer sb = new StringBuffer("");
		for (int i = 0; i &lt; mdbytes.length; i++) {
			sb.append(Integer.toString((mdbytes[i] &amp; 0xff) + 0x100, 16)
					.substring(1));
		}

		result = sb.toString();
	} catch (Exception e) {

	}
	return result;
}
</code></pre>
<p>}[/code]</p>
<p>Is there anything that could effect the way cache’s are downloaded? I’m confused.</p>
      </div>

      <meta itemprop='headline' content='Auto Cache Downloader Crashes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/auto-cache-downloader-crashes/480706 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:07:14 GMT -->
</html>
