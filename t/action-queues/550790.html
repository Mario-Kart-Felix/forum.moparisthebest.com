<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/action-queues/550790 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:07:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Action Queues - Runescape - moparisthebest.com</title>
    <meta name="description" content="Solution #1 

[code=lua] prayer.bury = function() 

-- Fetch the amount of experience gained from burying
local exp = get(&amp;#39;burying.exp&amp;#39;)

-- Start the animation and wait a few ticks 
msg(&amp;#39;You dig a hole in the ground&amp;#39;)
a&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="550790.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Action Queues&#39;" href="550790.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/action-queues/550790" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/action-queues/550790" />
<meta property="og:title" content="Action Queues" />
<meta name="twitter:title" content="Action Queues" />
<meta property="og:description" content="Solution #1  prayer.bury = function()  	-- Fetch the amount of experience gained from burying 	local exp = get(&#39;burying.exp&#39;)  	-- Start the animation and wait a few ticks  	msg(&#39;You dig a hole in the ground&#39;) 	animate(burying) 	delay(2)  	-- Remove the bone from the inventory and give the experience 	msg(&#39;You bury the bones.&#39;) 	inv_remove(inv, last_slot) 	addxp(skills.prayer, exp) end Solution #2  app.onitemoption(option.first, item.bones, function(plr, option, itemid, slot)  	-- On interaction..." />
<meta name="twitter:description" content="Solution #1  prayer.bury = function()  	-- Fetch the amount of experience gained from burying 	local exp = get(&#39;burying.exp&#39;)  	-- Start the animation and wait a few ticks  	msg(&#39;You dig a hole in the ground&#39;) 	animate(burying) 	delay(2)  	-- Remove the bone from the inventory and give the experience 	msg(&#39;You bury the bones.&#39;) 	inv_remove(inv, last_slot) 	addxp(skills.prayer, exp) end Solution #2  app.onitemoption(option.first, item.bones, function(plr, option, itemid, slot)  	-- On interaction..." />
<meta property="article:published_time" content="2015-03-28T09:10:58+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="550790.html">Action Queues</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-03-28T09:10:58Z'>
            <time itemprop='dateModified' datetime='2016-08-04T15:00:36Z' class='post-time'>
              August 4, 2016,  3:00pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Solution <span class="hashtag">#1</span></p>
<pre><code class="lang-auto">prayer.bury = function()

	-- Fetch the amount of experience gained from burying
	local exp = get('burying.exp')

	-- Start the animation and wait a few ticks 
	msg('You dig a hole in the ground')
	animate(burying)
	delay(2)

	-- Remove the bone from the inventory and give the experience
	msg('You bury the bones.')
	inv_remove(inv, last_slot)
	addxp(skills.prayer, exp)
end</code></pre>
<p>Solution <span class="hashtag">#2</span></p>
<pre><code class="lang-auto">app.onitemoption(option.first, item.bones, function(plr, option, itemid, slot)

	-- On interaction first we obviously message the player that we've started the action.
	plr:message('You dig a hole in the ground.')
	plr:delay(2)

	-- After we finish the action we notify that we buried the bones.
	plr:message('You bury the bones.')

	-- Give the reward and take the bones from the players inventory.
	plr:givexp(skill.prayer, --[[ Insert amount of experience for the bone ]])
	plr:take(slot)
end)

--[[
	Player Action Queue
	===================
	Message('You dig a hole in the ground')
	Delay(2)									// Wait two ticks, then execute remaining queue
	Message('You bury the bones')
	GiveXp(Skill.PRAYER, $1)
	TakeItem(slot)
]]</code></pre>
<p>I’ve always been fiddling with the content model. If you aren’t aware of my previous work I had created a solution similar to Runescript using lua by embedding helper functions and data into a local function environment that could be accessible and help assist in content development. An example of this shown above. I’ve come across a new idea that uses the idea of action queues to modify the state of entities.</p>
<p>How does it work? At the start of a world cycle any actions are handled, and then subsequently the action queue is executed until it reaches a delay which obviously delays the execution of the current queue. Some particulars are that if you’re executing a new type of action you simply clear the queue. Seems easy right? Well where else could we take this?</p>
<p>In the context of the world, you may have many actions running at the same time so.</p>
<pre><code class="lang-auto">app.onitemoption(option.first, item.bones, function(plr, option, itemid, slot)
	local fork = world.fork()

	-- After two ticks create a new tree at the players location
	fork:delay(2)
	fork:createloc(plr:pos, loc.tree)
end)

--[[
	World Context Queue
	===================
	Delay(2)
	CreateLoc($1, Locale.TREE)
]]</code></pre>
<p>I much prefer this solution to my sticky ones. (Lua -&gt; Runescript compiler, using coroutine library)</p>
<p>Trade off?</p>
<p>Prob memory consider you have to create a block-like structure for each action. But hey, I think thats a fair trade off.</p>
      </div>

      <meta itemprop='headline' content='Action Queues'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/silabsoft.html'><span itemprop='name'>silabsoft</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-03-28T18:11:02Z'>
            <time itemprop='dateModified' datetime='2016-08-04T15:00:37Z' class='post-time'>
              August 4, 2016,  3:00pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>not that I have 100% idea how you set this up but if you are clearing the queue of other actions when a new action takes over whats to stop me from doing</p>
<p>burybones<br>
plr:message(‘You dig a hole in the ground.’)<br>
plr:delay(2)</p>
<pre><code>    -- After we finish the action we notify that we buried the bones.
    plr:message('You bury the bones.')

    -- Give the reward and take the bones from the players inventory.
    plr:givexp(skill.prayer, --[[ Insert amount of experience for the bone ]])
</code></pre>
<p>dropbones</p>
<ul>
<li>new actions received clea4w list adding new action</li>
</ul>
<p>free prayer experience for everyone</p>
      </div>

      <meta itemprop='headline' content='Action Queues'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-03-28T23:41:43Z'>
            <time itemprop='dateModified' datetime='2016-08-04T15:00:40Z' class='post-time'>
              August 4, 2016,  3:00pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>[quote=“Miss Silabsoft, post:2, topic:550790”]not that I have 100% idea how you set this up but if you are clearing the queue of other actions when a new action takes over whats to stop me from doing</p>
<p>burybones<br>
plr:message(‘You dig a hole in the ground.’)<br>
plr:delay(2)</p>
<pre><code>    -- After we finish the action we notify that we buried the bones.
    plr:message('You bury the bones.')

    -- Give the reward and take the bones from the players inventory.
    plr:givexp(skill.prayer, --[[ Insert amount of experience for the bone ]])
</code></pre>
<p>dropbones</p>
<ul>
<li>new actions received clea4w list adding new action</li>
</ul>
<p>free prayer experience for everyone[/quote]</p>
<p>Drop bones would clear the bury bones action. I have to debate how to do futures because in theory the state of this is synchronized every tick, and item transactions can take multiple ticks. So it’s safe to say you can only theoretically run a single action at one time although the fork and execute function make it so that you can run multiple actions on the context of an entity at the same time. This is for status effects though say poison and such.</p>
<p>Builds into a prayer action:</p>
<pre><code class="lang-auto">-- Buries a bone from the players inventory at the specified slot.
prayer.bury = function(plr, item)

	-- Before we complete the action wait a set time and alert the player that the actions started
	plr:message('You dig a hole.')
	plr:delay(2)

	-- Give the player the reward experience and take the item from their inventory
	plr:message('You bury the bones.')
	plr:givexp(skill.prayer, item.meta(item:id(), 'burying.exp'))			-- TODO: Is it better to use a table for 'meta'?
	plr:take(item:slot())													-- TODO: Can we think of a better name than 'take'?
end</code></pre>
<p>This is an action queue or action, if obviously you click another bone it queues the action however if you try and drop a bone it’s destructive and it can either ignore the input or stop all current actions</p>
<pre><code class="lang-auto">import java.util.ArrayDeque;
import java.util.Queue;

/**
 * @author sini
 */
public class Action&lt;T extends Entity&gt; {

    /**
     * The queue of action blocks for this queue.
     */
    private final Queue&lt;ActionBlock&lt;T&gt;&gt; blocks = new ArrayDeque&lt;&gt;();

    /**
     * Constructs a new {@link Action};
     */
    public Action() {}

    /**
     * Appends an action block to the queue.
     *
     * @param block The action block.
     */
    public void append(ActionBlock&lt;T&gt; block) {
        blocks.add(block);
    }

    /**
     * Updates the action queue. The action queue will execute every action
     * up to a delay block. When a delay block is reached the queue will
     * block until the specified amount of time has been passed.
     *
     * @param entity The entity to execute the queue with.
     */
    public void tick(T entity) {
        ActionBlock&lt;T&gt; block;
        while((block = blocks.peek()) != null) {

            // Check if there is a condition we have to await for
            // before executing the block. The queue will not
            // continue until this block has finished blocking.
            if(block.await()) {
                break;
            }

            // Execute the block
            block.execute(entity);

            // Remove the block after it finishes executing
            blocks.poll();
        }
    }

    /**
     * Clears the queue.
     */
    public void clear() {
        blocks.clear();
    }
}</code></pre>
      </div>

      <meta itemprop='headline' content='Action Queues'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Clawz_fury.html'><span itemprop='name'>Clawz_fury</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-03-29T04:19:36Z'>
            <time itemprop='dateModified' datetime='2016-08-04T15:00:42Z' class='post-time'>
              August 4, 2016,  3:00pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Just a question about the co-routines: how are you planning on making it thread safe without using a ton of synchronization?</p>
      </div>

      <meta itemprop='headline' content='Action Queues'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-03-29T11:06:45Z'>
            <time itemprop='dateModified' datetime='2016-08-04T15:00:42Z' class='post-time'>
              August 4, 2016,  3:00pm
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="4" data-topic="550790">
<div class="title">
<div class="quote-controls"></div>
 lare69:</div>
<blockquote>
<p>Just a question about the co-routines: how are you planning on making it thread safe without using a ton of synchronization?</p>
</blockquote>
</aside>
<p>they arent coroutines</p>
      </div>

      <meta itemprop='headline' content='Action Queues'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/action-queues/550790 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:07:01 GMT -->
</html>
