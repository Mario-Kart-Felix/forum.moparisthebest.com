<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>ByteBuffer issue</title>
    <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992</link>
    <description>    I&#39;ve been working on my RuneScape NIO framework again these last few days and have arrived at the point of login decoding, but i&#39;m having a little trouble performing the decryption with NIO. Everything is fine until after I write the keys then I can&#39;t seem to read anymore data after this point. It just returns the value of 14 it initially read. I&#39;ve completed this step many times in the past using IO, Netty, and Apache but I cant seem to crack it using NIO. Any ideas? I&#39;ve been researching this for a good hour now but none of the recommended solutions have brought about any better results.

Output For Debugging:

[code]
Styx has bound to the address: [ServerSocket[addr=/0.0.0.0,localport=43594]].
Incoming connection accepted from: [Socket[addr=/127.0.0.1,port=53036,localport=43594]].
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Initial byte was successfully read. [14]
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Name Hash/Login Server was successfully read: [5].
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Login Type wasn&#39;t successfully read. [14]
[/code]

Code: 

[code]
@Override
    public void decode(Client client) {
	try {
	    client.setReader(new StreamBuffer(ByteBuffer.allocateDirect(126)));
	    client.getChannel().read(client.getReader().getBuffer());
	    client.getReader().flip();
	    if (client.getReader().getBuffer().hasRemaining()) {
		int initialByte = client.getReader().readSignedByte() &amp; 0xFF;
		if (initialByte != 14) {
			client.getChannel().close();
			System.out.println(&quot;[&quot; + client.getChannel() + &quot;] The Initial byte wasn&#39;t successfully read. [&quot; + initialByte + &quot;]&quot;);
			return;
	    	} else if (initialByte == 14){
			System.out.println(&quot;[&quot; + client.getChannel() + &quot;] The Initial byte was successfully read. [&quot; + initialByte + &quot;]&quot;);
	    	}
	    }
	    if (client.getReader().getBuffer().hasRemaining()) {
		int nameHash = client.getReader().readSignedByte() &amp; 0xFF;
		System.out.println(&quot;[&quot; + client.getChannel() + &quot;] The Name Hash/Login Server was successfully read: [&quot; + nameHash + &quot;].&quot;);
	    }
	    ByteBuffer keysExchange = ByteBuffer.allocateDirect(18);
	    keysExchange.putLong(1);
	    keysExchange.put((byte) 0);
	    keysExchange.putLong(new SecureRandom().nextLong());
	    client.flushStream(keysExchange);
	    client.getReader().getBuffer().compact();
	    int loginType = client.getReader().readSignedByte() &amp; 0xFF;
	    if (loginType == 16 || loginType == 18) {
		System.out.println(&quot;[&quot; + client.getChannel() + &quot;] The Login Type was successfully read: [&quot; + loginType + &quot;].&quot;);
	    } else {
		System.out.println(&quot;[&quot; + client.getChannel() + &quot;] The Login Type wasn&#39;t successfully read. [&quot; + loginType + &quot;]&quot;);
		client.getChannel().close();
		return;
	    }
	} catch (Exception exception) {
	    exception.printStackTrace();
	}
    }
[/code]</description>
    
    <lastBuildDate>Wed, 24 Jul 2013 20:50:29 +0000</lastBuildDate>
    <category>General Programming</category>
    <atom:link href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@mod_taharok Taharok]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mod_taharok">@mod_taharok</a> wrote:</p>
          <blockquote>
              <p>[quote=“iz3 legend, post:8, topic:525992”][quote author=Taharok link=topic=644736.msg4338050#msg4338050 date=1374698058]<br>
I’ll see if I can look over your code more closely later, but one thing I’m noticing is your usage of NIO. NIO wraps around the concept of non-blocking IO, which runs best in an asynchronous situation. I challenge you to question how you understand networking because your current usage of NIO is very similar to the standard, blocking Java IO library. In blocking IO, you need to perform everything synchronously (one after the other), since you have to wait for one thing to happen before you can move on. Despite that, asynchronous programming involves splitting procedures into a series of separate tasks, then executing them based on states changing.</p>
<p>For example, rather than having code that receives data, sends data, and reads data again, you should split that into two separate tasks. The first is the initial state, so you read in the data sent by the client and send a response. The second is based on the first task succeeding, which then reads in the response from the client and handles that appropriately. This is much better design and can lead to better thread time management.</p>
<p>In fact, this might actually be your problem as well. I noticed you are expecting to read data from the client as a response. Unless my memory is seriously mistaken, isn’t the login type sent after the server initializes the client’s ISAAC keys? You can’t just read data from the client after sending something to it. This is <span class="bbcode-b">not</span> blocking IO and it does not work like it.</p>
<p>Hope this helps.<br>
[/quote]</p>
<p>Thanks for the help, and this is my first time attempting to implement NIO into a RuneScape framework. I’m going to go back through the RuneScape Protocol and look into asynchronous programming. And by state changes do you mean breaking my login procedure down into multiple stages through an enumeration or switch case?[/quote]</p>
<p>You could do it that way, sure. There are many ways to implement a state machine, whichever you prefer is fine, as long as you understand what’s going on and the effectiveness of splitting it up.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/9</link>
        <pubDate>Wed, 24 Jul 2013 20:50:29 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-9</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@iz3_legend iz3 legend]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/iz3_legend">@iz3_legend</a> wrote:</p>
          <blockquote>
              <p>[quote=“Taharok, post:7, topic:525992”]I’ll see if I can look over your code more closely later, but one thing I’m noticing is your usage of NIO. NIO wraps around the concept of non-blocking IO, which runs best in an asynchronous situation. I challenge you to question how you understand networking because your current usage of NIO is very similar to the standard, blocking Java IO library. In blocking IO, you need to perform everything synchronously (one after the other), since you have to wait for one thing to happen before you can move on. Despite that, asynchronous programming involves splitting procedures into a series of separate tasks, then executing them based on states changing.</p>
<p>For example, rather than having code that receives data, sends data, and reads data again, you should split that into two separate tasks. The first is the initial state, so you read in the data sent by the client and send a response. The second is based on the first task succeeding, which then reads in the response from the client and handles that appropriately. This is much better design and can lead to better thread time management.</p>
<p>In fact, this might actually be your problem as well. I noticed you are expecting to read data from the client as a response. Unless my memory is seriously mistaken, isn’t the login type sent after the server initializes the client’s ISAAC keys? You can’t just read data from the client after sending something to it. This is <span class="bbcode-b">not</span> blocking IO and it does not work like it.</p>
<p>Hope this helps.[/quote]</p>
<p>Thanks for the help, and this is my first time attempting to implement NIO into a RuneScape framework. I’m going to go back through the RuneScape Protocol and look into asynchronous programming. And by state changes do you mean breaking my login procedure down into multiple stages through an enumeration or switch case?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/8</link>
        <pubDate>Wed, 24 Jul 2013 20:41:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-8</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@mod_taharok Taharok]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mod_taharok">@mod_taharok</a> wrote:</p>
          <blockquote>
              <p>I’ll see if I can look over your code more closely later, but one thing I’m noticing is your usage of NIO. NIO wraps around the concept of non-blocking IO, which runs best in an asynchronous situation. I challenge you to question how you understand networking because your current usage of NIO is very similar to the standard, blocking Java IO library. In blocking IO, you need to perform everything synchronously (one after the other), since you have to wait for one thing to happen before you can move on. Despite that, asynchronous programming involves splitting procedures into a series of separate tasks, then executing them based on states changing.</p>
<p>For example, rather than having code that receives data, sends data, and reads data again, you should split that into two separate tasks. The first is the initial state, so you read in the data sent by the client and send a response. The second is based on the first task succeeding, which then reads in the response from the client and handles that appropriately. This is much better design and can lead to better thread time management.</p>
<p>In fact, this might actually be your problem as well. I noticed you are expecting to read data from the client as a response. Unless my memory is seriously mistaken, isn’t the login type sent after the server initializes the client’s ISAAC keys? You can’t just read data from the client after sending something to it. This is <span class="bbcode-b">not</span> blocking IO and it does not work like it.</p>
<p>Hope this helps.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/7</link>
        <pubDate>Wed, 24 Jul 2013 20:34:18 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-7</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@xxxtilllyxxx xxxtilllyxxx]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xxxtilllyxxx">@xxxtilllyxxx</a> wrote:</p>
          <blockquote>
              <p>You’re supposed to flip the buffer everytime you change from reading to writing.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/6</link>
        <pubDate>Wed, 24 Jul 2013 20:26:01 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-6</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@iz3_legend iz3 legend]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/iz3_legend">@iz3_legend</a> wrote:</p>
          <blockquote>
              <aside class="quote quote-modified" data-post="4" data-topic="525992">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/davidi2/40/2579_1.png" class="avatar"> Davidi2:</div>
<blockquote>
<p>remove buffer.compact() and tell me if it still returns the same thing (cba to read the whole thing)[/quote][quote=“Davidi2, post:4, topic:525992”]remove buffer.compact() and tell me if it still returns the same thing (cba to read the whole thing)</p>
</blockquote>
</aside>
<p>Restored to original version. Removed compaction after writing the keys. Now there’s not enough data to read from this point on.</p>
<p>EDIT: Flipped the buffer after reading but now it simply returns the value of 14 again for the login type which should be 16 or 18. Im connecting off the MoparScape client if that could help in any way too.</p>
<pre><code class="lang-auto">   @Override
    public void decode(Client client) {
        try {
            client.setReader(new ChannelBuffer(ByteBuffer.allocateDirect(126)));
            client.getChannel().read(client.getReader().getBuffer());
            client.getReader().flip();
            if (client.getReader().getBuffer().hasRemaining()) {
                int initialByte = client.getReader().readSignedByte() &amp; 0xFF;
                if (initialByte != 14) {
                        client.getChannel().close();
                        System.out.println("[" + client.getChannel() + "] The Initial byte wasn't successfully read. [" + initialByte + "]");
                        return;
                    } else if (initialByte == 14){
                        System.out.println("[" + client.getChannel() + "] The Initial byte was successfully read. [" + initialByte + "]");
                    }
            }
            if (client.getReader().getBuffer().hasRemaining()) {
                int nameHash = client.getReader().readSignedByte() &amp; 0xFF;
                System.out.println("[" + client.getChannel() + "] The Name Hash/Login Server was successfully read: [" + nameHash + "].");
            }
            ByteBuffer keysExchange = ByteBuffer.allocateDirect(17);
            keysExchange.putLong(0);
            keysExchange.put((byte) 0);
            keysExchange.putLong(new SecureRandom().nextLong());
            client.getChannel().write(keysExchange);
            if (client.getReader().getBuffer().hasRemaining()) {
        	int loginType = client.getReader().readSignedByte() &amp; 0xFF;
        	if (loginType == 16 || loginType == 18) {
        	    System.out.println("[" + client.getChannel() + "] The Login Type was successfully read: [" + loginType + "].");
        	} else {
        	    System.out.println("[" + client.getChannel() + "] The Login Type wasn't successfully read. [" + loginType + "]");
        	    client.getChannel().close();
        	    return;
        	}
            }
        } catch (Exception exception) {
            exception.printStackTrace();
        }
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/5</link>
        <pubDate>Wed, 24 Jul 2013 19:08:47 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-5</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@davidi2 Davidi2]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/davidi2">@davidi2</a> wrote:</p>
          <blockquote>
              <p>remove buffer.compact() and tell me if it still returns the same thing (cba to read the whole thing)</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/4</link>
        <pubDate>Wed, 24 Jul 2013 19:00:01 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-4</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@iz3_legend iz3 legend]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/iz3_legend">@iz3_legend</a> wrote:</p>
          <blockquote>
              <p>[quote=“Yesteryear, post:2, topic:525992”]You don’t read from the channel after you’ve written the keyExchange buffer.</p>
<p>Also</p>
<pre><code class="lang-auto">client.flushStream(keysExchange);</code></pre>
<p>Bad naming. You’re not using streams.[/quote]</p>
<p>Addressed the issues, and my bad on the naming. Also now there’s not enough remaining data in the buffer to continue the operation. And sorry for the inconvenience im still a novice with the new input output system.</p>
<p>Modified my code a bit but i’m still having the same issue.</p>
<pre><code class="lang-auto">   @Override
    public void decode(Client client) {
	try {
	    ByteBuffer buffer = ByteBuffer.allocateDirect(126);
	    client.getChannel().read(buffer);
	    buffer.flip();
	    int initialByte = buffer.get() &amp; 0xFF;
	    if (initialByte != 14) {
		client.getChannel().close();
		System.out.println("[" + client.getChannel() + "] The Initial byte wasn't successfully read. [" + initialByte + "]");
		return;
	    } else if (initialByte == 14) {
		System.out.println("[" + client.getChannel() + "] The Initial byte was successfully read. [" + initialByte + "]");
	    }
	    int nameHash = buffer.get() &amp; 0xFF;
	    System.out.println("[" + client.getChannel() + "] The Name Hash/Login Server was successfully read: [" + nameHash + "].");
	    ByteBuffer keyExchange = ByteBuffer.allocate(17);
	    keyExchange.putLong(0);
	    keyExchange.put((byte) 0);
	    keyExchange.putLong(new SecureRandom().nextLong());
	    client.getChannel().write(keyExchange);
	    if (buffer.remaining() &lt; 2) {
		buffer.compact();
		return;
	    }
	    int loginType = buffer.get() &amp; 0xFF;
	    System.out.println("" + loginType);
	} catch (Exception exception) {
	    exception.printStackTrace();
	}
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/3</link>
        <pubDate>Wed, 24 Jul 2013 18:01:35 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-3</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@Yesteryear Yesteryear]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/yesteryear">@Yesteryear</a> wrote:</p>
          <blockquote>
              <p>You don’t read from the channel after you’ve written the keyExchange buffer.</p>
<p>Also</p>
<pre><code class="lang-auto">client.flushStream(keysExchange);</code></pre>
<p>Bad naming. You’re not using streams.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/2</link>
        <pubDate>Wed, 24 Jul 2013 17:54:25 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-2</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
      <item>
        <title>ByteBuffer issue</title>
        <dc:creator><![CDATA[@iz3_legend iz3 legend]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/iz3_legend">@iz3_legend</a> wrote:</p>
          <blockquote>
              <pre><code>I've been working on my RuneScape NIO framework again these last few days and have arrived at the point of login decoding, but i'm having a little trouble performing the decryption with NIO. Everything is fine until after I write the keys then I can't seem to read anymore data after this point. It just returns the value of 14 it initially read. I've completed this step many times in the past using IO, Netty, and Apache but I cant seem to crack it using NIO. Any ideas? I've been researching this for a good hour now but none of the recommended solutions have brought about any better results.
</code></pre>
<p>Output For Debugging:</p>
<pre><code class="lang-auto">Styx has bound to the address: [ServerSocket[addr=/0.0.0.0,localport=43594]].
Incoming connection accepted from: [Socket[addr=/127.0.0.1,port=53036,localport=43594]].
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Initial byte was successfully read. [14]
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Name Hash/Login Server was successfully read: [5].
[java.nio.channels.SocketChannel[connected local=/127.0.0.1:43594 remote=/127.0.0.1:53036]] The Login Type wasn't successfully read. [14]</code></pre>
<p>Code:</p>
<pre><code class="lang-auto">@Override
    public void decode(Client client) {
	try {
	    client.setReader(new StreamBuffer(ByteBuffer.allocateDirect(126)));
	    client.getChannel().read(client.getReader().getBuffer());
	    client.getReader().flip();
	    if (client.getReader().getBuffer().hasRemaining()) {
		int initialByte = client.getReader().readSignedByte() &amp; 0xFF;
		if (initialByte != 14) {
			client.getChannel().close();
			System.out.println("[" + client.getChannel() + "] The Initial byte wasn't successfully read. [" + initialByte + "]");
			return;
	    	} else if (initialByte == 14){
			System.out.println("[" + client.getChannel() + "] The Initial byte was successfully read. [" + initialByte + "]");
	    	}
	    }
	    if (client.getReader().getBuffer().hasRemaining()) {
		int nameHash = client.getReader().readSignedByte() &amp; 0xFF;
		System.out.println("[" + client.getChannel() + "] The Name Hash/Login Server was successfully read: [" + nameHash + "].");
	    }
	    ByteBuffer keysExchange = ByteBuffer.allocateDirect(18);
	    keysExchange.putLong(1);
	    keysExchange.put((byte) 0);
	    keysExchange.putLong(new SecureRandom().nextLong());
	    client.flushStream(keysExchange);
	    client.getReader().getBuffer().compact();
	    int loginType = client.getReader().readSignedByte() &amp; 0xFF;
	    if (loginType == 16 || loginType == 18) {
		System.out.println("[" + client.getChannel() + "] The Login Type was successfully read: [" + loginType + "].");
	    } else {
		System.out.println("[" + client.getChannel() + "] The Login Type wasn't successfully read. [" + loginType + "]");
		client.getChannel().close();
		return;
	    }
	} catch (Exception exception) {
	    exception.printStackTrace();
	}
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bytebuffer-issue/525992/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bytebuffer-issue/525992/1</link>
        <pubDate>Wed, 24 Jul 2013 17:48:40 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-525992-1</guid>
        <source url="https://forum.moparisthebest.com/t/bytebuffer-issue/525992.rss">ByteBuffer issue</source>
      </item>
  </channel>
</rss>
