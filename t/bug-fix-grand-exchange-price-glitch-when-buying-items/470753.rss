<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>[Bug fix] Grand Exchange price glitch when buying items</title>
    <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753</link>
    <description>I saw a help thread (originally posted [url=http://www.moparisthebest.com/smf/index.php/topic,588154.0.html]here[/url]) for a Grand Exchange item price glitch, in which increasing the amount of an expensive item (seen [url=http://www.moparisthebest.com/smf/index.php/topic,588216.msg4171726.html]here[/url] with godsword hilts) to a ridiculuously high number (in a multiple of two) would give you the items, at a fraction of the cost.

Look in either the ExchangeHandler, or GrandExchange file (whichever deals with the buying/selling stuff), and in there you&#39;ll see
[code=Java]
	public void acceptOffer(Player player, Type type) {
		int amount = (int) player.geAmount;
		int id = (int) player.geItem;
		int price = (int) player.price;
[/code]

All you need to do, is right under price, add
[code=Java]
long cost = (long) amount * price;
if (cost &gt; Integer.MAX_VALUE) {
    return;
}
[/code]

And that will stop the duping glitch for the moment.

There is one (potential) problem though. Given the right amount that is being bought, the same error could occur. The cost value (which is know 64-bits long instead of 32-bits) could eventually overflow, and become negative. For an item costing 150m, that number would be 61,489,146,912. As you can see, it is about 30x larger than the maximum value for an integer. It shouldn&#39;t be possible to get up to such a large number, without client [b]AND[/b] server protocol modification. I believe client-side it&#39;s probably in a jagex script somewhere so that it won&#39;t go higher than 2b anyway.

The strange part was that there is a duplicate set of code farther down in the function, but it was completely disregarded.

The code is (for those of you who care, and are still reading by this point)
[code=Java]
long totalPrice = price * amount;
if (totalPrice &gt;= Integer.MAX_VALUE || totalPrice &lt; 0) {
    player.sm(&quot;The price is too high!&quot;);
    return;
}
[/code]

It&#39;s a subtle problem, and it looks very close to my block of code, with one significant difference.
[code=Java]
long cost = (long) amount * price;
[/code]

versus
[code=Java]
long totalPrice = amount * price;
[/code]

My code casts the arithmetic to a long, which allows it&#39;s &quot;true&quot; value as the result, whereas the existing code is still performing the math on integers, which allows it to wrap-around to a negative number. So, in reality, you could either add the code that I provided, or simply add
[code=Java]
(long)
[/code]

To the existing code that calculates the total cost.


[b]NOTE:[/b] I have not tested this on every server framework with a Grand Exchange enabled. I have only tested it on Zenith (which is the only one I had available), but the process should be the same on NRS3Server or the other high-revision servers.

[b]SIDE NOTE:[/b] The problem could have probably been more easily identified, had the server only had 1 set of classes that dealt with the Grand Exchange, rather than 3.</description>
    
    <lastBuildDate>Fri, 14 Dec 2012 21:46:51 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@Newreality Newreality]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/newreality">@Newreality</a> wrote:</p>
          <blockquote>
              <p>this only works for Zenith can you post a fix for NRS3 V4 one please</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/9</link>
        <pubDate>Fri, 14 Dec 2012 21:46:51 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-9</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@Uncalled Uncalled]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/uncalled">@Uncalled</a> wrote:</p>
          <blockquote>
              <p>HURRRE DUERP COMMON SENSE</p>
<p>Other than that - nice tutorial. Very well explained for those that need it. Good job!</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/8</link>
        <pubDate>Wed, 05 Dec 2012 08:42:35 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-8</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@zyle1992 Zymus]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/zyle1992">@zyle1992</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="6" data-topic="470753">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/bazi/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> Bazi:</div>
<blockquote>
<p>Do you have a skype or a t.v? ill pm u mine.</p>
</blockquote>
</aside>
<p>I have neither installed. And I don’t really help that way.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/7</link>
        <pubDate>Wed, 05 Dec 2012 05:18:36 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-7</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@Bazi Bazi]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/bazi">@Bazi</a> wrote:</p>
          <blockquote>
              <p>Do you have a skype or a t.v? ill pm u mine.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/6</link>
        <pubDate>Wed, 05 Dec 2012 02:40:04 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-6</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@zyle1992 Zymus]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/zyle1992">@zyle1992</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="4" data-topic="470753">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/bazi/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> Bazi:</div>
<blockquote>
<p>I Cant find that code anywhere <img src="https://forum.moparisthebest.com/images/emoji/twitter/frowning.png?v=5" title=":frowning:" class="emoji" alt=":frowning:"> I looked like everywhere too!</p>
</blockquote>
</aside>
<p>Post your class that deals with Grand Exchange events (the actual class, there could be multiple, so I don’t know which one it is)</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/5</link>
        <pubDate>Wed, 05 Dec 2012 02:29:08 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-5</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@Bazi Bazi]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/bazi">@Bazi</a> wrote:</p>
          <blockquote>
              <p>I Cant find that code anywhere <img src="https://forum.moparisthebest.com/images/emoji/twitter/frowning.png?v=5" title=":frowning:" class="emoji" alt=":frowning:"> I looked like everywhere too!</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/4</link>
        <pubDate>Wed, 05 Dec 2012 02:00:14 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-4</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@mr_pker01 mr pker01]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mr_pker01">@mr_pker01</a> wrote:</p>
          <blockquote>
              <p>Very nice find! <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/3</link>
        <pubDate>Mon, 03 Dec 2012 08:45:20 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-3</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@SCFTW SCFTW]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/scftw">@SCFTW</a> wrote:</p>
          <blockquote>
              <p>Kool stuff.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/2</link>
        <pubDate>Sun, 02 Dec 2012 13:23:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-2</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
      <item>
        <title>[Bug fix] Grand Exchange price glitch when buying items</title>
        <dc:creator><![CDATA[@zyle1992 Zymus]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/zyle1992">@zyle1992</a> wrote:</p>
          <blockquote>
              <p>I saw a help thread (originally posted <a href="http://www.moparisthebest.com/smf/index.php/topic,588154.0.html" data-bbcode="true">here</a>) for a Grand Exchange item price glitch, in which increasing the amount of an expensive item (seen <a href="http://www.moparisthebest.com/smf/index.php/topic,588216.msg4171726.html" data-bbcode="true">here</a> with godsword hilts) to a ridiculuously high number (in a multiple of two) would give you the items, at a fraction of the cost.</p>
<p>Look in either the ExchangeHandler, or GrandExchange file (whichever deals with the buying/selling stuff), and in there you’ll see</p>
<pre><code class="lang-auto">	public void acceptOffer(Player player, Type type) {
		int amount = (int) player.geAmount;
		int id = (int) player.geItem;
		int price = (int) player.price;</code></pre>
<p>All you need to do, is right under price, add</p>
<pre><code class="lang-auto">long cost = (long) amount * price;
if (cost &gt; Integer.MAX_VALUE) {
    return;
}</code></pre>
<p>And that will stop the duping glitch for the moment.</p>
<p>There is one (potential) problem though. Given the right amount that is being bought, the same error could occur. The cost value (which is know 64-bits long instead of 32-bits) could eventually overflow, and become negative. For an item costing 150m, that number would be 61,489,146,912. As you can see, it is about 30x larger than the maximum value for an integer. It shouldn’t be possible to get up to such a large number, without client <span class="bbcode-b">AND</span> server protocol modification. I believe client-side it’s probably in a jagex script somewhere so that it won’t go higher than 2b anyway.</p>
<p>The strange part was that there is a duplicate set of code farther down in the function, but it was completely disregarded.</p>
<p>The code is (for those of you who care, and are still reading by this point)</p>
<pre><code class="lang-auto">long totalPrice = price * amount;
if (totalPrice &gt;= Integer.MAX_VALUE || totalPrice &lt; 0) {
    player.sm("The price is too high!");
    return;
}</code></pre>
<p>It’s a subtle problem, and it looks very close to my block of code, with one significant difference.</p>
<pre><code class="lang-auto">long cost = (long) amount * price;</code></pre>
<p>versus</p>
<pre><code class="lang-auto">long totalPrice = amount * price;</code></pre>
<p>My code casts the arithmetic to a long, which allows it’s “true” value as the result, whereas the existing code is still performing the math on integers, which allows it to wrap-around to a negative number. So, in reality, you could either add the code that I provided, or simply add</p>
<pre><code class="lang-auto">(long)</code></pre>
<p>To the existing code that calculates the total cost.</p>
<p><span class="bbcode-b">NOTE:</span> I have not tested this on every server framework with a Grand Exchange enabled. I have only tested it on Zenith (which is the only one I had available), but the process should be the same on NRS3Server or the other high-revision servers.</p>
<p><span class="bbcode-b">SIDE NOTE:</span> The problem could have probably been more easily identified, had the server only had 1 set of classes that dealt with the Grand Exchange, rather than 3.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753/1</link>
        <pubDate>Sun, 02 Dec 2012 09:56:05 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-470753-1</guid>
        <source url="https://forum.moparisthebest.com/t/bug-fix-grand-exchange-price-glitch-when-buying-items/470753.rss">[Bug fix] Grand Exchange price glitch when buying items</source>
      </item>
  </channel>
</rss>
