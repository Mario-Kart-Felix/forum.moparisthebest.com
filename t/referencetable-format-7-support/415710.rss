<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>ReferenceTable format 7 support</title>
    <link>https://forum.moparisthebest.com/t/referencetable-format-7-support/415710</link>
    <description>Converted retty&#39;s reference table to support new format (version 7) took like 5 minutes. decided to post here.

[code]	public ReferenceTable(int id, CacheIndex index) throws IOException {
		CacheFile file = index.getFile(id);
		if (file != null) {
			ByteBuffer buffer = ByteBuffer.wrap(index.getFile(id).decompress());
			int format = buffer.get() &amp; 0xFF;
			int revision = format &lt; 6 ? 0 : buffer.getInt();
			this.revision = revision;
			int flags = buffer.get() &amp; 0xFF;
			boolean hasKRHash = (0x1 &amp; flags) != 0;
			boolean hasDigests = (0x2 &amp; flags) != 0;
			size = format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			references = new Reference[size];
			int offset = 0;
			for (int i = 0; i &lt; size; i++) {
				references[i] = new Reference();
				references[i].entry = offset += format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			}
			if (hasKRHash) {
				for (int i = 0; i &lt; size; i++) {
					references[i].hashName = buffer.getInt();
				}
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].crc = buffer.getInt();
			}
			/**
			 * Only different from 604 and below is this part. and the two
			 * booleans
			 */
			if (hasDigests) {
				for (int i = 0; i &lt; size; i++) {
					byte[] data = new byte[64];
					buffer.get(data);
					references[i].digests = data;
				}
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].revision = buffer.getInt();
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].childrenSize = format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			}
			for (int i = 0; i &lt; size; i++) {
				offset = 0;
				references[i].children = new int[references[i].getChildrenSize()];
				for (int child = 0; child &lt; references[i].getChildrenSize(); child++) {
					references[i].children[child] = offset += format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
				}
			}
			if (hasKRHash) {
				for (int i = 0; i &lt; size; i++) {
					references[i].childHashNames = new int[references[i].getChildrenSize()];
					for (int child = 0; child &lt; references[i].getChildrenSize(); child++) {
						references[i].childHashNames[child] = buffer.getInt();
					}
				}
			}
		}
	}[/code]

[code]	final int getSmartInteger(ByteBuffer buffer) {
		if (buffer.get(buffer.position()) &lt; 0) {
			return buffer.getInt() &amp; 0x7fffffff;
		}
		return buffer.getShort() &amp; 0xFFFF;
	}[/code]

[img]http://i.imgur.com/GRbl6.jpg[/img]</description>
    
    <lastBuildDate>Sun, 25 Sep 2011 19:10:10 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/referencetable-format-7-support/415710.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>ReferenceTable format 7 support</title>
        <dc:creator><![CDATA[@I_Roll_Deep I Roll Deep]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/i_roll_deep">@I_Roll_Deep</a> wrote:</p>
          <blockquote>
              <p><img src="http://www.moparisthebest.com/smf/Themes/core/images/post/thumbup.gif" alt width="" height=""></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/referencetable-format-7-support/415710/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/referencetable-format-7-support/415710/2</link>
        <pubDate>Sun, 25 Sep 2011 19:10:10 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-415710-2</guid>
        <source url="https://forum.moparisthebest.com/t/referencetable-format-7-support/415710.rss">ReferenceTable format 7 support</source>
      </item>
      <item>
        <title>ReferenceTable format 7 support</title>
        <dc:creator><![CDATA[@_Discardedx21 `Discardedx2`]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/_discardedx21">@_Discardedx21</a> wrote:</p>
          <blockquote>
              <p>Converted retty’s reference table to support new format (version 7) took like 5 minutes. decided to post here.</p>
<p><code>	public ReferenceTable(int id, CacheIndex index) throws IOException {
		CacheFile file = index.getFile(id);
		if (file != null) {
			ByteBuffer buffer = ByteBuffer.wrap(index.getFile(id).decompress());
			int format = buffer.get() &amp; 0xFF;
			int revision = format &lt; 6 ? 0 : buffer.getInt();
			this.revision = revision;
			int flags = buffer.get() &amp; 0xFF;
			boolean hasKRHash = (0x1 &amp; flags) != 0;
			boolean hasDigests = (0x2 &amp; flags) != 0;
			size = format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			references = new Reference[size];
			int offset = 0;
			for (int i = 0; i &lt; size; i++) {
				references[i] = new Reference();
				references[i].entry = offset += format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			}
			if (hasKRHash) {
				for (int i = 0; i &lt; size; i++) {
					references[i].hashName = buffer.getInt();
				}
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].crc = buffer.getInt();
			}
			/**
			 * Only different from 604 and below is this part. and the two
			 * booleans
			 */
			if (hasDigests) {
				for (int i = 0; i &lt; size; i++) {
					byte[] data = new byte[64];
					buffer.get(data);
					references[i].digests = data;
				}
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].revision = buffer.getInt();
			}
			for (int i = 0; i &lt; size; i++) {
				references[i].childrenSize = format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
			}
			for (int i = 0; i &lt; size; i++) {
				offset = 0;
				references[i].children = new int[references[i].getChildrenSize()];
				for (int child = 0; child &lt; references[i].getChildrenSize(); child++) {
					references[i].children[child] = offset += format &gt;= 7 ? getSmartInteger(buffer) : buffer.getShort() &amp; 0xFFFF;
				}
			}
			if (hasKRHash) {
				for (int i = 0; i &lt; size; i++) {
					references[i].childHashNames = new int[references[i].getChildrenSize()];
					for (int child = 0; child &lt; references[i].getChildrenSize(); child++) {
						references[i].childHashNames[child] = buffer.getInt();
					}
				}
			}
		}
	}</code></p>
<p><code>	final int getSmartInteger(ByteBuffer buffer) {
		if (buffer.get(buffer.position()) &lt; 0) {
			return buffer.getInt() &amp; 0x7fffffff;
		}
		return buffer.getShort() &amp; 0xFFFF;
	}</code></p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="http://i.imgur.com/GRbl6.jpg" title="GRbl6.jpg" rel="nofollow noopener"><img src="http://i.imgur.com/GRbl6.jpg" alt width="651" height="499"><div class="meta">
<svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename">GRbl6.jpg</span><span class="informations">1035×794</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg>
</div></a></div></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/referencetable-format-7-support/415710/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/referencetable-format-7-support/415710/1</link>
        <pubDate>Fri, 23 Sep 2011 20:45:38 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-415710-1</guid>
        <source url="https://forum.moparisthebest.com/t/referencetable-format-7-support/415710.rss">ReferenceTable format 7 support</source>
      </item>
  </channel>
</rss>
