<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/runeforge-cache-writer-reader/404726 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Aug 2019 23:51:53 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>RuneForge - Cache Writer/Reader - Runescape - moparisthebest.com</title>
    <meta name="description" content="*">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="404726.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;RuneForge - Cache Writer/Reader&#39;" href="404726.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/runeforge-cache-writer-reader/404726" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/runeforge-cache-writer-reader/404726" />
<meta property="og:title" content="RuneForge - Cache Writer/Reader" />
<meta name="twitter:title" content="RuneForge - Cache Writer/Reader" />
<meta property="article:published_time" content="2011-07-17T17:01:10+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="404726.html">RuneForge - Cache Writer/Reader</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-07-17T17:01:10Z'>
            <time itemprop='dateModified' datetime='2016-08-01T13:15:47Z' class='post-time'>
              August 1, 2016,  1:15pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <ul>
<li>
</li>
</ul>
      </div>

      <meta itemprop='headline' content='RuneForge - Cache Writer/Reader'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/kingdomkey01.html'><span itemprop='name'>kingdomkey01</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-07-17T17:31:28Z'>
            <time itemprop='dateModified' datetime='2016-08-01T13:15:50Z' class='post-time'>
              August 1, 2016,  1:15pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>[quote=“sinisoul, post:1, topic:404726”][CENTER]<br>
My planned updates include having a full GUI interface in which users can add custom files and inject them into their client not to load higher content, but rather to load their <span class="bbcode-b">OWN</span> content. The project is not to suffice people who are to lazy to try and create a modern server, it is a tool to help make your OWN game.<br>
[/CENTER][/quote]</p>
<p>Very interesting, I hope to see this tool/addon/tutorial come through successfully.</p>
      </div>

      <meta itemprop='headline' content='RuneForge - Cache Writer/Reader'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-07-17T17:34:22Z'>
            <time itemprop='dateModified' datetime='2016-08-01T13:15:50Z' class='post-time'>
              August 1, 2016,  1:15pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>[quote=“kingdomkey01, post:2, topic:404726”][quote author=sinisoul link=topic=501740.msg3670878#msg3670878 date=1310922070]<br>
[CENTER]<br>
My planned updates include having a full GUI interface in which users can add custom files and inject them into their client not to load higher content, but rather to load their <span class="bbcode-b">OWN</span> content. The project is not to suffice people who are to lazy to try and create a modern server, it is a tool to help make your OWN game.<br>
[/CENTER]<br>
[/quote]</p>
<p>Very interesting, I hope to see this tool/addon/tutorial come through successfully.[/quote]</p>
<p>I have already released many tutorials on some cache definitions, and the actually writing/reading piece of the cache and the structure of the cache. Sorry going to use this post for more paste space. The final result will be a tool that is very gooey so that everyone can use it and understand it.</p>
<hr>
<p>Container Archive</p>
<pre><code class="lang-auto">package org.forge.cache.archives;

import java.nio.ByteBuffer;
import java.util.Map;
import java.util.HashMap;
import java.util.Set;

import org.forge.cache.Archive;
import org.forge.cache.util.CompressionUtils;
import org.forge.io.Stream;

/**
 * RuneForge | 317
 * Container.java
 * @version 1.0.0
 * @author SiniSoul (SiniSoul@live.com)
 */
public class ContainerArchive extends Archive {
    
    /**
     * If the archive is completed compressed then the file entries
     * will not need to be decompressed on retrieval. But if the archive
     * is not compressed then the entries will be decompressed with a
     * BZip2 algorithm.
     */
    private boolean compressed = false;
    
    /**
     * The entries map, the key to fetch an entry is the name hash.
     */
    private Map&lt;Integer, Entry&gt; entries;
    
    @Override
    public void initialize(byte[] data) {
        entries = new HashMap&lt;Integer, Entry&gt;();
        if(data == null) return;
        ByteBuffer buffer = ByteBuffer.wrap(data);
        int uncompressed_size = getTri(buffer);
        int compressed_size   = getTri(buffer);        
        /* Archive is compressed */
        if(compressed_size != uncompressed_size) {
           try {
               buffer = ByteBuffer.wrap(CompressionUtils.uBZip2(6, buffer.array().length, buffer.array()));
           } catch(Exception ex) {
               throw new RuntimeException("Error uBzip: "+ex);
           }
           compressed = true;
        } 
        /* Entries are compressed */
        else {
            /* Nothing */
        }
        int amount = buffer.getShort() &amp; 0xFFFF;
        /* Each entry information block is 10 bytes */
        int offset   = buffer.position() + (amount * 10);
        Entry entry = null;
        for(int i = 0; i &lt; amount; i++) {
            entry = new Entry(this);
            entry.name_hash = buffer.getInt();
            entry.uncompressed_size = getTri(buffer);
            entry.compressed_size = getTri(buffer);
            entry.compressed = !compressed;
            byte[] bytes = new byte[entry.compressed_size];
            System.arraycopy(buffer.array(), offset, bytes, 0, bytes.length);
            entry.stream = new Stream(bytes);
            offset += entry.compressed_size;           
            /* Store the entry */
            entries.put(entry.name_hash, entry);
        }
    }

    @Override
    public Stream getCompressedStream() {
        Stream mainblock  = new Stream(),
               entryblock = new Stream();
        short amount = (short) (entries.size() &amp; 0xFFFF);
        /* Put the amount of entries */
        entryblock.put((short) amount);
        Set&lt;Integer&gt; keys = entries.keySet();
        for(int hash : keys) {
            Entry entry = entries.get(hash);
            if(entry == null || (entry.compressed_size == -1 || entry.uncompressed_size == -1)) continue;
            /* This should not happen but would be nice to know if it did */
            if(entry.name_hash != hash)
                throw new RuntimeException("Compression Error - "
                                           + "Entry Hash does not match given hash.");
            entryblock.put((int) entry.name_hash);
            /* Put the compressed and uncompressed sizes */
            putTri(entry.uncompressed_size, entryblock);
            putTri(entry.compressed_size, entryblock);
        }
        for(int hash : keys) {
            Entry entry = entries.get(hash);
            if(entry == null || (entry.compressed_size == -1 || entry.uncompressed_size == -1)) continue;
            entryblock.put(entry.stream.getByteBuffer().array());
        }
        putTri(entryblock.getByteBuffer().array().length, mainblock);
        /* Compress the bytes */
        if(compressed) {
            try {
                entryblock = new Stream(CompressionUtils.uBZip2(0, entryblock.getByteBuffer().position(), entryblock.getByteBuffer().array()));
            } catch (Exception ex) {
                throw new RuntimeException("Compression failed: "+ex);
            }
        }
        putTri(entryblock.getByteBuffer().array().length, mainblock);
        mainblock.put(entryblock.getByteBuffer().array());
        return mainblock;
    }

    @Override
    public Stream getUncompressedStream() {
        return null;
    }
    
    /**
     * Sets if the archive is entirely compressed.
     * @param compressed If the archive is entirely compressed.
     */
    public void setCompressed(boolean compressed) {
        this.compressed = compressed;
    }
    
    /**
     * A value representing if the entire archive is compressed versus each
     * archive being compressed.
     * @return If the entire archive is compressed versus each archive.
     */
    public boolean isCompressed() {
        return compressed;
    }
    
    /**
     * Gets the entry hash from a string.
     * @param s The name of the entry.
     * @return The hash value of the name.
     */
    public static int getEntryHash(String s) {
        int hash = 0;
        s = s.toUpperCase();
        for(int j = 0; j &lt; s.length(); j++)
            hash = (hash * 61 + s.charAt(j)) - 32;
        return hash;
    }
    
    /**
     * Put a tri byte integer into a stream.
     * @param value The tri byte value.
     * @param stream The stream to put the tri byte into.
     */
    private void putTri(int value, Stream stream) {
        value &amp;= 0xFFFFFF;
        stream.put((byte) (value &gt;&gt; 16));
        stream.put((byte) (value &gt;&gt;  8));
        stream.put((byte) (value));
    }
    
    /**
     * Gets a tri byte integer from a byte buffer.
     * @param buffer The buffer to parse the tri byte from.
     * @return A 24 big endian bit integer.
     */
    private int getTri(ByteBuffer buffer) {
        return (0xFF0000 &amp; (buffer.get() &lt;&lt; 16)) | 
               (0x00FF00 &amp; (buffer.get() &lt;&lt;  8)) |
               (0x0000FF &amp; buffer.get());
    }
    
    /**
     * Creates a new entry, but does not store that entry.
     * @param name The name of the entry.
     * @param data The data of the entry.
     * @return The newly created entry.
     */
    public Entry createEntry(String name, byte[] data) {
        Entry entry = new Entry(this);
        entry.setHash(name);
        entry.setStream(data);
        return entry;
    }
    
    /**
     * Store an entry in the entries map, if there is an entry
     * with the same name hash a RuntimeException is thrown.
     * @param entry The entry to store.
     */
    public void store(Entry entry) {
        if(entries.containsKey(entry.name_hash))
            throw new RuntimeException("Collision detected!");
        entries.put(entry.name_hash, entry);
    }
    
    /**
     * 
     * @param data The archives data.
     */
    public ContainerArchive(byte[] data) {
        super(data);
    }
    
    /**
     * A container entry.
     */
    public static class Entry {
        
        /**
         * If the entry is compressed or not.
         */
        boolean compressed = false;
        
        /**
         * The entries:
         * 
         * Uncompressed size:
         *  If the archive is compressed this value
         *  will equal the compressed size.
         */
        int uncompressed_size = -1,
            compressed_size   = -1,
            name_hash         = -1;  
        
        /** 
         * The entries stream.
         */
        Stream stream;
        
        /**
         * The archive this entry belongs to.
         */
        ContainerArchive archive;
        
        /**
         * Sets the entries stream. If the entry is compressed automatically 
         * compresses the data and then uses the compressed bytes as the
         * byte array.
         * 
         * @param data The data for the archive.
         */
        public void setStream(byte[] data) {
            /* Set the uncompressed size */
            uncompressed_size = data.length;
            if(compressed)
                try {
                    data = CompressionUtils.BZip2(data);
                } catch(Exception ex) {
                    throw new RuntimeException("Failed to compress data: "+ex);
                }
            stream = new Stream(data);
            /* Set the compressed size */
            compressed_size = data.length;
        }
        
        /**
         * 
         * @return 
         */
        public Stream getStream() {
            byte[] data = new byte[uncompressed_size];
            if(compressed)
                try {
                data = CompressionUtils.uBZip2(0, stream.getByteBuffer().array().length,
                                                      stream.getByteBuffer().array());
                } catch(Exception ex) {
                    throw new RuntimeException("Error while unzipping: "+ex);
                }
            else 
                System.arraycopy(stream.getByteBuffer().array(), 0, data, 0, uncompressed_size);
            return new Stream(data);
        }      
        
        /**
         * Sets the name hash of the entry, if the 
         * @param name 
         */
        public void setHash(String name) {
            if(name_hash != -1)
                archive.entries.remove(name_hash);
            name_hash = getEntryHash(name);
            archive.entries.put(name_hash, this);
        }
        
        /**
         * 
         * @param owner 
         */
        Entry(ContainerArchive archive) { 
            this.archive = archive;
        }
    }
}</code></pre>
      </div>

      <meta itemprop='headline' content='RuneForge - Cache Writer/Reader'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/runeforge-cache-writer-reader/404726 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Aug 2019 23:51:53 GMT -->
</html>
