<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Improving the Performance of Hyperion</title>
    <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459</link>
    <description>[size=14pt][b]Introduction[/b][/size]
Although Hyperion is already a relatively high-performance server, there are some things that could still be improved. This tutorial will focus on entity updating, which is probably the biggest breeding-ground for bottlenecks, for any RuneScape server. Hyperion, unfortunately, does not handle entity updating as well as it could, considering the approach it takes (e.g. to iterate through a region and its surrounding regions to retrieve near-by players/npcs).

[b]These improvements have proven to speed up Hyperion by up to 500%![/b]


[size=14pt][b]Improvement #1[/b][/size]
Hyperion stores all Players and NPCs in an [u]org.hyperion.rs2.util.EntityList[/u]. [b]The problem is with its contains() method.[/b]
[code=JAVA]
@Override
public boolean contains(Object arg0) {
	for(int i = 1; i &lt; entities.length; i++) {
		if(entities[i] == arg0) {
			return true;
		}
	}
	return false;
}
[/code]
It iterates through [i]all[/i] the entities until it finds the one it is looking for. Quite unnecessary.

[b]To fix this, replace the contains() method with this:[/b]
[code=JAVA]
@Override
public boolean contains(Object arg0) {
	Entity entity = (Entity) arg0;
	return entities[entity.getIndex()] == entity;
}
[/code]

That&#39;s all there is to it. You&#39;re done!


[size=14pt][b]Improvement #2[/b][/size]
Hyperion stores all local Players/NPCs in a [u]java.util.LinkedList[/u]. Again, [b]the problem is with its contains() method.[/b]

[b]The solution is to use a [u]java.util.LinkedHashSet[/u] instead.[/b] Its lookup time is O(1), as with the new contains() method from earlier.

In other words, [b]find these declarations:[/b]
[code=JAVA]
/**
 * The list of local players.
 */
private final List&lt;Player&gt; localPlayers = new LinkedList&lt;Player&gt;();

/**
 * The list of local npcs.
 */
private final List&lt;NPC&gt; localNpcs = new LinkedList&lt;NPC&gt;();
[/code]
[b]Replace them with the following:[/b]
[code=JAVA]
/**
 * The list of local players.
 */
private final Set&lt;Player&gt; localPlayers = new LinkedHashSet&lt;Player&gt;();

/**
 * The list of local npcs.
 */
private final Set&lt;NPC&gt; localNpcs = new LinkedHashSet&lt;NPC&gt;();
[/code]

[b]Replace the appropriate getter methods:[/b]
[code=JAVA]/**
 * Gets the list of local players.
 * @return The list of local players.
 */
public List&lt;Player&gt; getLocalPlayers() {
	return localPlayers;
}

/**
 * Gets the list of local npcs.
 * @return The list of local npcs.
 */
public List&lt;NPC&gt; getLocalNPCs() {
	return localNpcs;
}
[/code]
So that a [u]java.util.Set[/u] is returned instead:
[code=JAVA]
/**
 * Gets the set of local players.
 * @return The set of local players.
 */
public Set&lt;Player&gt; getLocalPlayers() {
	return localPlayers;
}

/**
 * Gets the set of local npcs.
 * @return The set of local npcs.
 */
public Set&lt;NPC&gt; getLocalNPCs() {
	return localNpcs;
}
[/code]

After that, you are done!


That&#39;s it. If you have any questions, feel free to ask.

[i]Note: Make sure you import the appropriate classes![/i]</description>
    
    <lastBuildDate>Fri, 11 Oct 2013 02:01:39 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@ExtremeX-Scape Ryley]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/extremex-scape">@ExtremeX-Scape</a> wrote:</p>
          <blockquote>
              <p>[quote=“sspoke, post:22, topic:378459”]Wouldn’t</p>
<pre><code class="lang-auto"> return entities[entity.getIndex()] == entity;</code></pre>
<p>Crash if entity.getIndex() returns a number bigger then entities array or -1 number</p>
<pre><code class="lang-auto">return entities[-1] == entity </code></pre>
<p>will crash :P[/quote]</p>
<p>Will not happen, take a look at the EnityList implementation;</p>
<p><code>
		if (index == -1) {
			return false;
		}
		entities[index] = entity;
		entity.setIndex(index + 1);</code></p>
<p>and</p>
<p><code>
	/**
	 * Creates a new entity list with the specified capacity.
	 * 
	 * @param capacity
	 *            The maximum number of entities that can be present in the
	 *            repository.
	 */
	public EntityList(int capacity) {
		this.entities = new Entity[capacity];
	}</code></p>
<p>There is no default capacity, the capacity must be set upon construction, unless modified by someone stupid, you will not get a IOOBE.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/23">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/23</link>
        <pubDate>Fri, 11 Oct 2013 02:01:39 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-23</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@sspoke sspoke]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sspoke">@sspoke</a> wrote:</p>
          <blockquote>
              <p>Wouldn’t</p>
<pre><code class="lang-auto"> return entities[entity.getIndex()] == entity;</code></pre>
<p>Crash if entity.getIndex() returns a number bigger then entities array or -1 number</p>
<pre><code class="lang-auto">return entities[-1] == entity </code></pre>
<p>will crash <img src="https://forum.moparisthebest.com/images/emoji/twitter/stuck_out_tongue.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/22">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/22</link>
        <pubDate>Fri, 11 Oct 2013 01:42:45 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-22</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>[quote=“filthjr, post:20, topic:378459”][quote author=headlights link=topic=474324.msg3517281#msg3517281 date=1299104859]</p>
<aside class="quote">
<blockquote>
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/filth/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> filth:</div>
<blockquote>
<p>player/npc updating requires order</p>
</blockquote>
</aside>
<p>and how does that getIndex method work? would it return -1 if it doesn’t have an index? or an invalid index (i.e. 0 when there is a different object at 0), wouldn’t it make more sense to check if the object at that index equals the object you’re comparing it to?</p>
</blockquote>
</aside>
<p>When you say “order”, are you talking about updating the closest players/NPCs first an so on? That’s beyond the scope of this tutorial. I wouldn’t say it’s “required”, although I suppose it can turn into an issue if the amount of players in a given region is too high.</p>
<p>An entity’s index is only ever set by the EntityList implementation, so what you’re saying is not necessary. Unless someone sets the entity’s index from the “outside” (encapsulation issue), it will always be equal to its index in the EntityList array.<br>
[/quote]</p>
<p>no, the way the client identifies which entity is being updated is by retaining the same order each time you are doing entity updating, so if you have an unordered set, it will frequently update the wrong entities.</p>
<p>and the problem for your first improvement is that indexes are reused so while the player with index 1 might no longer be logged in, the index 1 could have been reused meaning that it is no longer null (which is what you check for).</p>
<p>just compare objects instead of comparing that object in the specified index to null[/quote]<br>
Oh, I see what you’re saying now. I’ll update my original post. Those who applied the improvements before should update as well.</p>
<p>To summarize, this is the new contains() implementation:</p>
<pre><code class="lang-auto">@Override
public boolean contains(Object arg0) {
        Entity entity = (Entity) arg0;
        return entities[entity.getIndex()] == entity;
}</code></pre>
<p>Also, instead of using a HashSet, I advise you guys to use a LinkedHashSet.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/21">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/21</link>
        <pubDate>Thu, 03 Mar 2011 16:20:55 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-21</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@filthjr filthjr]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/filthjr">@filthjr</a> wrote:</p>
          <blockquote>
              <p>[quote=“headlights, post:18, topic:378459”][quote author=filthjr link=topic=474324.msg3516157#msg3516157 date=1299015681]</p>
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/filth/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> filth:</div>
<blockquote>
<p>player/npc updating requires order</p>
</blockquote>
</aside>
<p>and how does that getIndex method work? would it return -1 if it doesn’t have an index? or an invalid index (i.e. 0 when there is a different object at 0), wouldn’t it make more sense to check if the object at that index equals the object you’re comparing it to?<br>
[/quote]<br>
When you say “order”, are you talking about updating the closest players/NPCs first an so on? That’s beyond the scope of this tutorial. I wouldn’t say it’s “required”, although I suppose it can turn into an issue if the amount of players in a given region is too high.</p>
<p>An entity’s index is only ever set by the EntityList implementation, so what you’re saying is not necessary. Unless someone sets the entity’s index from the “outside” (encapsulation issue), it will always be equal to its index in the EntityList array.[/quote]</p>
<p>no, the way the client identifies which entity is being updated is by retaining the same order each time you are doing entity updating, so if you have an unordered set, it will frequently update the wrong entities.</p>
<p>and the problem for your first improvement is that indexes are reused so while the player with index 1 might no longer be logged in, the index 1 could have been reused meaning that it is no longer null (which is what you check for).</p>
<p>just compare objects instead of comparing that object in the specified index to null</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/20</link>
        <pubDate>Wed, 02 Mar 2011 23:50:26 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-20</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@why_so_serious why so serious]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/why_so_serious">@why_so_serious</a> wrote:</p>
          <blockquote>
              <p>Thank’s a lot.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/19</link>
        <pubDate>Wed, 02 Mar 2011 23:27:33 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-19</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <aside class="quote quote-modified" data-post="17" data-topic="378459">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/filthjr/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> filthjr:</div>
<blockquote>
<p>[quote=filth]player/npc updating requires order</p>
</blockquote>
</aside>
<p>and how does that getIndex method work? would it return -1 if it doesn’t have an index? or an invalid index (i.e. 0 when there is a different object at 0), wouldn’t it make more sense to check if the object at that index equals the object you’re comparing it to?[/quote]<br>
When you say “order”, are you talking about updating the closest players/NPCs first an so on? That’s beyond the scope of this tutorial. I wouldn’t say it’s “required”, although I suppose it can turn into an issue if the amount of players in a given region is too high.</p>
<p>An entity’s index is only ever set by the EntityList implementation, so what you’re saying is not necessary. Unless someone sets the entity’s index from the “outside” (encapsulation issue), it will always be equal to its index in the EntityList array.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/18</link>
        <pubDate>Wed, 02 Mar 2011 22:27:39 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-18</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@filthjr filthjr]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/filthjr">@filthjr</a> wrote:</p>
          <blockquote>
              <blockquote>player/npc updating requires order</blockquote>
<p>and how does that getIndex method work? would it return -1 if it doesn’t have an index? or an invalid index (i.e. 0 when there is a different object at 0), wouldn’t it make more sense to check if the object at that index equals the object you’re comparing it to?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/17</link>
        <pubDate>Tue, 01 Mar 2011 21:41:21 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-17</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <aside class="quote quote-modified" data-post="15" data-topic="378459">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/glestrts/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> glestrts:</div>
<blockquote>
<p>Either way, regardless of the whether the second decision works or not, this still is a beneficial optimization for hyperion. I’ll try and benchmark this in a few days when I have the time.</p>
</blockquote>
</aside>
<p>I did my benchmark again, but this time I made sure that the main player’s location was the default location, meaning all the “dummy” players were on top top of the main player. I compared the original Hyperion to a version of Hyperion with Improvement <span class="hashtag">#2</span> as an optimization (the only optimization, to make the test fair), and it turns out that it <span class="bbcode-i">does</span> improve the performance.</p>
<p>Thanks. I’m interested in seeing what someone else produces :).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/16</link>
        <pubDate>Tue, 01 Mar 2011 16:26:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-16</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@glestrts glestrts]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/glestrts">@glestrts</a> wrote:</p>
          <blockquote>
              <p>Either way, regardless of the whether the second decision works or not, this still is a beneficial optimization for hyperion. I’ll try and benchmark this in a few days when I have the time.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/15</link>
        <pubDate>Tue, 01 Mar 2011 03:18:41 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-15</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>[quote=“iKilem, post:12, topic:378459”]Note that you’re not guaranteed O(1) efficiency if you use a HashSet.</p>
<p>I find it hard to believe that this “speeds up Hyperion by up to 500%”. I haven’t done any tests, so I guess I can’t really argue. Your test program doesn’t consider the location of these dummy players. Can’t really tell from the code you provided, though.[/quote]<br>
True, but the point I was getting across is that it is more-likely to perform better than a LinkedList, which has to do a linear search.</p>
<p>You’re right. I guess the test doesn’t really reflect too much on Improvement <span class="hashtag">#2</span> in that case, but if I did consider locations, it would only show that the improvement makes Hyperion even faster.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/14</link>
        <pubDate>Tue, 01 Feb 2011 19:29:57 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-14</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@relmitos relmitos]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/relmitos">@relmitos</a> wrote:</p>
          <blockquote>
              <p>+rep for this, all I have to say</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/13</link>
        <pubDate>Mon, 31 Jan 2011 23:15:19 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-13</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@iKilem iKilem]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/ikilem">@iKilem</a> wrote:</p>
          <blockquote>
              <p>Note that you’re not guaranteed O(1) efficiency if you use a HashSet.</p>
<p>I find it hard to believe that this “speeds up Hyperion by up to 500%”. I haven’t done any tests, so I guess I can’t really argue. Your test program doesn’t consider the location of these dummy players. Can’t really tell from the code you provided, though.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/12</link>
        <pubDate>Mon, 31 Jan 2011 22:52:24 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-12</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <aside class="quote no-group" data-post="10" data-topic="378459">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/glestrts/40/5_1887921562df0dabfae55079ddabeb03.png" class="avatar"> glestrts:</div>
<blockquote>
<p>Goodjob, this deserves a bump, ill check into these tweaks.</p>
</blockquote>
</aside>
<p>Thanks, glestrts.</p>
<p>If anyone wants to implement Graham’s suggestion, add this in <span class="bbcode-u">org.hyperion.rs2.model.Entity</span>:</p>
<pre><code class="lang-auto">@Override
public int hashCode() {
	return index;
}</code></pre>
<p>Or, you could just use a <span class="bbcode-u">org.hyperion.rs2.util.EntityList</span> for holding local players/NPCs, but memory usage would increase, and I’m not sure if the speed improvements are worth it. Sounds more like a premature optimization. I’m not sure how much of an improvement overriding hashCode() is, either, but it’s worth it from a design perspective, at least.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/11</link>
        <pubDate>Mon, 31 Jan 2011 18:27:10 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-11</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@glestrts glestrts]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/glestrts">@glestrts</a> wrote:</p>
          <blockquote>
              <p>Goodjob, this deserves a bump, ill check into these tweaks.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/10</link>
        <pubDate>Tue, 25 Jan 2011 19:53:26 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-10</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>[quote=“I Vain I”]What is this? Someone that actually knows what they are doing, that isn’t a familiar name.</p>
<p>Odd; Nonetheless good job.[/quote]<br>
Ignore the join date. I’ve been hacking/emulating for a couple of years now :P.</p>
<p>Also, if you (people in general) know of another site/community that may benefit from this tutorial, please mirror it (C&amp;P)!</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/9</link>
        <pubDate>Mon, 17 Jan 2011 16:33:52 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-9</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@Echo3 Echo_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/echo3">@Echo3</a> wrote:</p>
          <blockquote>
              <p>Nice work, this should be very helpful to anyone who wants to use Hyperion.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/8</link>
        <pubDate>Sun, 16 Jan 2011 21:45:21 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-8</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>[quote=“Graham, post:6, topic:378459”]Some nice ideas, although I’m not sure how well using the HashSet works considering the hash code of entity objects will change over their lifetime. Perhaps writing a custom hashCode/equals method which only took the player’s id (which remains fixed) into account would be a good idea? Or maybe even use BitSet instead?</p>
<p>Also, it’d be nice to know a little bit more detail about how you got the 500% figure in your tests. It does seem to just be plucked randomly out of the air :p.[/quote]</p>
<pre><code class="lang-auto">@Override
public void execute(GameEngine context) {
	for (int i = 0; i &lt; 199; i++) {
		World.getWorld().getPlayers().add(new Player(new PlayerDetails(null, "", null, i, null, null)));
	}

	long startTime = System.nanoTime();
	for (int i = 0; i &lt; 200; i++) {
		if (player.isMapRegionChanging()) {
			player.getActionSender().sendMapRegion();
		}

		PacketBuilder updateBlock = new PacketBuilder();
		PacketBuilder packet = new PacketBuilder(42, Packet.Type.VARIABLE_SHORT);

		packet.startBitAccess();
		updateThisPlayerMovement(packet);
		updatePlayer(updateBlock, player, false, true);

		packet.putBits(8, player.getLocalPlayers().size());
		for (Iterator&lt;Player&gt; it$ = player.getLocalPlayers().iterator(); it$.hasNext();) {
			Player otherPlayer = it$.next();
			if (World.getWorld().getPlayers().contains(otherPlayer) &amp;&amp; !otherPlayer.isTeleporting() &amp;&amp; otherPlayer.getLocation().isWithinDistance(player.getLocation())) {
				updatePlayerMovement(packet, otherPlayer);
				if (otherPlayer.getUpdateFlags().isUpdateRequired()) {
					updatePlayer(updateBlock, otherPlayer, false, false);
				}
			} else {
				it$.remove();
				packet.putBits(1, 1);
				packet.putBits(2, 3);
			}
		}

		for (Player otherPlayer : World.getWorld().getRegionManager().getLocalPlayers(player)) {
			if (player.getLocalPlayers().size() &gt;= 255) {
				break;
			}
			if (otherPlayer == player || player.getLocalPlayers().contains(otherPlayer)) {
				continue;
			}

			player.getLocalPlayers().add(otherPlayer);
			//addNewPlayer(packet, otherPlayer);
			//updatePlayer(updateBlock, otherPlayer, true, false);
		}

		if (!updateBlock.isEmpty()) {
			packet.putBits(11, 2047);
			packet.finishBitAccess();
			packet.put(updateBlock.toPacket().getPayload());
		} else {
			packet.finishBitAccess();
		}
		if (i == 0) {
			player.write(packet.toPacket());
		}
	}
	System.out.println(System.nanoTime() - startTime);

	World.getWorld().getPlayers().clear();
	World.getWorld().getPlayers().add(player);
	player.getLocalPlayers().clear();
}</code></pre>
<p>Like I said, it’s very rough and not very accurate. The garbage-collector botches the results the longer you have it running, but I think the initial values should give a good indication for at least comparing the results.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/7</link>
        <pubDate>Sun, 16 Jan 2011 21:23:38 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-7</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@Graham Graham]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/graham">@Graham</a> wrote:</p>
          <blockquote>
              <p>Some nice ideas, although I’m not sure how well using the HashSet works considering the hash code of entity objects will change over their lifetime. Perhaps writing a custom hashCode/equals method which only took the player’s id (which remains fixed) into account would be a good idea? Or maybe even use BitSet instead?</p>
<p>Also, it’d be nice to know a little bit more detail about how you got the 500% figure in your tests. It does seem to just be plucked randomly out of the air :p.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/6</link>
        <pubDate>Sun, 16 Jan 2011 20:12:44 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-6</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@Clawz_fury lare69]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/clawz_fury">@Clawz_fury</a> wrote:</p>
          <blockquote>
              <aside class="quote no-group" data-post="2" data-topic="378459">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/canownueazy/40/5_1887921562df0dabfae55079ddabeb03.png" class="avatar"> Canownueazy:</div>
<blockquote>
<p>Good job.</p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="3" data-topic="378459">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/scape-java/40/5_1887921562df0dabfae55079ddabeb03.png" class="avatar"> Scape-JAVA:</div>
<blockquote>
<p>Nice work OP, could be useful.</p>
</blockquote>
</aside>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/5</link>
        <pubDate>Sun, 16 Jan 2011 19:24:31 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-5</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>There were a lot of mistakes, which I have fixed now. If something else is wrong, please tell me!</p>
<p>Thanks for the feedback :).</p>
<p>Edit: Fixed even more stuff.</p>
<p>[b]Edit 2: I’ve updated the tutorial. After (roughly) benchmarking Hyperion before and after, it seems that the first suggestion didn’t actually improve the performance of Hyperion significantly. It also had a mistake that I didn’t spot before, so I apologize if anyone applied that modification. If you did, please roll back to how it was originally. Again, I’m sorry. Because of this, I replaced the first suggestion with another one, which I forgot to mention earlier. It is probably the most important, actually, which is why it’s first on the list now.</p>
<p>According to the benchmark, Hyperion increased in speed by up to 500%! That is quite an improvement. If you do use Hyperion, you should really apply these improvements. However, as mentioned, it was a rough test. It would be nice if someone else did a proper benchmark. I myself do not have the time or the appropriate tools to do so.[/b]</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/4</link>
        <pubDate>Sat, 15 Jan 2011 18:08:47 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-4</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@Scape-JAVA Scape-JAVA]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/scape-java">@Scape-JAVA</a> wrote:</p>
          <blockquote>
              <p>Nice work OP, could be useful.</p>
<p><a class="mention" href="/u/canownueasy">@Canownueasy</a><br>
you blow too much sun shine up your ass ;).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/3</link>
        <pubDate>Sat, 15 Jan 2011 18:06:51 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-3</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@Canownueazy Canownueazy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/canownueazy">@Canownueazy</a> wrote:</p>
          <blockquote>
              <p>Good job.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/2</link>
        <pubDate>Sat, 15 Jan 2011 18:05:37 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-2</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
      <item>
        <title>Improving the Performance of Hyperion</title>
        <dc:creator><![CDATA[@headlights headlights]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/headlights">@headlights</a> wrote:</p>
          <blockquote>
              <p>[size=14pt]<span class="bbcode-b">Introduction</span>[/size]<br>
Although Hyperion is already a relatively high-performance server, there are some things that could still be improved. This tutorial will focus on entity updating, which is probably the biggest breeding-ground for bottlenecks, for any RuneScape server. Hyperion, unfortunately, does not handle entity updating as well as it could, considering the approach it takes (e.g. to iterate through a region and its surrounding regions to retrieve near-by players/npcs).</p>
<p><span class="bbcode-b">These improvements have proven to speed up Hyperion by up to 500%!</span></p>
<p>[size=14pt]<span class="bbcode-b">Improvement <span class="hashtag">#1</span></span>[/size]<br>
Hyperion stores all Players and NPCs in an <span class="bbcode-u">org.hyperion.rs2.util.EntityList</span>. <span class="bbcode-b">The problem is with its contains() method.</span></p>
<pre><code class="lang-auto">@Override
public boolean contains(Object arg0) {
	for(int i = 1; i &lt; entities.length; i++) {
		if(entities[i] == arg0) {
			return true;
		}
	}
	return false;
}</code></pre>
<p>It iterates through <span class="bbcode-i">all</span> the entities until it finds the one it is looking for. Quite unnecessary.</p>
<p><span class="bbcode-b">To fix this, replace the contains() method with this:</span></p>
<pre><code class="lang-auto">@Override
public boolean contains(Object arg0) {
	Entity entity = (Entity) arg0;
	return entities[entity.getIndex()] == entity;
}</code></pre>
<p>That’s all there is to it. You’re done!</p>
<p>[size=14pt]<span class="bbcode-b">Improvement <span class="hashtag">#2</span></span>[/size]<br>
Hyperion stores all local Players/NPCs in a <span class="bbcode-u">java.util.LinkedList</span>. Again, <span class="bbcode-b">the problem is with its contains() method.</span></p>
<p><span class="bbcode-b">The solution is to use a <span class="bbcode-u">java.util.LinkedHashSet</span> instead.</span> Its lookup time is O(1), as with the new contains() method from earlier.</p>
<p>In other words, <span class="bbcode-b">find these declarations:</span></p>
<pre><code class="lang-auto">/**
 * The list of local players.
 */
private final List&lt;Player&gt; localPlayers = new LinkedList&lt;Player&gt;();

/**
 * The list of local npcs.
 */
private final List&lt;NPC&gt; localNpcs = new LinkedList&lt;NPC&gt;();</code></pre>
<p><span class="bbcode-b">Replace them with the following:</span></p>
<pre><code class="lang-auto">/**
 * The list of local players.
 */
private final Set&lt;Player&gt; localPlayers = new LinkedHashSet&lt;Player&gt;();

/**
 * The list of local npcs.
 */
private final Set&lt;NPC&gt; localNpcs = new LinkedHashSet&lt;NPC&gt;();</code></pre>
<p><span class="bbcode-b">Replace the appropriate getter methods:</span></p>
<p>[code=JAVA]/**</p>
<ul>
<li>Gets the list of local players.</li>
<li>
<a class="mention" href="/u/return">@return</a> The list of local players.<br>
*/<br>
public List getLocalPlayers() {<br>
return localPlayers;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the list of local npcs.</li>
<li>
<a class="mention" href="/u/return">@return</a> The list of local npcs.<br>
*/<br>
public List getLocalNPCs() {<br>
return localNpcs;<br>
}<br>
[/code]<br>
So that a <span class="bbcode-u">java.util.Set</span> is returned instead:</li>
</ul>
<pre><code class="lang-auto">/**
 * Gets the set of local players.
 * @return The set of local players.
 */
public Set&lt;Player&gt; getLocalPlayers() {
	return localPlayers;
}

/**
 * Gets the set of local npcs.
 * @return The set of local npcs.
 */
public Set&lt;NPC&gt; getLocalNPCs() {
	return localNpcs;
}</code></pre>
<p>After that, you are done!</p>
<p>That’s it. If you have any questions, feel free to ask.</p>
<p><span class="bbcode-i">Note: Make sure you import the appropriate classes!</span></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459/1</link>
        <pubDate>Sat, 15 Jan 2011 17:44:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-378459-1</guid>
        <source url="https://forum.moparisthebest.com/t/improving-the-performance-of-hyperion/378459.rss">Improving the Performance of Hyperion</source>
      </item>
  </channel>
</rss>
