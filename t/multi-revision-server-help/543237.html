<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/multi-revision-server-help/543237 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 02:00:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Multi-Revision Server Help - Runescape - moparisthebest.com</title>
    <meta name="description" content="I&amp;#39;m trying to get my server to connect to a 562 (first time ever programming anything higher than a 317 so forgive me if I made a mistake) client but for some reason the return code that&amp;#39;s being sent is &amp;quot;Unexpected serve&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="543237.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Multi-Revision Server Help&#39;" href="543237.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/multi-revision-server-help/543237" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/multi-revision-server-help/543237" />
<meta property="og:title" content="Multi-Revision Server Help" />
<meta name="twitter:title" content="Multi-Revision Server Help" />
<meta property="og:description" content="I’m trying to get my server to connect to a 562 (first time ever programming anything higher than a 317 so forgive me if I made a mistake) client but for some reason the return code that’s being sent is “Unexpected server response. Please try using a different world.” I’m almost certain that I’m sending the correct return code (2). Sometimes it sends different return codes such as “Invalid username” and whatnot. Any ideas? Thanks!  EDIT: I debugged my server and the name and password won’t show ..." />
<meta name="twitter:description" content="I’m trying to get my server to connect to a 562 (first time ever programming anything higher than a 317 so forgive me if I made a mistake) client but for some reason the return code that’s being sent is “Unexpected server response. Please try using a different world.” I’m almost certain that I’m sending the correct return code (2). Sometimes it sends different return codes such as “Invalid username” and whatnot. Any ideas? Thanks!  EDIT: I debugged my server and the name and password won’t show ..." />
<meta property="article:published_time" content="2014-05-20T21:26:35+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="543237.html">Multi-Revision Server Help</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Rodrigues.html'><span itemprop='name'>Rodrigues</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2014-05-20T21:26:35Z'>
            <time itemprop='dateModified' datetime='2016-08-04T13:09:13Z' class='post-time'>
              August 4, 2016,  1:09pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I’m trying to get my server to connect to a 562 (first time ever programming anything higher than a 317 so forgive me if I made a mistake) client but for some reason the return code that’s being sent is “Unexpected server response. Please try using a different world.” I’m almost certain that I’m sending the correct return code (2). Sometimes it sends different return codes such as “Invalid username” and whatnot. Any ideas? Thanks!</p>
<p>EDIT: I debugged my server and the name and password won’t show up when printing them out.</p>
<p>[CODE]<br>
/*<br>
* (non-Javadoc)<br>
* <span class="mention">@see</span> java.lang.Runnable#run()<br>
*/<br>
<a class="mention" href="../../u/override.html">@Override</a><br>
public void run() {<br>
this.setOutStream(new IOPacketBuffer(new byte[Constants.BUFFER_SIZE]));<br>
this.getOutStream().setCurrentOffset(0);<br>
this.setInStream(new IOPacketBuffer(new byte[Constants.BUFFER_SIZE]));<br>
this.getInStream().setCurrentOffset(0);<br>
long serverSessionKey = ((long) (Math.random() * 99999999D) &lt;&lt; 32) + (long) (Math.random() * 99999999D);<br>
long clientSessionKey = 0;<br>
this.fillInStream(2);<br>
this.setLoginStage(LoginStage.FIRST);<br>
System.out.println(“First stage.”);<br>
if (this.getLoginStage() == LoginStage.FIRST) {<br>
System.out.println("First Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
this.setLoginStage(LoginStage.FOURTH);<br>
final byte opcodeUpdate = (byte) this.getInStream().readUnsignedByte();<br>
if (opcodeUpdate == 15) {<br>
System.out.println(“Opcode is 15!”);<br>
this.setLoginStage(LoginStage.SECOND);<br>
}<br>
this.getInStream().readUnsignedByte();<br>
}<br>
if (this.getLoginStage() == LoginStage.SECOND) {<br>
System.out.println(“Second stage.”);<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final short clientRevision = (short) this.getInStream().readUnsignedWord();<br>
try {<br>
this.getOutputStream().write(0);<br>
this.setLoginStage(LoginStage.THIRD);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
if (this.getLoginStage() == LoginStage.THIRD) {<br>
System.out.println(“Third stage.”);<br>
Main.getMain().setRevisionType(RevisionType.FIVE_SIXTY_TWO);<br>
System.out.println("Second Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
for (int i = 0; i &lt; Constants.UPDATE_KEYS.length; i++) {<br>
try {<br>
this.getOutputStream().write(Constants.UPDATE_KEYS[i]);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
}<br>
if (this.getLoginStage() == LoginStage.FOURTH) {<br>
System.out.println(“Fourth stage.”);<br>
System.out.println(“Sending an unsigned byte!”);<br>
this.getInStream().readUnsignedByte();<br>
System.out.println(“Sending a for loop.”);<br>
for (int i = 0; i &lt; 8; i++) {<br>
try {<br>
this.getOutputStream().write(0);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
System.out.println(“Sent a for loop.”);<br>
try {<br>
this.getOutputStream().write(0);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
System.out.println(“Sending server session key.”);<br>
this.getOutStream().writeQWord(serverSessionKey);<br>
this.flushOutStream();<br>
this.fillInStream(2);<br>
System.out.println(“Sending login type.”);<br>
final int loginType = this.getInStream().readUnsignedByte();<br>
if ((loginType != 16) &amp;&amp; (loginType != 18)) {<br>
System.out.println(“Login type is not 16 and 18”);<br>
return;<br>
}<br>
System.out.println(“Sending login packet size.”);<br>
final int loginPacketSize = this.getInStream().readUnsignedByte();<br>
int loginEncryptPacketSize = loginPacketSize - 40;<br>
System.out.println("Third Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
if (Main.getMain().getRevisionType().getRevisionID() == 317) {<br>
this.fillInStream(loginPacketSize);<br>
System.out.println(“Sending magic numer.”);<br>
if (this.getInStream().readUnsignedByte() != 255) {<br>
System.out.println(“Magic number is not 255.”);<br>
return;<br>
}<br>
}<br>
System.out.println(“Sending revision.”);<br>
this.getInStream().readUnsignedWord();<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Printing out memory.”);<br>
this.getInStream().readUnsignedByte(); // memory.<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
for (int i = 0; i &lt; 9; i++) {<br>
Integer.toHexString(this.getInStream().readDWord());<br>
}<br>
loginEncryptPacketSize–;<br>
int tmp = this.getInStream().readUnsignedByte();<br>
if (loginEncryptPacketSize != tmp) {<br>
return;<br>
}<br>
tmp = this.getInStream().readUnsignedByte();<br>
if (tmp != 10) {<br>
return;<br>
}<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
this.getInStream().readString();<br>
}<br>
System.out.println(“Printing out client and server session keys.”);<br>
clientSessionKey = this.getInStream().readQWord();<br>
serverSessionKey = this.getInStream().readQWord();<br>
long nameLong = 0;<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final int hash;<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
nameLong = this.getInStream().readQWord();<br>
hash = (int) (31 &amp; (nameLong &gt;&gt; 16));<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final int userID = this.getInStream().readDWord();<br>
}<br>
final String name = Misc.longToName(nameLong);<br>
System.out.println("Name: " + name);<br>
final String password = this.getInStream().readString();<br>
System.out.println("Password: " + password);<br>
System.out.println(“Printed out username, user id, and password.”);<br>
final int[] sessionKey = new int[4];<br>
sessionKey[0] = (int) (clientSessionKey &gt;&gt; 32);<br>
sessionKey[1] = (int) clientSessionKey;<br>
sessionKey[2] = (int) (serverSessionKey &gt;&gt; 32);<br>
sessionKey[3] = (int) serverSessionKey;<br>
for (int i = 0; i &lt; 4; i++) {<br>
Integer.toHexString(sessionKey[i]);<br>
}<br>
this.setInStreamDecryption(new ISAACRandomGen(sessionKey));<br>
for (byte i = 0; i &lt; 4; i++) {<br>
sessionKey[i] += 50;<br>
}<br>
for (byte i = 0; i &lt; 4; i++) {<br>
Integer.toHexString(sessionKey[i]);<br>
}<br>
this.setOutStreamDecryption(new ISAACRandomGen(sessionKey));<br>
this.getOutStream().setPacketEncryption(this.getOutStreamDecryption());<br>
final Entity player = new Player(name, null);<br>
try {<br>
System.out.println(“Sending return code of 2.”);<br>
this.getOutputStream().write(2); // return code<br>
if (player.getName().equals(“Josh”)) {<br>
System.out.println("Sending player rights of 2 for " + player.getName());<br>
this.getOutputStream().write(2); // rights<br>
} else {<br>
this.getOutputStream().write(0); // rights<br>
}<br>
this.getOutStream().writeByte(0);<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
System.out.println(“Sending login bytes.”);<br>
this.getOutStream().writeByte((byte) 0);<br>
this.getOutStream().writeByte((byte) 0);<br>
this.getOutStream().writeByte((byte) 0);<br>
this.getOutStream().writeByte((byte) 0);<br>
this.getOutStream().writeByte((byte) 0);<br>
this.getOutStream().writeWord(1); // slot (playerID - same thing?)<br>
this.getOutStream().writeByte((byte) 1);<br>
this.getOutStream().writeByte((byte) 1); // members<br>
this.flushOutStream();<br>
}<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
this.getOutStream().createFrame(249);<br>
this.getOutStream().writeByteA(1);<br>
this.getOutStream().writeWordA(1);<br>
this.getOutStream().createFrame(107);<br>
this.getOutStream().createFrameVarSize(253);<br>
this.getOutStream().writeString(“Welcome to RS3 Newstart!”);<br>
this.getOutStream().endFrameVarSize();<br>
this.flushOutStream();<br>
for (byte b = 0; b &lt; 25; b++) {<br>
this.setSkillLevel(b, (byte) 0, (byte) 0);<br>
}<br>
this.setChatOptions((byte) 0, (byte) 0, (byte) 0); // reset private messaging options<br>
final short[] tabInterfaces = {<br>
2423, 3917, 638, 3213, 1644, 5608, 1151, 1, 5065, 5715, // modern<br>
2449, 4445, 147, 6299<br>
};<br>
for (byte b = 0; b &lt; 14; b++) {<br>
this.setTabInterface(b, tabInterfaces[b]);<br>
}<br>
// this.setSidebarInterface(6, 12855); // ancient</p>
<pre><code>			// this.getPA().showInterface(3559);
			// this.newPlayer = false;
			this.showMenuOption(4, 0, "Trade With");
			this.showMenuOption(5, 0, "Follow");
			this.showMenuOption(6, 0, "Ban");
			this.showMenuOption(7, 0, "Kick");
			this.showMenuOption(8, 0, "Mute");

			this.getOutStream().createFrame(73);
			this.getOutStream().writeWordA(player.getLocation().getRegionX() + 6);
			this.getOutStream().writeWord(player.getLocation().getRegionY() + 6);
			this.flushOutStream();
			this.getOutStream().createFrame(81);
			this.getOutStream().writeWord(0); 		// placeholder for size of this packet.
			final int ofs = this.getOutStream().getCurrentOffset();
			this.getOutStream().initBitAccess();

			// update this player
			this.getOutStream().writeBits(1, 1);		// set to true if updating thisPlayer
			this.getOutStream().writeBits(2, 3);		// updateType - 3=jump to pos
			// the following applies to type 3 only
			this.getOutStream().writeBits(2, 0);		// height level (0-3)
			this.getOutStream().writeBits(1, 1);		// set to true, if discarding walking queue (after teleport e.g.)
			this.getOutStream().writeBits(1, 1);		// set to true, if this player is not in local list yet???
			this.getOutStream().writeBits(7, 0x20);	// y-position
			this.getOutStream().writeBits(7, 0x20);	// x-position

			// update other players...?!
			this.getOutStream().writeBits(8, 0);		// number of players to add

			// add new players???
			this.getOutStream().writeBits(11, 2047);	// magic EOF
			this.getOutStream().finishBitAccess();

			this.getOutStream().writeByte(0);		// ???? needed that to stop client from crashing

			this.getOutStream().writeFrameSizeWord(this.getOutStream().getCurrentOffset() - ofs);
		}
		if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {
			this.getOutStream().createFrameVarSizeWord(76);
			this.getOutStream().writeWordBigEndianA(player.getLocation().getRegionX());
			this.getOutStream().writeWord(player.getLocation().getLocalY());
			this.getOutStream().writeByte(0);
			this.getOutStream().writeByteA(0);
			boolean forceRegion = (((player.getLocation().getRegionX() / 8) == 48) || ((player.getLocation().getRegionX() / 8) == 49)) &amp;&amp; ((player.getLocation().getRegionY() / 8) == 48);
			if (((player.getLocation().getRegionX() / 8) == 48) &amp;&amp; ((player.getLocation().getRegionY() / 8) == 148)) {
				forceRegion = true;
			}
			for (int xCalc = (player.getLocation().getRegionX() - 6) / 8; xCalc &lt;= ((player.getLocation().getRegionX() + 6) / 8); xCalc++) {
				for (int yCalc = (player.getLocation().getRegionY() - 6) / 8; yCalc &lt;= ((player.getLocation().getRegionY() + 6) / 8); yCalc++) {
					final int region = yCalc + (xCalc &lt;&lt; 8);
					final int[] mapData = Main.getMain().getMapData().getRegionData(region);
					if (forceRegion &amp;&amp; ((yCalc == 49) || (yCalc == 149) || (yCalc == 147) || (xCalc == 50) || ((xCalc == 49) &amp;&amp; (yCalc == 47)))) {
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
					} else {
						this.getOutStream().writeDWord(mapData[0]);
						this.getOutStream().writeDWord(mapData[1]);
						this.getOutStream().writeDWord(mapData[2]);
						this.getOutStream().writeDWord(mapData[3]);
					}
				}
			}
			this.getOutStream().writeByteA(player.getLocation().getZ());
			this.getOutStream().writeWord(player.getLocation().getLocalX());
			this.getOutStream().writeWord(player.getLocation().getRegionY());
			this.getOutStream().endFrameVarSizeWord();


			this.getOutStream().createFrameVarSizeWord(107);
			this.getOutStream().writeWord(0); 		// placeholder for size of this packet.
			final int ofs = this.getOutStream().getCurrentOffset();
			this.getOutStream().initBitAccess();

			// update this player
			this.getOutStream().writeBits(1, 1);		// set to true if updating thisPlayer
			this.getOutStream().writeBits(2, 3);		// updateType - 3=jump to pos
			// the following applies to type 3 only
			this.getOutStream().writeBits(2, 0);		// height level (0-3)
			this.getOutStream().writeBits(1, 1);		// set to true, if discarding walking queue (after teleport e.g.)
			this.getOutStream().writeBits(1, 1);		// set to true, if this player is not in local list yet???
			this.getOutStream().writeBits(7, 0x20);	// y-position
			this.getOutStream().writeBits(7, 0x20);	// x-position

			// update other players...?!
			this.getOutStream().writeBits(8, 0);		// number of players to add

			// add new players???
			this.getOutStream().writeBits(11, 2047);	// magic EOF
			this.getOutStream().finishBitAccess();

			this.getOutStream().writeByte(0);		// ???? needed that to stop client from crashing

			this.getOutStream().writeFrameSizeWord(this.getOutStream().getCurrentOffset() - ofs);
		}
		this.flushOutStream();
		this.setClientConnected(true);
		// new TaskSystem(player, this.getOutStream(), this.getOutputStream());
		final GameEngine gameEngine = new GameEngine((Player) player);
		gameEngine.getPlayerList().add((Player) player);
	}
}
</code></pre>
<p>[/CODE]</p>
<p>This is what the console in Eclipse shows:</p>
<p><code>
Loading map data!
Networking Frame started in 445ms.
Loaded mapdata.
RuneScape Server started in 1024ms.
IO started in 18ms.
First stage.
First Call: 317
Opcode is 15!
Second stage.
Third stage.
Second Call: 562
First stage.
First Call: 562
Fourth stage.
Sending an unsigned byte!
Sending a for loop.
Sent a for loop.
Sending server session key.
Sending login type.
Sending login packet size.
Third Call: 562
Sending revision.
Printing out client and server session keys.
Name: 
Password: 
Printed out username, user id, and password.
Sending return code of 2.
Sending login bytes.
</code></p>
<p>*Took this straight from rune-server since I didn’t feel like retyping it.</p>
<p>EDIT <span class="hashtag">#2:</span> I get the following error after changing my server up a bit.</p>
<p><code>
Error: fm.U({...},-91) T3 - true,261,4720,-1234525018,1516466596,1516466596,1130748942 qj.BA({...},104,0,261) qj.O({...},261,8610,0) uj.B(false) client.M(77) | Class23_Sub4_Sub3.method377:201 Class158.method2357:335 Class158.method2360:522 Class202.method2723:90 client.method43:682 Applet_Sub1.method41:317 Applet_Sub1.run:799 java.lang.Thread.run | java.lang.RuntimeException
error_game_crash
</code></p>
<p>Also, what is the difference between XTEA keys vs Update keys? Are they the same thing or no?</p>
<p>EDIT <span class="hashtag">#3:</span> I found out that T3 errors deal with mapdata. Is this correct? If so, would it mean that I’m missing mapdata and that’s the problem?</p>
      </div>

      <meta itemprop='headline' content='Multi-Revision Server Help'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Vain1.html'><span itemprop='name'>Vain1</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2014-05-21T01:08:17Z'>
            <time itemprop='dateModified' datetime='2016-08-04T13:09:15Z' class='post-time'>
              August 4, 2016,  1:09pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>the login protocol between the revisions differ greatly.  I can’t really help you with that, but I can tell you that the update keys (uKeys or crcs) are not the same as XTEAs (map data)</p>
      </div>

      <meta itemprop='headline' content='Multi-Revision Server Help'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Rodrigues.html'><span itemprop='name'>Rodrigues</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2014-05-21T12:24:17Z'>
            <time itemprop='dateModified' datetime='2016-08-04T13:09:19Z' class='post-time'>
              August 4, 2016,  1:09pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="2" data-topic="543237">
<div class="title">
<div class="quote-controls"></div>
 Vain_:</div>
<blockquote>
<p>the login protocol between the revisions differ greatly.  I can’t really help you with that, but I can tell you that the update keys (uKeys or crcs) are not the same as XTEAs (map data)</p>
</blockquote>
</aside>
<p>I’m a little confused about XTEAs. Do you just load the mapdata.dat (or packed.dat - whichever one) or do you load XTEA keys some other way? Are XTEA keys actually different than mapdata.dat or are they both the same exact thing?</p>
      </div>

      <meta itemprop='headline' content='Multi-Revision Server Help'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Vain1.html'><span itemprop='name'>Vain1</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2014-05-21T16:10:12Z'>
            <time itemprop='dateModified' datetime='2016-08-04T13:09:21Z' class='post-time'>
              August 4, 2016,  1:09pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>may be wrong in posting this, but this is how I understand it.</p>
<p>the entire game map data is stored in the cache located on the update server. the map data is only downloaded and stored to the users computer when the map data is loaded in game, this on demand downloads.</p>
<p>XTEA keys are not actual map data, but essentially key values to where that data is in the cache.</p>
<p>this is why the key generators are possible but not fully accurate.</p>
<p>[hr]<br>
again this is how I believe for it to work, so I may be wrong.</p>
      </div>

      <meta itemprop='headline' content='Multi-Revision Server Help'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Rodrigues.html'><span itemprop='name'>Rodrigues</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2014-05-21T20:46:00Z'>
            <time itemprop='dateModified' datetime='2016-08-04T13:09:27Z' class='post-time'>
              August 4, 2016,  1:09pm
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Much better - I have a better understanding now of XTEA keys so thanks. I’m still having trouble with this T3 error. Anybody know why the client is causing a T3 error?</p>
<p>[CODE]<br>
/*<br>
* (non-Javadoc)<br>
* <span class="mention">@see</span> java.lang.Runnable#run()<br>
*/<br>
<a class="mention" href="../../u/override.html">@Override</a><br>
public void run() {<br>
this.setOutStream(new IOPacketBuffer(new byte[Constants.BUFFER_SIZE]));<br>
this.getOutStream().setCurrentOffset(0);<br>
this.setInStream(new IOPacketBuffer(new byte[Constants.BUFFER_SIZE]));<br>
this.getInStream().setCurrentOffset(0);<br>
long serverSessionKey = ((long) (Math.random() * 99999999D) &lt;&lt; 32) + (long) (Math.random() * 99999999D);<br>
long clientSessionKey = 0;<br>
this.fillInStream(2);<br>
this.setLoginStage(LoginStage.FIRST);<br>
System.out.println(“First stage.”);<br>
if (this.getLoginStage() == LoginStage.FIRST) {<br>
System.out.println("First Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
this.setLoginStage(LoginStage.FOURTH);<br>
final byte opcodeUpdate = (byte) this.getInStream().readUnsignedByte();<br>
if (opcodeUpdate == 15) {<br>
System.out.println(“Opcode is 15!”);<br>
this.setLoginStage(LoginStage.SECOND);<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final int nameHash = this.getInStream().readUnsignedByte();<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
this.getOutStream().writeByte(0);<br>
this.getOutStream().writeQWord(0);<br>
this.flushOutStream();<br>
this.getInStream().setCurrentOffset(0);<br>
}<br>
}<br>
if (this.getLoginStage() == LoginStage.SECOND) {<br>
System.out.println(“Second stage.”);<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final short clientRevision = (short) this.getInStream().readUnsignedWord();<br>
try {<br>
this.getOutputStream().write(0);<br>
this.setLoginStage(LoginStage.THIRD);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
if (this.getLoginStage() == LoginStage.THIRD) {<br>
System.out.println(“Third stage.”);<br>
Main.getMain().setRevisionType(RevisionType.FIVE_SIXTY_TWO);<br>
System.out.println("Second Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
for (int i = 0; i &lt; Constants.UPDATE_KEYS.length; i++) {<br>
try {<br>
this.getOutputStream().write(Constants.UPDATE_KEYS[i]);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
}<br>
if (this.getLoginStage() == LoginStage.FOURTH) {<br>
System.out.println(“Fourth stage.”);<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Sending an unsigned byte!”);<br>
this.getInStream().readUnsignedByte();<br>
System.out.println(“Sending a for loop.”);<br>
for (int i = 0; i &lt; 9; i++) {<br>
try {<br>
this.getOutputStream().write(0);<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
}<br>
System.out.println(“Sent a for loop.”);<br>
}<br>
// this.getOutStream().writeByte(0);<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Sending server session key.”);<br>
this.getOutStream().writeQWord(serverSessionKey);<br>
}<br>
this.flushOutStream(); //////<br>
this.fillInStream(2); //////<br>
System.out.println(“Sending login type.”);<br>
final int loginType = this.getInStream().readUnsignedByte();<br>
if ((loginType != 16) &amp;&amp; (loginType != 18)) {<br>
System.out.println("Login type is not 16 and 18 - " + loginType);<br>
return;<br>
}<br>
int loginPacketSize = 0;<br>
int loginEncryptPacketSize = 0;<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Sending login packet size.”);<br>
loginPacketSize = this.getInStream().readUnsignedByte(); /////<br>
loginEncryptPacketSize = loginPacketSize - 40; /////<br>
System.out.println("Third Call: " + Main.getMain().getRevisionType().getRevisionID());<br>
this.fillInStream(loginPacketSize);<br>
System.out.println(“Sending magic numer.”);<br>
if (this.getInStream().readUnsignedByte() != 255) {<br>
System.out.println(“Magic number is not 255.”);<br>
return;<br>
}<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
this.getInStream().readSkip(2);<br>
}<br>
System.out.println(“Sending revision.”);<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
short revision = 0;<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
revision = (short) this.getInStream().readUnsignedWord();<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
revision = (short) this.getInStream().readDWord();<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Printing out memory.”);<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final int memory = this.getInStream().readUnsignedByte(); // memory.<br>
for (int i = 0; i &lt; 9; i++) {<br>
Integer.toHexString(this.getInStream().readDWord());<br>
}<br>
loginEncryptPacketSize–;<br>
int tmp = this.getInStream().readUnsignedByte();<br>
if (loginEncryptPacketSize != tmp) {<br>
return;<br>
}<br>
tmp = this.getInStream().readUnsignedByte();<br>
if (tmp != 10) {<br>
return;<br>
}<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
this.getInStream().readSkip(30);<br>
this.getInStream().readString();<br>
this.getInStream().readSkip(143);<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
System.out.println(“Printing out client and server session keys.”); // PRINT OUT FOR 317 ONLY? 562 ALSO?<br>
clientSessionKey = this.getInStream().readQWord(); // PRINT OUT FOR 317 ONLY? 562 ALSO?<br>
serverSessionKey = this.getInStream().readQWord(); // PRINT OUT FOR 317 ONLY? 562 ALSO?<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
<span class="mention">@SuppressWarnings</span>(“unused”)<br>
final int userID = this.getInStream().readDWord();<br>
}<br>
long username = 0;<br>
String name = null;<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
username = this.getInStream().readQWord();<br>
name = Text.fixName(Text.longToString(username)).trim();<br>
System.out.println("Name: " + name);<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
name = this.getInStream().readString();<br>
System.out.println("Name: " + name);<br>
}<br>
final String password = this.getInStream().readString();<br>
System.out.println("Password: " + password);<br>
System.out.println(“Printed out username, user id, and password.”);<br>
final int[] sessionKey = new int[4];<br>
sessionKey[0] = (int) (clientSessionKey &gt;&gt; 32);<br>
sessionKey[1] = (int) clientSessionKey;<br>
sessionKey[2] = (int) (serverSessionKey &gt;&gt; 32);<br>
sessionKey[3] = (int) serverSessionKey;<br>
for (int i = 0; i &lt; 4; i++) {<br>
Integer.toHexString(sessionKey[i]);<br>
}<br>
this.setInStreamDecryption(new ISAACRandomGen(sessionKey));<br>
for (byte i = 0; i &lt; 4; i++) {<br>
sessionKey[i] += 50;<br>
}<br>
for (byte i = 0; i &lt; 4; i++) {<br>
Integer.toHexString(sessionKey[i]);<br>
}<br>
this.setOutStreamDecryption(new ISAACRandomGen(sessionKey));<br>
this.getOutStream().setPacketEncryption(this.getOutStreamDecryption());<br>
final Entity player = new Player(name, null);<br>
try {<br>
System.out.println(“Sending return code of 2.”);<br>
this.getOutputStream().write(2); // return code<br>
if (player.getName().equals(“Josh”)) {<br>
System.out.println("Sending player rights of 2 for " + player.getName());<br>
this.getOutputStream().write(2); // rights<br>
} else {<br>
this.getOutputStream().write(0); // rights<br>
}<br>
this.getOutStream().writeByte(0);<br>
if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {<br>
System.out.println(“Sending login bytes.”);<br>
this.getOutputStream().write((byte) 0);<br>
this.getOutputStream().write((byte) 0);<br>
this.getOutputStream().write((byte) 0);<br>
this.getOutputStream().write((byte) 0);<br>
this.getOutputStream().write((byte) 0);<br>
this.getOutStream().writeWord(1); // slot (playerID - same thing?)<br>
this.getOutputStream().write((byte) 1);<br>
this.getOutputStream().write((byte) 1); // members<br>
this.flushOutStream();<br>
}<br>
} catch (final IOException ioe) {<br>
ioe.printStackTrace();<br>
}<br>
if (Main.getMain().getRevisionType() == RevisionType.THREE_ONE_SEVEN) {<br>
this.getOutStream().createFrame(249);<br>
this.getOutStream().writeByteA(1);<br>
this.getOutStream().writeWordA(1);<br>
this.getOutStream().createFrame(107);<br>
this.getOutStream().createFrameVarSize(253);<br>
this.getOutStream().writeString(“Welcome to RS3 Newstart!”);<br>
this.getOutStream().endFrameVarSize();<br>
this.flushOutStream();<br>
for (byte b = 0; b &lt; 25; b++) {<br>
this.setSkillLevel(b, (byte) 0, (byte) 0);<br>
}<br>
this.setChatOptions((byte) 0, (byte) 0, (byte) 0); // reset private messaging options<br>
final short[] tabInterfaces = {<br>
2423, 3917, 638, 3213, 1644, 5608, 1151, 1, 5065, 5715, // modern<br>
2449, 4445, 147, 6299<br>
};<br>
for (byte b = 0; b &lt; 14; b++) {<br>
this.setTabInterface(b, tabInterfaces[b]);<br>
}<br>
// this.setSidebarInterface(6, 12855); // ancient</p>
<pre><code>			// this.getPA().showInterface(3559);
			// this.newPlayer = false;
			this.showMenuOption(4, 0, "Trade With");
			this.showMenuOption(5, 0, "Follow");
			this.showMenuOption(6, 0, "Ban");
			this.showMenuOption(7, 0, "Kick");
			this.showMenuOption(8, 0, "Mute");

			this.getOutStream().createFrame(73);
			this.getOutStream().writeWordA(player.getLocation().getRegionX() + 6);
			this.getOutStream().writeWord(player.getLocation().getRegionY() + 6);
			this.flushOutStream();
			this.getOutStream().createFrame(81);
			this.getOutStream().writeWord(0); 		// placeholder for size of this packet.
			final int ofs = this.getOutStream().getCurrentOffset();
			this.getOutStream().initBitAccess();

			// update this player
			this.getOutStream().writeBits(1, 1);		// set to true if updating thisPlayer
			this.getOutStream().writeBits(2, 3);		// updateType - 3=jump to pos
			// the following applies to type 3 only
			this.getOutStream().writeBits(2, 0);		// height level (0-3)
			this.getOutStream().writeBits(1, 1);		// set to true, if discarding walking queue (after teleport e.g.)
			this.getOutStream().writeBits(1, 1);		// set to true, if this player is not in local list yet???
			this.getOutStream().writeBits(7, 0x20);	// y-position
			this.getOutStream().writeBits(7, 0x20);	// x-position

			// update other players...?!
			this.getOutStream().writeBits(8, 0);		// number of players to add

			// add new players???
			this.getOutStream().writeBits(11, 2047);	// magic EOF
			this.getOutStream().finishBitAccess();

			this.getOutStream().writeByte(0);		// ???? needed that to stop client from crashing

			this.getOutStream().writeFrameSizeWord(this.getOutStream().getCurrentOffset() - ofs);
		}
		if (Main.getMain().getRevisionType() == RevisionType.FIVE_SIXTY_TWO) {
			System.out.println("Sending map region packet.");
			this.getOutStream().createFrameVarSizeWord(76);
			this.getOutStream().writeWordBigEndianA(player.getLocation().getRegionX());
			this.getOutStream().writeWord(player.getLocation().getLocalY());
			this.getOutStream().writeByte(0);
			this.getOutStream().writeByteA(0);
			boolean forceRegion = (((player.getLocation().getRegionX() / 8) == 48) || ((player.getLocation().getRegionX() / 8) == 49)) &amp;&amp; ((player.getLocation().getRegionY() / 8) == 48);
			if (((player.getLocation().getRegionX() / 8) == 48) &amp;&amp; ((player.getLocation().getRegionY() / 8) == 148)) {
				forceRegion = true;
			}
			for (int xCalc = (player.getLocation().getRegionX() - 6) / 8; xCalc &lt;= ((player.getLocation().getRegionX() + 6) / 8); xCalc++) {
				for (int yCalc = (player.getLocation().getRegionY() - 6) / 8; yCalc &lt;= ((player.getLocation().getRegionY() + 6) / 8); yCalc++) {
					final int region = yCalc + (xCalc &lt;&lt; 8);
					final int[] mapData = Main.getMain().getMapData().getRegionData(region);
					if (forceRegion &amp;&amp; ((yCalc == 49) || (yCalc == 149) || (yCalc == 147) || (xCalc == 50) || ((xCalc == 49) &amp;&amp; (yCalc == 47)))) {
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
						this.getOutStream().writeDWord(-1);
					} else {
						this.getOutStream().writeDWord(mapData[0]);
						this.getOutStream().writeDWord(mapData[1]);
						this.getOutStream().writeDWord(mapData[2]);
						this.getOutStream().writeDWord(mapData[3]);
					}
				}
			}
			this.getOutStream().writeByteA(player.getLocation().getZ());
			this.getOutStream().writeWord(player.getLocation().getLocalX());
			this.getOutStream().writeWord(player.getLocation().getRegionY());
			this.getOutStream().endFrameVarSizeWord();

			this.getOutStream().createFrame(50);
			this.getOutStream().writeWordA(548);
			this.getOutStream().writeWord(0);
			this.getOutStream().writeByteS(0);

			this.getOutStream().createFrame(50);
			this.getOutStream().writeWordA(549);
			this.getOutStream().writeWord(0);
			this.getOutStream().writeByteS(0);
		}
		this.flushOutStream();
		this.setClientConnected(true);
		// new TaskSystem(player, this.getOutStream(), this.getOutputStream());
		final GameEngine gameEngine = new GameEngine((Player) player);
		gameEngine.getPlayerList().add((Player) player);
	}
}
</code></pre>
<p>[/CODE]</p>
      </div>

      <meta itemprop='headline' content='Multi-Revision Server Help'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/multi-revision-server-help/543237 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 02:00:36 GMT -->
</html>
