<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Npc conversations/interactions - fluent API</title>
    <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612</link>
    <description>Here are the beginnings of a fluent API I&#39;m designing:
[code]

        NpcTalkScriptBuilder builder = new NpcTalkScriptBuilder();
        NpcTalkScript script = builder.bindNpcs(95, 224, 268, 485, 540, 617, 792)
                .executeImmediately((context) -&gt; {
                    Player player = context.getPlayer();


                    player.setBusy(true);
                })
                .thenExecuteImmediately((ctx) -&gt; {
                    Player player = ctx.getPlayer();
                    Npc npc = ctx.getNpc();


                    player.informOfChatMessage(new ChatMessage(player, npc,
                            &quot;I&#39;d like to access my bank account please&quot;));
                })
                .thenExecuteDelayed(1500, (ctx) -&gt; {
                    Player player = ctx.getPlayer();
                    Npc npc = ctx.getNpc();


                    player.informOfNpcChatMessage(new ChatMessage(npc, player,
                            &quot;Certainly &quot; + (player.getAppearance().isMale() ? &quot;sir&quot; : &quot;miss&quot;)));
                })
                .thenExecuteDelayed(1500, (ctx) -&gt; {
                    Player player = ctx.getPlayer();


                    player.setBusy(false);
                    player.setAccessingBank(true);
                    Packets.showBank(player);
                })
                .finaliseScript();
[/code]


The idea, in a nutshell, is that the scripter is largely abstracted from things like nesting.
It&#39;s early days but this will be recursive, allowing for n-depth option selection. I just need to work out the details.


Thoughts on the use of a fluent API as opposed to the nested solution in RSCD (the worst of them seems to be org.rscdaemon.server.npchandler.Tanner) ??</description>
    
    <lastBuildDate>Fri, 06 Feb 2015 09:48:06 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Protosstribe object]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/protosstribe">@Protosstribe</a> wrote:</p>
          <blockquote>
              <p>An example demonstrating how one should be able to create a very simple quest in the future:</p>
<pre><code class="lang-auto">Script script = RSCScript.RSCBuilder.newInstance("Quest A").
    enter("Requirements").
        compare(DEFAULT_ATTACK_LEVEL, GREATER_THAN_OR_EQUAL_TO, 10, "Success", "Fail").
    leave().
    enter("Success").
        message("Welcome! You can now start the quest.").
        message("Congratulations! You have successfully finished Quest A!").
        set("Quest A", true).
        exit().
    leave().
    enter("Fail").
        message("You do not have the required skills to start this quest.").
    leave().
build();</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/29">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/29</link>
        <pubDate>Fri, 06 Feb 2015 09:48:06 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-29</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Rodgerwilco Rodgerwilco]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rodgerwilco">@Rodgerwilco</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="27" data-topic="549612">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/imthenull/40/1273_1.png" class="avatar"> imthenull:</div>
<blockquote>
<p>at this point why the hell wouldn’t use just use an actual scripting language???</p>
</blockquote>
</aside>
<p>cuz we are making moparscript, runescriptv2</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/28">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/28</link>
        <pubDate>Fri, 06 Feb 2015 02:05:12 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-28</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@imthenull imthenull]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/imthenull">@imthenull</a> wrote:</p>
          <blockquote>
              <p>at this point why the hell wouldn’t use just use an actual scripting language???</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/27">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/27</link>
        <pubDate>Thu, 05 Feb 2015 23:39:10 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-27</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Protosstribe object]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/protosstribe">@Protosstribe</a> wrote:</p>
          <blockquote>
              <p>I have uploaded my current version to GitHub:</p>
<p><a href="https://github.com/WavePropagation/org.macroing.actor" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/WavePropagation/org.macroing.actor</a></p>
<p>Edit: So far I support the following nodes:</p>
<ul>
<li>Condition.</li>
<li>Condition with ternary-style goto-branching.</li>
<li>Delay.</li>
<li>Enter new ‘label’ group.</li>
<li>Evaluate any scripting language (JSR 223), including Java via my Artifact API.</li>
<li>Exit the script.</li>
<li>Goto-branching.</li>
<li>Options with goto-branching - which waits until a choice is made.</li>
<li>Print.</li>
</ul>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/26">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/26</link>
        <pubDate>Thu, 05 Feb 2015 17:49:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-26</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@imthenull imthenull]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/imthenull">@imthenull</a> wrote:</p>
          <blockquote>
              <p>im working on a draft as well. this is pretty fun, actually.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/25">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/25</link>
        <pubDate>Thu, 05 Feb 2015 15:21:11 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-25</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Protosstribe object]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/protosstribe">@Protosstribe</a> wrote:</p>
          <blockquote>
              <p>Lothy: I’m currently working on the real API. Hopefully I’ll have something good at the end of the day. But I do have a rough idea how to handle branching.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/24">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/24</link>
        <pubDate>Thu, 05 Feb 2015 11:59:27 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-24</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@davidi2 Davidi2]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/davidi2">@davidi2</a> wrote:</p>
          <blockquote>
              <p>Considering he is relying on code formatting for readability, I would assume you could just do something like:</p>
<p><code>        Script.Builder.newInstance().
            onTalkTo(95, 224, 268, 485, 540, 617, 792).
                youSay("I'd like to access my bank account please").
                delay(1500L).
                npcSay((scriptContext) -&gt; {return "Certainly " + (scriptContext.you().isMale() ? "Sir" : "Miss");}).
                delay(1500L).
                openBank().
            done().
            onTalkTo(0).
                npcSay("Hello, World!").
                delay(1500L).
            done().
            onTalkTo(2516).
                npcSay("Choose an option").
                delay(1500L).
                optionChoice("Option 1" , "Option 2").
                  branch(). // creates a new builder? waits for input? perhaps takes an argument for the option the branch handler
                     npcSay("blah").
                  endBranch().
                  branch().
                      npcSay("blah2).
                  endBranch().
             done().
        build();</code></p>
<p>Creating an option choice node, etc. Im not sure how RSC differs from RS2 (I know RS2 doesnt really use delays though), but it was pretty easy to determine selected options from interface IDs so there’s an enum for them which would be useful as an argument.</p>
<p>One of things I dont like about objects solution is how builders can extend past one context, like I wouldn’t want to define multiple dialogues in one builder.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/23">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/23</link>
        <pubDate>Thu, 05 Feb 2015 08:51:10 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-23</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>I could, yeah. I’m actually going to sit on this for a day or two to see if Object replies re: branching in his solution.<br>
Frankly I like his solution so far, and I want to see how he solves conversation branching.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/22">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/22</link>
        <pubDate>Thu, 05 Feb 2015 07:50:34 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-22</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@HcoJustin HcoJustin]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/hcojustin">@HcoJustin</a> wrote:</p>
          <blockquote>
              <p>Can you make it so we can pass in the OptionHandle directly? Or at least a shorthand tag for lookup. It seems kinda excessive to pass in the full option text.</p>
<pre><code class="lang-auto"></code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/21">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/21</link>
        <pubDate>Thu, 05 Feb 2015 07:43:28 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-21</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>I like what you’ve done but there’s an important part missing: conversation branching.<br>
Your solution so far only caters for linear interactions.</p>
<p>Also, if you do post something that works, includes conversation branching, and fits within my desired constraints (i.e., must be non-blocking, robust, constant time execution of steps) then I’d love to include it in the git repository.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/20</link>
        <pubDate>Thu, 05 Feb 2015 06:58:08 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-20</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Rodgerwilco Rodgerwilco]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rodgerwilco">@Rodgerwilco</a> wrote:</p>
          <blockquote>
              <p>Lol shit, that’s sick.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/19</link>
        <pubDate>Wed, 04 Feb 2015 21:44:14 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-19</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Protosstribe object]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/protosstribe">@Protosstribe</a> wrote:</p>
          <blockquote>
              <p>Here is my approach to it:</p>
<p>Edit: It supports script stepping and delays, such that you can perform multiple player script updates in a short period of time on one thread. Simply just have a list of players, each one with an active script, then step once per player and game loop (or similar). All step updates should return immediately and not block. The delay step does just that, and the “stage” for the script is not updated until the time has passed. The ScriptContext class handles one Player only, so you need one ScriptContext instance per Player. It also contains the block delay timer and the current stage of the current Script.</p>
<p>Edit 2: I just made it in a few hours. So it’s far from finished at this time. Not even all methods are implemented and works in there. But I made it to see if I could use the same approach I used for a programming language I prototyped before. If anyone is interested in seeing more of this, I perhaps could make it into an actual API, that could be implemented by servers.</p>
<pre><code class="lang-auto">public final class Test {
    public static Script newScript() {
        return
        Script.Builder.newInstance().
            onTalkTo(95, 224, 268, 485, 540, 617, 792).
                youSay("I'd like to access my bank account please").
                delay(1500L).
                npcSay((scriptContext) -&gt; {return "Certainly " + (scriptContext.you().isMale() ? "Sir" : "Miss");}).
                delay(1500L).
                openBank().
            done().
            onTalkTo(0).
                npcSay("Hello, World!").
                delay(1500L).
            done().
        build();
    }
    
    public static void main(String[] args) {
        Player you = new You();
        
        ScriptContext scriptContext = ScriptContext.newInstance(you);
        
        Script script = newScript();
        script.execute(scriptContext);
    }
}</code></pre>
<pre><code class="lang-auto">public interface Message {
    String say(ScriptContext scriptContext);
}</code></pre>
<pre><code class="lang-auto">public interface Player {
    boolean isFemale();
    
    boolean isMale();
}</code></pre>
<pre><code class="lang-auto">public final class You implements Player {
    @Override
    public boolean isFemale() {
        return false;
    }
    
    @Override
    public boolean isMale() {
        return true;
    }
}</code></pre>
<pre><code class="lang-auto">import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

public final class ScriptContext {
    private final AtomicInteger stage = new AtomicInteger(0);
    private final AtomicLong timer = new AtomicLong(0L);
    private final Player you;
    
    private ScriptContext(final Player you) {
        this.you = you;
    }
    
    public boolean isTimerRunning() {
        return timer.get() != 0L;
    }
    
    public int getStage() {
        return stage.get();
    }
    
    public long elapsedTime() {
        return System.currentTimeMillis() - timer.get();
    }
    
    public Player you() {
        return you;
    }
    
    public void startTimer() {
        timer.set(System.currentTimeMillis());
    }
    
    public void stopTimer() {
        timer.set(0L);
    }
    
    public void updateStage() {
        stage.incrementAndGet();
        
        System.out.println("New stage: " + stage.get());
    }
    
    public static ScriptContext newInstance(final Player you) {
        return new ScriptContext(you);
    }
}</code></pre>
<pre><code class="lang-auto">import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;

public final class Script {
    private final List&lt;Node&gt; nodes = new ArrayList&lt;&gt;();
    private final Map&lt;Integer, Integer&gt; ids = new LinkedHashMap&lt;&gt;();
    
    private Script(final Builder builder) {
        this.nodes.addAll(builder.nodes);
        this.ids.putAll(builder.ids);
    }
    
    public boolean step(final ScriptContext scriptContext) {
        boolean hasStepped = false;
        
        Node node = doGetNodeForStage(scriptContext.getStage(), nodes);
        
        if(node != null) {
            hasStepped = node.step(scriptContext);
            
            if(hasStepped) {
                System.out.println(node.getClass().getSimpleName());
                
                scriptContext.updateStage();
            }
            
            hasStepped = true;
        } else {
            scriptContext.updateStage();
            
            hasStepped = false;
        }
        
        return hasStepped;
    }
    
    public void execute(final ScriptContext scriptContext) {
        while(step(scriptContext));
    }
    
    private Node doGetNodeForStage(final int stage, final List&lt;Node&gt; nodes) {
        for(Node node : nodes) {
            if(node.getStage() == stage) {
                return node;
            } else {
                node = doGetNodeForStage(stage, node);
                
                if(node != null) {
                    return node;
                }
            }
        }
        
        return null;
    }
    
    private Node doGetNodeForStage(final int stage, final Node node) {
        if(node.getStage() == stage) {
            return node;
        } else if(node instanceof ScriptNode) {
            ScriptNode scriptNode = ScriptNode.class.cast(node);
            
            List&lt;Node&gt; nodes = scriptNode.script.nodes;
            
            return doGetNodeForStage(stage, nodes);
        } else {
            return null;
        }
    }
    
    public static final class Builder {
        private final AtomicInteger nextStage = new AtomicInteger(0);
        private final Builder parent;
        private final List&lt;Node&gt; nodes = new ArrayList&lt;&gt;();
        private final Map&lt;Integer, Integer&gt; ids = new LinkedHashMap&lt;&gt;();
        
        private Builder(final Builder parent, final int... ids) {
            this.parent = parent;
            
            for(int id : ids) {
                this.ids.put(id, id);
            }
        }
        
        public Builder delay(long millis) {
            nodes.add(new DelayNode(doGetNextStage(), millis));
            
            return this;
        }
        
        public Builder done() {
            if(parent != null) {
                parent.nodes.add(new ScriptNode(doGetNextStage(), build()));
                
                return parent;
            } else {
                return this;
            }
        }
        
        public Builder npcSay(final Message message) {
            nodes.add(new NpcSayNode(doGetNextStage(), message));
            
            return this;
        }
        
        public Builder npcSay(final String message) {
            nodes.add(new NpcSayNode(doGetNextStage(), (scriptContext) -&gt; {return message;}));
            
            return this;
        }
        
        public Builder onTalkTo(final int... ids) {
            return new Builder(this, ids);
        }
        
        public Builder openBank() {
            return this;
        }
        
        public Builder youSay(final String message) {
            return this;
        }
        
        public Script build() {
            return new Script(this);
        }
        
        public static Builder newInstance() {
            return new Builder(null);
        }
        
        private int doGetNextStage() {
            if(parent != null) {
                return parent.doGetNextStage();
            } else {
                return nextStage.getAndIncrement();
            }
        }
    }
    
    private static final class DelayNode implements Node {
        private final int stage;
        private final long millis;
        
        private DelayNode(final int stage, final long millis) {
            this.stage = stage;
            this.millis = millis;
        }
        
        @Override
        public boolean step(final ScriptContext scriptContext) {
            boolean hasStepped = false;
            
            if(scriptContext.isTimerRunning()) {
                hasStepped = scriptContext.elapsedTime() &gt;= millis;
                
                if(hasStepped) {
                    scriptContext.stopTimer();
                }
            } else {
                scriptContext.startTimer();
            }
            
            return hasStepped;
        }
        
        @Override
        public int getStage() {
            return stage;
        }
    }
    
    private static interface Node {
        boolean step(final ScriptContext scriptContext);
        
        int getStage();
    }
    
    private static final class NpcSayNode implements Node {
        private final int stage;
        private final Message message;
        
        private NpcSayNode(final int stage, final Message message) {
            this.stage = stage;
            this.message = message;
        }
        
        @Override
        public boolean step(final ScriptContext scriptContext) {
            System.out.println("Npc says: " + message.say(scriptContext));
            
            return true;
        }
        
        @Override
        public int getStage() {
            return stage;
        }
    }
    
    private static final class ScriptNode implements Node {
        private final int stage;
        private final Script script;
        
        private ScriptNode(final int stage, final Script script) {
            this.stage = stage;
            this.script = script;
        }
        
        @Override
        public boolean step(final ScriptContext scriptContext) {
            return script.step(scriptContext);
        }
        
        @Override
        public int getStage() {
            return stage;
        }
    }
}</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/18</link>
        <pubDate>Wed, 04 Feb 2015 21:15:42 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-18</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Nothing1 -Nothing]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/nothing1">@Nothing1</a> wrote:</p>
          <blockquote>
              <p>Imo unless you can do line per action with a scripting system it is just as useless as RSCDs original, you could very easily shorten that Tanner script to about 30 lines with proper approach…good luck making a quest with this, I can guarantee you that it will be confusing as fuck to read.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/17</link>
        <pubDate>Wed, 04 Feb 2015 14:11:28 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-17</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@imthenull imthenull]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/imthenull">@imthenull</a> wrote:</p>
          <blockquote>
              <p>thanks. ill definitely check it out.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/16</link>
        <pubDate>Tue, 03 Feb 2015 21:02:47 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-16</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Jr_Mafio_865 Jr Mafio 865]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/jr_mafio_865">@Jr_Mafio_865</a> wrote:</p>
          <blockquote>
              <p>[quote=“Lothy, post:14, topic:549612”]I’m somewhat interested in running a server on a crowd sourcing basis. Basically if the server costs $500 a month to host then I seek $500 of donations. Some small reward or sign of recognition is provided, and once the $500 is hit nobody else can get donator status - it’s a first in first served kind of thing. When donations falls below the amount required to host the server then that’s the end of it.</p>
<p>I have already been approached about this.[/quote]<br>
That’s major man! Wish you luck. Will be watching this project closely <img src="https://forum.moparisthebest.com/images/emoji/twitter/wink.png?v=5" title=":wink:" class="emoji" alt=":wink:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/15</link>
        <pubDate>Tue, 03 Feb 2015 20:36:56 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-15</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>I’m somewhat interested in running a server on a crowd sourcing basis. Basically if the server costs $500 a month to host then I seek $500 of donations. Some small reward or sign of recognition is provided, and once the $500 is hit nobody else can get donator status - it’s a first in first served kind of thing. When donations falls below the amount required to host the server then that’s the end of it.</p>
<p>I have already been approached about this.</p>
<aside class="quote" data-post="12" data-topic="549612">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/imthenull/40/1273_1.png" class="avatar"> imthenull:</div>
<blockquote>
<p>Looks cool. This is definitely a step in the right direction as far as npc ai goes. When I get home I’d like to play around with this a little bit and see what I can do. Great job on the project Lothy.</p>
</blockquote>
</aside>
<p>I can push it to the github if you like. It’s just unfinished at the moment so I’ve held off on doing so.<br>
EDIT: Here’s the commit: <a href="https://github.com/Lothy/elysium-single-threaded/commit/ec07408d9ce0ae888f97e4e7a2a80857687fe32b" rel="nofollow noopener">https://github.com/Lothy/elysium-single-threaded/commit/ec07408d9ce0ae888f97e4e7a2a80857687fe32b</a><br>
The main package for this stuff is org.moparscape.elysium.script.npc. Be sure to check out the corresponding test class (NpcTalkScriptBuilderTests) for the method that demonstrates the banker and tanner scripts being built as showcased above.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/14</link>
        <pubDate>Tue, 03 Feb 2015 19:38:20 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-14</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Jr_Mafio_865 Jr Mafio 865]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/jr_mafio_865">@Jr_Mafio_865</a> wrote:</p>
          <blockquote>
              <p>Glad to see some development is still being done in this scene. Great job.<br>
Just wondering, do you have any plans with all the work you’re doing, is it actually going to be put up for people to play?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/13</link>
        <pubDate>Tue, 03 Feb 2015 18:05:03 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-13</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@imthenull imthenull]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/imthenull">@imthenull</a> wrote:</p>
          <blockquote>
              <p>Looks cool. This is definitely a step in the right direction as far as npc ai goes. When I get home I’d like to play around with this a little bit and see what I can do. Great job on the project Lothy.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/12</link>
        <pubDate>Tue, 03 Feb 2015 17:44:06 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-12</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@waj waj]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/waj">@waj</a> wrote:</p>
          <blockquote>
              <p>You may ignore Nothing, He seems mad that RSCRevolution is still failing after all the work he put in.</p>
<p>On topic: Looking good Lothy</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/11</link>
        <pubDate>Tue, 03 Feb 2015 16:38:53 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-11</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="9" data-topic="549612">
<div class="title">
<div class="quote-controls"></div>
 -Nothing:</div>
<blockquote>
<p>Too much typing, not that different from RSCD</p>
</blockquote>
</aside>
<p>The script itself can only be so concise. The one above can actually be written more concisely but I wanted to demonstrate it properly. There also needs to be divisions between the breaks/sleeps within the script because that’s the only way to achieve a pause while also not blocking the thread from doing other work.</p>
<p>EDIT:<br>
Went ahead and did some more work on it.<br>
Revised banker script:</p>
<pre><code class="lang-auto">
        NpcTalkScriptBuilder bankerScriptBuilder = new NpcTalkScriptBuilder();
        bankerScriptBuilder.bindNpcs(95, 224, 268, 485, 540, 617, 792);
        bankerScriptBuilder.executeImmediately((ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();


            p.setBusy(true);
            p.informOfChatMessage(new ChatMessage(p, n, "I'd like to access my bank account please"));
        });
        bankerScriptBuilder.thenExecuteDelayed(1500, (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();


            p.informOfNpcChatMessage(new ChatMessage(n, p,
                    "Certainly " + (p.getAppearance().isMale() ? "sir" : "miss")));
        });
        bankerScriptBuilder.thenExecuteDelayed(1500,
                (ctx) -&gt; {
                    Player p = ctx.getPlayer();


                    p.setBusy(false);
                    p.setAccessingBank(true);
                    Packets.showBank(p);
                });
        NpcTalkScript bankerScript = bankerScriptBuilder.finaliseScript();</code></pre>
<p>Tanner script:</p>
<pre><code class="lang-auto">
        NpcTalkScriptBuilder tannerScriptBuilder = new NpcTalkScriptBuilder();
        tannerScriptBuilder.bindNpcs(172);


        // Set the root options.
        tannerScriptBuilder.addOptions(
                "Can I buy some leather then?",
                "Here's some cow hides, can I buy some leather now?",
                "Leather is rather weak stuff");


        // Add script blocks to be executed before displaying the options.
        tannerScriptBuilder.executeImmediately((ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();


            p.setBusy(true);
            p.informOfNpcChatMessage(new ChatMessage(n, p, "Greeting friend. I'm a manufacturer of leather."));
        }).thenExecuteDelayed(1500, (ctx) -&gt; {
            Player p = ctx.getPlayer();
            p.setBusy(false);
            // Menu with options automatically sent at this point.
        });


        // Add script blocks to be executed if user selects option
        // "Can I buy some leather then?"
        tannerScriptBuilder.executeImmediately("Can I buy some leather then?", (ctx) -&gt; {
            Player p = ctx.getPlayer();
            if (p.isBusy()) throw new PlayerBusyException();


            Npc n = ctx.getNpc();
            String option = ctx.getOption();
            p.informOfChatMessage(new ChatMessage(p, n, option));
            p.setBusy(true);
        }).thenExecuteDelayed(1500, (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();
            p.informOfNpcChatMessage(new ChatMessage(n, p,
                    "I make leather from cow hides."));
        }).thenExecuteDelayed(1500, (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();
            p.informOfNpcChatMessage(new ChatMessage(n, p,
                    "Bring me some of them and a gold coin per hide."));
            n.unblock();
        });


        // Add script blocks to be executed if user selects option
        // "Here's some cow hides, can I buy some leather now?"
        tannerScriptBuilder.executeImmediately("Here's some cow hides, can I buy some leather now?",  (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();


            p.informOfNpcChatMessage(new ChatMessage(n, p, "Okay."));
            n.unblock();
        }).thenExecuteDelayedLoop(500, (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Inventory inventory = p.getInventory();
            InvItem lastHides = inventory.getLast(147);


            try {
                if (lastHides == null) {
                    Packets.sendMessage(p, "You have run out of cow hides.");
                    throw new NpcTalkInterruptedException();
                } else if (inventory.countById(10) &lt; 1) {
                    Packets.sendMessage(p, "You have run out of coins.");
                    throw new NpcTalkInterruptedException();
                } else if (inventory.remove(lastHides) &gt; -1 &amp;&amp; inventory.remove(10, 1) &gt; -1) {
                    inventory.add(new InvItem(148, 1));
                    Packets.sendInventory(p);
                } else {
                    throw new NpcTalkInterruptedException();
                }
            } finally {
                p.setBusy(false);
            }
        });


        // Add script blocks to be executed if user selects option
        // "Leather is rather weak stuff"
        tannerScriptBuilder.executeImmediately("Leather is rather weak stuff", (ctx) -&gt; {
            Player p = ctx.getPlayer();
            Npc n = ctx.getNpc();


            p.setBusy(false);
            n.unblock();
            p.informOfNpcChatMessage(new ChatMessage(n, p,
                    "Well yes, if all you're concerned about is how much it " +
                            "will protect you in a fight."));
        });


        NpcTalkScript tannerScript = tannerScriptBuilder.finaliseScript();</code></pre>
<p>Building the options tree (it goes to any depth):</p>
<pre><code class="lang-auto">
        NpcTalkScriptBuilder deeplyNestedOptions = new NpcTalkScriptBuilder();
        deeplyNestedOptions.bindNpcs(95, 224, 268, 485, 540, 617, 792);
        deeplyNestedOptions.addOptions("Option 1", "Option 2", "Option 3");
        deeplyNestedOptions.addChildOptions("Option 1", "O1C1", "O1C2");
        deeplyNestedOptions.addChildOptions("Option 2", "O2C1", "O2C2");
        deeplyNestedOptions.addChildOptions("O2C2", "O2C2-1", "O2C2-2");
        deeplyNestedOptions.addChildOptions("O2C2-1", "Lol", "Hi");
        deeplyNestedOptions.addChildOptions("Lol", "Noobs", "Okay guy");</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/10</link>
        <pubDate>Tue, 03 Feb 2015 06:13:44 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-10</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Nothing1 -Nothing]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/nothing1">@Nothing1</a> wrote:</p>
          <blockquote>
              <p>Too much typing, not that different from RSCD</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/9</link>
        <pubDate>Tue, 03 Feb 2015 05:26:12 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-9</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Rodgerwilco Rodgerwilco]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rodgerwilco">@Rodgerwilco</a> wrote:</p>
          <blockquote>
              <p>Well, I am just pointing out that the reason lack of development takes place is due to the 2-3 software developers around here are forced to write npcs and other small content which should be done by someone else. The RSC botting community had a few decent java script writers and people eventually got into it for their own benefits which eventually lead to text scripts lol.</p>
<p>I think the best bet would to have a community git or site where people can upload their npcs and other scripted events. There are hundreds of npcs and other entities that are options for future custom content.</p>
<p>I can’t provide any solution atm as I am currently looking into getting rid of the npchandler and looking to have my npc ai system handle all the chat, which I could just point it to the npchandler… hmm Even changing around how the client handles the options : <a href="http://i.gyazo.com/39590ea0e500d738bd58f39cea99b65d.png" rel="nofollow noopener">http://i.gyazo.com/39590ea0e500d738bd58f39cea99b65d.png</a> (which I will be adding the initial npc chat to box)</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/8</link>
        <pubDate>Mon, 02 Feb 2015 21:09:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-8</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@davidi2 Davidi2]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/davidi2">@davidi2</a> wrote:</p>
          <blockquote>
              <p>Thoughts about using something like groovy to reduce the number of lines needed to create things like this? Java 8 functional interfaces help, but assuming someone was using java 7 this would be a lot longer</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/7</link>
        <pubDate>Mon, 02 Feb 2015 20:39:06 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-7</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@Cres Cres]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/cres">@Cres</a> wrote:</p>
          <blockquote>
              <p>How about when a conversation branches through options?<br>
nvm* that’s your point 1*</p>
<p>seems nice nevertheless, would continue incase someone decides to make a server that focusses on design and efficiency.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/6</link>
        <pubDate>Mon, 02 Feb 2015 20:09:20 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-6</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
      <item>
        <title>Npc conversations/interactions - fluent API</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>NpcTalkScript is the result of the finaliseScript() function call. Until that point you’re actually working with an NpcTalkScriptBuilder.</p>
<p>Basically one function in NpcTalkScript - a function that takes an NpcTalkScriptContext (which tracks the player’s current progress through the conversation) and, based on that context, continues from the correct conversation stage.<br>
You can think of NpcTalkScriptBuilder as the means to create a finite state machine that represents a player to npc interaction, and NpcTalkScript as the handle.</p>
<p>As for NpcTalkScriptBuilder, it still needs functions to:</p>
<ol>
<li>Register options.</li>
<li>Register nested options.</li>
<li>Bind code to those options at whatever level (it’s going to be recursive so it can go to any conversation depth).<br>
And probably a few other things that I’ll discover when I try to port existing Npc talk handlers from RSCD. That’s the test at the moment - converting those handlers to use my fluent API, and being satisfied with the resulting code.</li>
</ol>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612/5</link>
        <pubDate>Mon, 02 Feb 2015 19:54:16 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-549612-5</guid>
        <source url="https://forum.moparisthebest.com/t/npc-conversations-interactions-fluent-api/549612.rss">Npc conversations/interactions - fluent API</source>
      </item>
  </channel>
</rss>
