<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/apollo-npc-updating-apollo/425319 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Aug 2019 16:36:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>[Apollo]NPC Updating[Apollo] - Runescape - moparisthebest.com</title>
    <meta name="description" content="This is NPC Updating. This does not include parsing values for spawning npcs into your server or making them walk or anything. :stuck_out_tongue: Just updating them is all. Follow the packaging in the top of the class to&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="425319.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;[Apollo]NPC Updating[Apollo]&#39;" href="425319.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/apollo-npc-updating-apollo/425319" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/apollo-npc-updating-apollo/425319" />
<meta property="og:title" content="[Apollo]NPC Updating[Apollo]" />
<meta name="twitter:title" content="[Apollo]NPC Updating[Apollo]" />
<meta property="og:description" content="This is NPC Updating. This does not include parsing values for spawning npcs into your server or making them walk or anything. 😛 Just updating them is all. Follow the packaging in the top of the class to figure out where to place them if you must.  [SIZE=18pt]Credits: Graham, Zuppers, Me[/SIZE]  First thing you will be updating are the Client Synchronizers. ParallelClientSynchronizer works well with computers that have multiple cores/processors. SequentialClientSynchronizer work..." />
<meta name="twitter:description" content="This is NPC Updating. This does not include parsing values for spawning npcs into your server or making them walk or anything. 😛 Just updating them is all. Follow the packaging in the top of the class to figure out where to place them if you must.  [SIZE=18pt]Credits: Graham, Zuppers, Me[/SIZE]  First thing you will be updating are the Client Synchronizers. ParallelClientSynchronizer works well with computers that have multiple cores/processors. SequentialClientSynchronizer work..." />
<meta property="article:published_time" content="2011-12-14T23:33:28+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="425319.html">[Apollo]NPC Updating[Apollo]</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/the_wanderer.html'><span itemprop='name'>the_wanderer</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:33:28Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:55Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>This is NPC Updating. This does not include parsing values for spawning npcs into your server or making them walk or anything. <img src="../../images/emoji/twitter/stuck_out_tongueae52.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"> Just updating them is all. Follow the packaging in the top of the class to figure out where to place them if you must.</p>
<p><span class="bbcode-b">[SIZE=18pt]Credits: Graham, Zuppers, Me[/SIZE]</span></p>
<p>First thing you will be updating are the Client Synchronizers. ParallelClientSynchronizer works well with computers that have multiple cores/processors. SequentialClientSynchronizer works well with computers that have a single core/processor. You can change which one your server uses in data/synchronizer.</p>
<p><span class="bbcode-b">[SIZE=14pt]ParallelClientSynchronizer:[/SIZE]</span></p>
<pre><code class="lang-auto"></code></pre>
<p><span class="bbcode-b">[SIZE=14pt]SequentialClientSynchronizer:[/SIZE]</span></p>
<p>[CODE=Java]package org.apollo.game.sync;</p>
<p>import org.apollo.game.GameService;<br>
import org.apollo.game.model.Player;<br>
import org.apollo.game.model.World;<br>
import org.apollo.game.sync.task.NPCSynchronizationTask;<br>
import org.apollo.game.sync.task.PlayerSynchronizationTask;<br>
import org.apollo.game.sync.task.PostPlayerSynchronizationTask;<br>
import org.apollo.game.sync.task.PrePlayerSynchronizationTask;<br>
import org.apollo.game.sync.task.SynchronizationTask;<br>
import org.apollo.util.CharacterRepository;</p>
<p>/**</p>
<ul>
<li>
<p>An implementation of {<a class="mention" href="../../u/link.html">@link</a> ClientSynchronizer} which runs in a single</p>
</li>
<li>
<p>thread (the {<a class="mention" href="../../u/link.html">@link</a> GameService} thread from which this is called). Each</p>
</li>
<li>
<p>client is processed sequentially. Therefore this class will work well on</p>
</li>
<li>
<p>machines with a single core/processor. The {<a class="mention" href="../../u/link.html">@link</a> ParallelClientSynchronizer}</p>
</li>
<li>
<p>will work better on machines with multiple cores/processors, however, both</p>
</li>
<li>
<p>classes will work.</p>
</li>
<li>
<p><span class="mention">@author</span> Graham<br>
*/<br>
public final class SequentialClientSynchronizer extends ClientSynchronizer {</p>
<p><a class="mention" href="../../u/override.html">@Override</a><br>
public void synchronize() {<br>
CharacterRepository players = World.getWorld().getPlayerRepository();</p>
<pre><code> for (Player player : players) {
     SynchronizationTask task = new PrePlayerSynchronizationTask(player);
     task.run();
 }

 for (Player player : players) {
     SynchronizationTask task = new PlayerSynchronizationTask(player);
     task.run();
 }

 for (Player player : players) {
     SynchronizationTask task = new PostPlayerSynchronizationTask(player);
     task.run();
 }
 for (Player player : players) {
         SynchronizationTask task = new NPCSynchronizationTask(player);
         task.run();
 }
</code></pre>
<p>}<br>
}[/CODE]</p>
</li>
</ul>
<p>Now with apollo’s packet system you have to have an event for every single packet that you read/write. It is very nice, just takes a little while to handle a packet. Here’s the packet and event.</p>
<p><span class="bbcode-b">[SIZE=14pt]NPCSynchronizationEventEncoder:[/SIZE]</span></p>
<p>[CODE=Java]package org.apollo.net.release.r317;</p>
<p>import org.apollo.game.event.impl.NPCSynchronizationEvent;<br>
import org.apollo.game.model.Animation;<br>
import org.apollo.game.model.Direction;<br>
import org.apollo.game.model.Graphic;<br>
import org.apollo.game.model.Position;<br>
import org.apollo.game.sync.block.AnimationBlock;<br>
import org.apollo.game.sync.block.GraphicBlock;<br>
import org.apollo.game.sync.block.SynchronizationBlockSet;<br>
import org.apollo.game.sync.block.TurnToPositionBlock;<br>
import org.apollo.game.sync.seg.AddNpcSegment;<br>
import org.apollo.game.sync.seg.MovementSegment;<br>
import org.apollo.game.sync.seg.SegmentType;<br>
import org.apollo.game.sync.seg.SynchronizationSegment;<br>
import org.apollo.net.codec.game.DataOrder;<br>
import org.apollo.net.codec.game.DataType;<br>
import org.apollo.net.codec.game.GamePacket;<br>
import org.apollo.net.codec.game.GamePacketBuilder;<br>
import org.apollo.net.meta.PacketType;<br>
import org.apollo.net.release.EventEncoder;<br>
/**</p>
<ul>
<li>
<p>NPCSynchronizationEventEncoder.java</p>
</li>
<li>
<p><span class="mention">@author</span> The Wanderer &amp; Zuppers<br>
*/<br>
public class NPCSynchronizationEventEncoder extends EventEncoder {</p>
<pre><code> @Override
 public GamePacket encode(NPCSynchronizationEvent event) {
         GamePacketBuilder builder = new GamePacketBuilder(65, PacketType.VARIABLE_SHORT);
         builder.switchToBitAccess();
        
         GamePacketBuilder blockBuilder = new GamePacketBuilder();

         /*
          * Write the current size of the npc list.
          */
         builder.putBits(8, event.getLocalNPCs());
        
         for (SynchronizationSegment segment : event.getSegments()) {
                 SegmentType type = segment.getType();
                 if(type == SegmentType.REMOVE_CHARACTER){
                     putRemoveCharacterUpdate(builder);
                 }
                 else if (type == SegmentType.ADD_CHARACTER) {
                         putAddCharacterUpdate((AddNpcSegment) segment, event, builder);
                         putBlocks(segment, blockBuilder);
                 } else {
                         putMovementUpdate(segment, event, builder);
                         putBlocks(segment, blockBuilder);
                 }
         }
        
         /*
          * Check if the update block isn't empty.
          */
         if(blockBuilder.getLength() &gt; 0) {
                 /*
                  * If so, put a flag indicating that an update block follows.
                  */
                 builder.putBits(14, 16383);
                 builder.switchToByteAccess();
                
                 /*
                  * And append the update block.
                  */
                 builder.putRawBuilder(blockBuilder);
         } else {
                 /*
                  * Terminate the packet normally.
                  */
                 builder.switchToByteAccess();
         }
        
         /*
          * Write the packet.
          */
         return builder.toGamePacket();
 }

 /**
  * Adds a new NPC.
  * @param packet The main packet.
  * @param npc The npc to add.
  */
 private void putAddCharacterUpdate(AddNpcSegment seg, NPCSynchronizationEvent event, GamePacketBuilder builder) {
         boolean updateRequired = seg.getBlockSet().size() &gt; 0;
         Position npc = seg.getPosition();
         Position other = event.getPosition();
         builder.putBits(14, seg.getIndex());
         builder.putBits(5, npc.getY() - other.getY());
         builder.putBits(5, npc.getX() - other.getX());
         builder.putBits(1, 0);
         builder.putBits(12, seg.getNpcid());
         builder.putBits(1, updateRequired ? 1 : 0);
 }

         /**
  * Puts a remove character update.
  * @param builder The builder.
  */
 private void putRemoveCharacterUpdate(GamePacketBuilder builder) {
         builder.putBits(1, 1);
         builder.putBits(2, 3);
 }

 /**
  * Update an NPC's movement.
  * @param packet The main packet.
  * @param npc The npc.
  */
 private void putMovementUpdate(SynchronizationSegment seg, NPCSynchronizationEvent event, GamePacketBuilder builder) {
         boolean updateRequired = seg.getBlockSet().size() &gt; 0;
         if (seg.getType() == SegmentType.RUN) {
                 Direction[] directions = ((MovementSegment) seg).getDirections();
                 builder.putBits(1, 1);
                 builder.putBits(2, 2);
                 builder.putBits(3, directions[0].toInteger());
                 builder.putBits(3, directions[1].toInteger());
                 builder.putBits(1, updateRequired ? 1 : 0);
         } else if (seg.getType() == SegmentType.WALK) {
                 Direction[] directions = ((MovementSegment) seg).getDirections();
                 builder.putBits(1, 1);
                 builder.putBits(2, 1);
                 builder.putBits(3, directions[0].toInteger());
                 builder.putBits(1, updateRequired ? 1 : 0);
         } else {
                 if (updateRequired) {
                         builder.putBits(1, 1);
                         builder.putBits(2, 0);
                 } else {
                         builder.putBits(1, 0);
                 }
         }
 }

 /**
  * Update an NPC.
  * @param packet The update block.
  * @param npc The npc.
  */
 private void putBlocks(SynchronizationSegment segment, GamePacketBuilder blockBuilder) {
         SynchronizationBlockSet blockSet = segment.getBlockSet();
         if (blockSet.size() &gt; 0) {
                 int mask = 0;
                 //TODO: masks Hit, Hit_2, Transform, Face Entity, and Forced Chat
                 if (blockSet.contains(GraphicBlock.class)) {
                         mask |= 0x80;
                 }

                 if (blockSet.contains(AnimationBlock.class)){
                         mask |= 0x10;
                 }

                 if (blockSet.contains(TurnToPositionBlock.class)) {
                         mask |= 0x4;
                 }
                
                 blockBuilder.put(DataType.BYTE, mask);

                 if (blockSet.contains(GraphicBlock.class)) {
                         putGraphicBlock(blockSet.get(GraphicBlock.class), blockBuilder);
                 }

                 if (blockSet.contains(AnimationBlock.class)) {
                         putAnimationBlock(blockSet.get(AnimationBlock.class), blockBuilder);
                 }

                 if (blockSet.contains(TurnToPositionBlock.class)) {
                         putTurnToPositionBlock(blockSet.get(TurnToPositionBlock.class), blockBuilder);
                 }
         }
 }

 /**
  * Puts a turn to position block into the specified builder.
  * @param block The block.
  * @param blockBuilder The builder.
  */
 private void putTurnToPositionBlock(TurnToPositionBlock block, GamePacketBuilder blockBuilder) {
         Position pos = block.getPosition();
         blockBuilder.put(DataType.SHORT, DataOrder.LITTLE, pos.getX() * 2 + 1);
         blockBuilder.put(DataType.SHORT, DataOrder.LITTLE, pos.getY() * 2 + 1);
 }

 /**
  * Puts a graphic block into the specified builder.
  * @param block The block.
  * @param blockBuilder The builder.
  */
 private void putGraphicBlock(GraphicBlock block, GamePacketBuilder blockBuilder) {
         Graphic graphic = block.getGraphic();
         blockBuilder.put(DataType.SHORT, graphic.getId());
         blockBuilder.put(DataType.INT, graphic.getDelay());
 }

 /**
  * Puts an animation block into the specified builder.
  * @param block The block.
  * @param blockBuilder The builder.
  */
 private void putAnimationBlock(AnimationBlock block, GamePacketBuilder blockBuilder) {
         Animation animation = block.getAnimation();
         blockBuilder.put(DataType.SHORT, DataOrder.LITTLE, animation.getId());
         blockBuilder.put(DataType.BYTE, animation.getDelay());
 }
</code></pre>
</li>
</ul>
<p>}[/CODE]</p>
<p><span class="bbcode-b">[SIZE=14pt]NPCSynchronizationEvent:[/SIZE]</span></p>
<p>[CODE=Java]package org.apollo.game.event.impl;</p>
<p>import java.util.List;<br>
import org.apollo.game.event.Event;<br>
import org.apollo.game.model.Position;<br>
import org.apollo.game.sync.seg.SynchronizationSegment;</p>
<p>/**</p>
<ul>
<li>
<p>NPCSynchronizationEvent.java</p>
</li>
<li>
<p><span class="mention">@author</span> The Wanderer &amp; Zuppers<br>
*/<br>
public class NPCSynchronizationEvent extends Event {</p>
<p>/**</p>
<ul>
<li>The npc’s position.<br>
*/<br>
private final Position position;</li>
</ul>
<p>/**</p>
<ul>
<li>The number of local players.<br>
*/<br>
private final int localNPCs;</li>
</ul>
<p>/**</p>
<ul>
<li>A list of segments.<br>
*/<br>
private final List segments;</li>
</ul>
<p>/**</p>
<ul>
<li>Creates the player synchronization event.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> position The player’s current position.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> localPlayers The number of local players.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> segments A list of segments.<br>
*/<br>
public NPCSynchronizationEvent(Position position, int localNPCs, List segments) {<br>
this.position = position;<br>
this.localNPCs = localNPCs;<br>
this.segments = segments;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the player’s position.</li>
<li>
<a class="mention" href="../../u/return.html">@return</a> The player’s position.<br>
*/<br>
public Position getPosition() {<br>
return position;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the number of local players.</li>
<li>
<a class="mention" href="../../u/return.html">@return</a> The number of local players.<br>
*/<br>
public int getLocalNPCs() {<br>
return localNPCs;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the synchronization segments.</li>
<li>
<a class="mention" href="../../u/return.html">@return</a> The segments.<br>
*/<br>
public List getSegments() {<br>
return segments;<br>
}<br>
}[/CODE]</li>
</ul>
</li>
</ul>
<p>Now for the task. First thing we need is to add a class for adding npc segments.</p>
<p><span class="bbcode-b">[SIZE=14pt]AddNpcSegment:[/SIZE]</span></p>
<p>[CODE=Java]package org.apollo.game.sync.seg;</p>
<p>import org.apollo.game.model.Position;<br>
import org.apollo.game.sync.block.SynchronizationBlockSet;</p>
<p>/**<br>
*</p>
<ul>
<li>
<p><span class="mention">@author</span> Zuppers<br>
*/<br>
public final class AddNpcSegment extends SynchronizationSegment {</p>
<p>/**</p>
<ul>
<li>The index.<br>
<em>/<br>
private final int index;<br>
/</em>*</li>
<li>The position.<br>
<em>/<br>
private final Position position;<br>
/</em>*</li>
<li>The npc id.<br>
*/<br>
private final int npcid;</li>
</ul>
<p>/**</p>
<ul>
<li>Creates the add character segment.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> blockSet The block set.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> index The characters’s index.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> position The position.<br>
*/<br>
public AddNpcSegment(SynchronizationBlockSet blockSet, int index, Position position, int npcid) {<br>
super(blockSet);<br>
this.index = index;<br>
this.position = position;<br>
this.npcid = npcid;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the character’s index.</li>
<li>
<a class="mention" href="../../u/return.html">@return</a> The index.<br>
*/<br>
public int getIndex() {<br>
return index;<br>
}</li>
</ul>
<p>/**</p>
<ul>
<li>Gets the position.</li>
<li>
<a class="mention" href="../../u/return.html">@return</a> The position.<br>
*/<br>
public Position getPosition() {<br>
return position;<br>
}</li>
</ul>
<p><a class="mention" href="../../u/override.html">@Override</a><br>
public SegmentType getType() {<br>
return SegmentType.ADD_CHARACTER;<br>
}</p>
<p>/**</p>
<ul>
<li>
<a class="mention" href="../../u/return.html">@return</a> the npcid<br>
*/<br>
public int getNpcid() {<br>
return npcid;<br>
}<br>
}[/CODE]</li>
</ul>
</li>
</ul>
<p>Aaaand now the task.</p>
<p><span class="bbcode-b">[SIZE=14pt]NPCSynchronizationTask:[/SIZE]</span></p>
<p>[CODE=Java]package org.apollo.game.sync.task;</p>
<p>import java.util.ArrayList;<br>
import java.util.Iterator;<br>
import java.util.List;<br>
import org.apollo.game.event.impl.NPCSynchronizationEvent;<br>
import org.apollo.game.model.NPC;<br>
import org.apollo.game.model.Player;<br>
import org.apollo.game.model.World;<br>
import org.apollo.game.sync.block.SynchronizationBlockSet;<br>
import org.apollo.game.sync.seg.AddNpcSegment;<br>
import org.apollo.game.sync.seg.MovementSegment;<br>
import org.apollo.game.sync.seg.RemoveCharacterSegment;<br>
import org.apollo.game.sync.seg.SynchronizationSegment;<br>
import org.apollo.util.CharacterRepository;</p>
<p>/**</p>
<ul>
<li>
<p>NPCSynchronizzationTask.java</p>
</li>
<li>
<p><span class="mention">@author</span> The Wanderer &amp; Zuppers<br>
*/<br>
public class NPCSynchronizationTask extends SynchronizationTask {</p>
<p>private static final int NEW_NPCS_PER_CYCLE = 20;</p>
<p>/**</p>
<ul>
<li>The player.<br>
*/<br>
private final Player player;</li>
</ul>
<p>/**</p>
<ul>
<li>Creates the {<a class="mention" href="../../u/link.html">@link</a> NPCSynchronizationTask} for the specified player.</li>
<li>
<a class="mention" href="../../u/param.html">@param</a> player The player.<br>
*/<br>
public NPCSynchronizationTask(Player player) {<br>
this.player = player;<br>
}</li>
</ul>
<p><a class="mention" href="../../u/override.html">@Override</a><br>
public void run() {<br>
SynchronizationBlockSet blockSet = player.getBlockSet();<br>
List localNPCs = player.getLocalNPCList();<br>
int oldLocalPlayers = localNPCs.size();<br>
List segments = new ArrayList();</p>
<pre><code> for (Iterator&lt;NPC&gt; it = localNPCs.iterator(); it.hasNext();) {
     NPC n = it.next();
     if (!n.isActive() || n.isTeleporting() || n.getPosition().getLongestDelta(player.getPosition()) &gt; player.getViewingDistance()) {
         it.remove();
         segments.add(new RemoveCharacterSegment());
     } else {
         segments.add(new MovementSegment(n.getBlockSet(), n.getDirections()));
     }
 }

 int added = 0;

 CharacterRepository&lt;NPC&gt; repository = World.getWorld().getNPCRepository();
 for (Iterator&lt;NPC&gt; it = repository.iterator(); it.hasNext();) {
     NPC n = it.next();
     if (localNPCs.size() &gt;= 255) {//this should never happen? who would put 255+ npcs in the same spot?

         break;
     } else if (added &gt;= NEW_NPCS_PER_CYCLE) {
         break;
     }
     if (n.getPosition().isWithinDistance(player.getPosition(), player.getViewingDistance()) &amp;&amp; !localNPCs.contains(n)) {
         localNPCs.add(n);
         added++;
         blockSet = n.getBlockSet();
         segments.add(new AddNpcSegment(blockSet, n.getIndex(), n.getPosition(),n.getDefinition().getId()));
     }

 }
 NPCSynchronizationEvent event = new NPCSynchronizationEvent(player.getPosition(), oldLocalPlayers, segments);
 player.send(event);
</code></pre>
<p>}<br>
}[/CODE]</p>
</li>
</ul>
<p>Also, don’t forgot to register the packet in Release317!</p>
<pre><code class="lang-auto"></code></pre>
<p>Hope this will help anyone trying to add npc support to Apollo and help further the usage of Apollo! <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Some of my methods may be a little bit different than yours in say the World class. If you have any issues ask away.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Uncalled.html'><span itemprop='name'>Uncalled</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:37:03Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:55Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Great tutorial, I like.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:39:16Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:55Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Awesome, glad that you managed to fix it.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/the_wanderer.html'><span itemprop='name'>the_wanderer</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:41:22Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:55Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Thank zuppers. Probably would of taken me another 2 days to fix it. <img src="../../images/emoji/twitter/stuck_out_tongueae52.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/m1lkman.html'><span itemprop='name'>m1lkman</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:48:47Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:56Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Who zuppers is?</p>
<p>Also, this is a snippet. Brilliant job AJ</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/zuppers.html'><span itemprop='name'>zuppers</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-14T23:50:03Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:56Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#6</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>It’s still missing some update blocks but hopefully this will be enough to get people started. For anyone attempting this remember you need to create your own npc class and add a new character repository for npcs in org.apollo.game.model.World.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/the_wanderer.html'><span itemprop='name'>the_wanderer</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-15T00:05:29Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:58Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#7</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote quote-modified" data-post="6" data-topic="425319">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forum.moparisthebest.com/zuppers/40/10929_1.png" class="avatar"> zuppers:</div>
<blockquote>
<p>It’s still missing some update blocks but hopefully this will be enough to get people started. For anyone attempting this remember you need to create your own npc class and add a new character repository for npcs in org.apollo.game.model.World.</p>
</blockquote>
</aside>
<p>Yeah, I think I added a todo comment with some update blocks that were left out.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/asshole_rule.html'><span itemprop='name'>asshole_rule</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-15T00:08:36Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:28:58Z' class='post-time'>
              August 2, 2016,  2:28pm
            </time>
        <span itemprop='position'>#8</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Great job on this.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-15T01:14:31Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:29:03Z' class='post-time'>
              August 2, 2016,  2:29pm
            </time>
        <span itemprop='position'>#9</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>[quote=“The Wanderer, post:7, topic:425319”][quote author=zuppers link=topic=527980.msg3849534#msg3849534 date=1323906603]<br>
It’s still missing some update blocks but hopefully this will be enough to get people started. For anyone attempting this remember you need to create your own npc class and add a new character repository for npcs in org.apollo.game.model.World.<br>
[/quote]<br>
Yeah, I think I added a todo comment with some update blocks that were left out.[/quote]</p>
<p>I can grab the other ones for you and message you them and the blocks that you have to send. Just remind me later.</p>
      </div>

      <meta itemprop='headline' content='[Apollo]NPC Updating[Apollo]'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/apollo-npc-updating-apollo/425319 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 06 Aug 2019 16:36:34 GMT -->
</html>
