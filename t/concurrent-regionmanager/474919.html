<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/concurrent-regionmanager/474919 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 11:36:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Concurrent RegionManager - Runescape - moparisthebest.com</title>
    <meta name="description" content="Wrote an implementation that uses a ConcurrentMap as the underlying data structure (instead of an array). Anyway, this uses a ConcurrentHashMap, so all of the operations are either O(1) time complexity or close to it. 

U&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="474919.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Concurrent RegionManager&#39;" href="474919.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/concurrent-regionmanager/474919" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/concurrent-regionmanager/474919" />
<meta property="og:title" content="Concurrent RegionManager" />
<meta name="twitter:title" content="Concurrent RegionManager" />
<meta property="og:description" content="Wrote an implementation that uses a ConcurrentMap as the underlying data structure (instead of an array).  Anyway, this uses a ConcurrentHashMap, so all of the operations are either O(1) time complexity or close to it.  Untested btw, but the key algorithm should work just fine (and the viewable regions part was adapted from existing code).  import java.util.ArrayList; import java.util.List; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.ConcurrentMap;  /**  * Allows c..." />
<meta name="twitter:description" content="Wrote an implementation that uses a ConcurrentMap as the underlying data structure (instead of an array).  Anyway, this uses a ConcurrentHashMap, so all of the operations are either O(1) time complexity or close to it.  Untested btw, but the key algorithm should work just fine (and the viewable regions part was adapted from existing code).  import java.util.ArrayList; import java.util.List; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.ConcurrentMap;  /**  * Allows c..." />
<meta property="article:published_time" content="2012-12-21T02:24:04+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="474919.html">Concurrent RegionManager</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/lothy.html'><span itemprop='name'>lothy</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2012-12-21T02:24:04Z'>
            <time itemprop='dateModified' datetime='2016-08-04T01:49:37Z' class='post-time'>
              August 4, 2016,  1:49am
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Wrote an implementation that uses a ConcurrentMap as the underlying data structure (instead of an array).<br>
Anyway, this uses a ConcurrentHashMap, so all of the operations are either O(1) time complexity or close to it.</p>
<p>Untested btw, but the key algorithm should work just fine (and the viewable regions part was adapted from existing code).</p>
<pre><code class="lang-auto">import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

/**
 * Allows concurrent region management.
 * Lazy loading is used for region creation. In other words, a region is not
 * created until the time that it is needed.
 * It should be noted that there is currently no mechanism to remove regions
 * that have seen extended disuse.
 *
 * @author Lothy
 */
public class RegionManager {

    /**
     * Singleton instance of the RegionManager.
     */
    private static final RegionManager INSTANCE = new RegionManager();

    /**
     * The region size. Note that this should be an even number.
     */
    public static final int REGION_SIZE = 32;
    /**
     * The halfway point in the region. This calculation relies on
     * the region size being an even number.
     */
    private static final int LOWER_BOUND = (REGION_SIZE / 2) - 1;

    /**
     * The underlying map of regions.
     */
    private final ConcurrentMap&lt;Integer, Region&gt; regions =
            new ConcurrentHashMap&lt;Integer, Region&gt;();

    public RegionManager getInstance() {
        return INSTANCE;
    }

    /**
     * Given an pair of x and y co-ordinates, this method will create the
     * key value that can be used to access the correct region.
     *
     * @param x The absolute x ordinate
     * @param y The absolute y ordinate
     * @return
     */
    private int getKey( int x, int y ) {
        int keyX = (x - (x % REGION_SIZE)) / REGION_SIZE;
        int keyY = (y - (y % REGION_SIZE)) / REGION_SIZE;
        return (keyX &lt;&lt; 16) | keyY;
    }

    /**
     * Adds a new region for the specified key, and returns it.
     * If another thread beats this thread to creating a new region for the
     * specified key then the already created region will be returned.
     *
     * @param key The key to map a new region to
     * @return The region mapped to the specified key
     */
    private Region addNewRegion( int key ) {
        Region r = new Region();
        Region result = regions.putIfAbsent(key, r);

        // If the result is null, we know the new region was added and should
        // return it.
        // Otherwise, another thread has already added a new region and their
        // newly added region should be returned instead.
        return result != null ? result : r;
    }

    /**
     * Returns a region for the given keyX and keyY values.
     * The keyX and keyY values are calculated as follows:
     * keyX = (x - (x % REGION_SIZE)) / REGION_SIZE;
     * keyY = (y - (y % REGION_SIZE)) / REGION_SIZE;
     * &lt;p/&gt;
     * Negative keyX and keyY values are considered invalid.
     * If negative values are specified, this method returns null.
     *
     * @param keyX The x portion of the region key
     * @param keyY The y mapping of the region key
     * @return The region for the resulting key, or null if the specified
     *         key arguments are negative.
     */
    private Region getRegionByKey( int keyX, int keyY ) {
        if (keyX &lt; 0 || keyY &lt; 0) return null;

        int key = (keyX &lt;&lt; 16) | keyY;
        return getRegionByKey(key);
    }

    /**
     * Returns the region that the specified key is mapped to.
     * If the key currently has no region mapped to it, a new region is created.
     *
     * @param key The key to obtain the region for
     * @return The region that the specified key maps to
     */
    private Region getRegionByKey( int key ) {
        Region r = regions.get(key);
        if (r == null) {
            return addNewRegion(key);
        }
        return r;
    }

    /**
     * Returns the region that the specified cartesian point is located within.
     *
     * @param p The cartesian point
     * @return The region that the specified point is located within
     */
    public Region getRegion( Point p ) {
        return getRegion(p.getX(), p.getY());
    }

    /**
     * Returns the region that the specified co-ordinates are located within.
     *
     * @param x The absolute x ordinate
     * @param y The absolute y ordinate
     * @return The region that the specified co-ordinates are located within
     */
    public Region getRegion( int x, int y ) {
        if (x &lt; 0 || y &lt; 0) {
            throw new IllegalArgumentException(
                    "Non-negative co-ordinates: " + x + ", " + y);
        }

        int key = getKey(x, y);
        return getRegionByKey(key);
    }

    /**
     * Returns the list of regions that are viewable by the specified
     * cartesian point.
     * The list returned includes the region that the specified point is
     * located within.
     * &lt;p/&gt;
     * Additionally, three other regions are included. These regions are
     * determined based on the location of the specified point within
     * the region.
     *
     * @param p The cartesian point
     * @return A list of regions that are viewable by the specified point
     */
    public List&lt;Region&gt; getViewableRegions( Point p ) {
        return getViewableRegions(p.getX(), p.getY());
    }

    public List&lt;Region&gt; getViewableRegions( int x, int y ) {
        if (x &lt; 0 || y &lt; 0) {
            throw new IllegalArgumentException(
                    "Non-negative co-ordinates: " + x + ", " + y);
        }

        List&lt;Region&gt; viewable = new ArrayList&lt;Region&gt;(10);
        int keyX = (x - (x % REGION_SIZE)) / REGION_SIZE;
        int keyY = (y - (y % REGION_SIZE)) / REGION_SIZE;
        int curKey = (keyX &lt;&lt; 16) | keyY;

        int relX = x % REGION_SIZE;
        int relY = y % REGION_SIZE;

        // Add the current region.
        Region current = getRegionByKey(curKey);
        viewable.add(current);

        Region r;
        if (relX &lt;= LOWER_BOUND) {
            if (relY &lt;= LOWER_BOUND) {
                r = getRegionByKey(keyX - 1, keyY);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX - 1, keyY - 1);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX, keyY - 1);
                if (r != null) viewable.add(r);
            } else {
                r = getRegionByKey(keyX - 1, keyY);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX - 1, keyY + 1);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX, keyY + 1);
                if (r != null) viewable.add(r);
            }
        } else {
            if (relY &lt;= LOWER_BOUND) {
                r = getRegionByKey(keyX + 1, keyY);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX + 1, keyY - 1);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX, keyY - 1);
                if (r != null) viewable.add(r);
            } else {
                r = getRegionByKey(keyX + 1, keyY);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX + 1, keyY + 1);
                if (r != null) viewable.add(r);

                r = getRegionByKey(keyX, keyY + 1);
                if (r != null) viewable.add(r);
            }
        }

        return viewable;
    }
}</code></pre>
      </div>

      <meta itemprop='headline' content='Concurrent RegionManager'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/imthenull.html'><span itemprop='name'>imthenull</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2012-12-21T02:58:19Z'>
            <time itemprop='dateModified' datetime='2016-08-04T01:49:38Z' class='post-time'>
              August 4, 2016,  1:49am
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Interesting, thanks Lothy</p>
      </div>

      <meta itemprop='headline' content='Concurrent RegionManager'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/concurrent-regionmanager/474919 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 11:36:34 GMT -->
</html>
