<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>BCEL: Java&#39;s Swiss Army knife</title>
    <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971</link>
    <description>For use with a brain and a ClassLoader

This was several more specific methods, but I found myself writing basically the same thing again. I parameterized the pattern and the target method - the sky&#39;s the limit...

[code]
    public MethodGen deleteCodeBlockPattern(String pattern, MethodGen mg) {
        InstructionList il = mg.getInstructionList();
        InstructionFinder finder = new InstructionFinder(il);
        InstructionHandle next = null;

        for(java.util.Iterator i = finder.search(pattern); i.hasNext(); ) {
            InstructionHandle[] match = (InstructionHandle[])i.next();
            InstructionHandle   first = match[0];
            InstructionHandle   last  = match[match.length - 1];

            if((next = last.getNext()) == null)
	            break;

            try {
            	ConstantPoolGen cpg = mg.getConstantPool();
				int idxPrintln = cpg.lookupMethodref(&quot;java.io.PrintStream&quot;,&quot;println&quot;,&quot;(Ljava/lang/String;)V&quot;);
				int idxSystemout = cpg.lookupFieldref(&quot;java.lang.System&quot;,&quot;out&quot;,&quot;Ljava/io/PrintStream;&quot;);
				il.insert(new INVOKEVIRTUAL(idxPrintln));
				il.insert(new PUSH(cpg, &quot;Code has been removed here.&quot;));
				il.insert(new GETSTATIC(idxSystemout));
	            il.delete(first, last);
            } catch(TargetLostException e) {
	            InstructionHandle[] targets = e.getTargets();
	            for(int c = 0; c &lt; targets.length; c++) {
	                InstructionTargeter[] targeters = targets[c].getTargeters();

	                for(int j = 0; j &lt; targeters.length; j++)
	                    targeters[j].updateTarget(targets[c], next);
	            }
            }
        }

        return mg;
    }[/code]

A useful pattern for those who can&#39;t be bothered to write an applet loader:
[code]
&quot;ALOAD GETFIELD IFNULL ALOAD GETFIELD SIPUSH SIPUSH &quot; +
&quot;INVOKEVIRTUAL ALOAD GETFIELD (LDC | LDC_W) INVOKEVIRTUAL&quot;;
[/code]</description>
    
    <lastBuildDate>Wed, 26 Apr 2006 06:08:53 +0000</lastBuildDate>
    <category>Community Inside Talk</category>
    <atom:link href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@eXemplar eXemplar]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/exemplar">@eXemplar</a> wrote:</p>
          <blockquote>
              <p>CFParse comes with some command line tools, dis and asm, which is all I use from that package.</p>

<p>Alternatively, you could use <a href="http://java.sun.com/j2se/1.5.0/docs/tooldocs/solaris/javap.html" rel="nofollow">http://java.sun.com/j2se/1.5.0/docs/tooldocs/solaris/javap.html</a> if you just want to view the bytecode.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/13</link>
        <pubDate>Wed, 26 Apr 2006 06:08:53 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-13</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@BobDole81 BobDole81]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/bobdole81">@BobDole81</a> wrote:</p>
          <blockquote>
              <p>You can also use the CCK (Class Construction Kit), which is basically just a gui for BCEL - it's pretty good imo, but I totally forget how CFParse is now so I can't compare.</p>

<p>Krichevskoy: Nice work on that...looks great.  I can't say I'm doing very much work with bytecode really rigth now, but this might come in useful <img src="//forum.moparisthebest.mopar/images/emoji/emoji_one/slight_smile.png?v=3" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/12</link>
        <pubDate>Tue, 25 Apr 2006 12:25:46 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-12</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Pwnd Pwnd]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pwnd">@Pwnd</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="9" data-topic="971"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forum.moparisthebest.mopar/letter_avatar_proxy/v2/letter/k/eada6e/40.png" class="avatar">kmb:</div>
<blockquote><p>CFParse.</p></blockquote></aside>

<p>Hah, I couldn't find that anywhere.</p>

<p>Thank you sdouble &lt;3</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/11</link>
        <pubDate>Thu, 06 Apr 2006 14:53:16 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-11</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@sdouble sdouble]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sdouble">@sdouble</a> wrote:</p>
          <blockquote>
              <p><a href="http://rapidshare.de/files/17342834/CFParse116.exe.html" class="onebox" target="_blank" rel="nofollow">http://rapidshare.de/files/17342834/CFParse116.exe.html</a></p>

<p>If you want it.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/10</link>
        <pubDate>Thu, 06 Apr 2006 14:50:50 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-10</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@kmb Kmb]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/kmb">@kmb</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="8" data-topic="971"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/moparisthebest/40/30_1.png" class="avatar">moparisthebest:</div>
<blockquote><p>well what I was asking is what program you used to view the bytecode, I cant seem to find one <img src="https://forum.moparisthebest.com/images/emoji/emoji_one/confused.png?v=3" title=":confused:" class="emoji" alt=":confused:"></p></blockquote></aside>

<p>CFParse.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/9</link>
        <pubDate>Thu, 06 Apr 2006 13:04:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-9</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@moparisthebest Moparisthebest]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/moparisthebest">@moparisthebest</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="7" data-topic="971"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forum.moparisthebest.mopar/letter_avatar_proxy/v2/letter/k/96bed5/40.png" class="avatar">Krichevskoy:</div>
<blockquote><p>[quote author=moparisthebest link=topic=877.msg9684#msg9684 date=1144211748]<br>so how do you find these pattern strings?, I dont know of anything that I can "view" bytecode with to look for things to remove <img src="//forum.moparisthebest.mopar/images/emoji/emoji_one/confused.png?v=3" title=":confused:" class="emoji" alt=":confused:"></p></blockquote></aside>

<p>My basic method is to use the source for analysis and such (in this case, finding something I want gone) and then looking for the equivalent bytecode using jackie (if I can't just think of it).[/quote]</p>

<p>well what I was asking is what program you used to view the bytecode, I cant seem to find one <img src="//forum.moparisthebest.mopar/images/emoji/emoji_one/confused.png?v=3" title=":confused:" class="emoji" alt=":confused:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/8</link>
        <pubDate>Wed, 05 Apr 2006 23:14:01 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-8</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Krichevskoy Krichevskoy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/krichevskoy">@Krichevskoy</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="6" data-topic="971"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/moparisthebest/40/30_1.png" class="avatar">moparisthebest:</div>
<blockquote><p>so how do you find these pattern strings?, I dont know of anything that I can "view" bytecode with to look for things to remove <img src="https://forum.moparisthebest.com/images/emoji/emoji_one/confused.png?v=3" title=":confused:" class="emoji" alt=":confused:"></p></blockquote></aside>

<p>My basic method is to use the source for analysis and such (in this case, finding something I want gone) and then looking for the equivalent bytecode using jackie (if I can't just think of it).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/7</link>
        <pubDate>Wed, 05 Apr 2006 21:23:00 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-7</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@moparisthebest Moparisthebest]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/moparisthebest">@moparisthebest</a> wrote:</p>
          <blockquote>
              <p>so how do you find these pattern strings?, I dont know of anything that I can "view" bytecode with to look for things to remove <img src="//forum.moparisthebest.mopar/images/emoji/emoji_one/confused.png?v=3" title=":confused:" class="emoji" alt=":confused:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/6</link>
        <pubDate>Wed, 05 Apr 2006 04:35:48 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-6</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Krichevskoy Krichevskoy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/krichevskoy">@Krichevskoy</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="3" data-topic="971"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forum.moparisthebest.mopar/letter_avatar_proxy/v2/letter/w/c2a13f/40.png" class="avatar">Wenakko:</div>
<blockquote><p>Can you clear up a bit what is this?</p></blockquote></aside>

<p>You give it a pattern string and a BCEL MethodGen object. It searches the instruction list of that method for a matches to the pattern and deletes them. In the case of that sample, it deletes the "frame trap" packet instructions. Combined with a class loader that is processing each class as it loads, this sort of thing allows you to edit the client without bothering with deobfuscation or any method of editing the file itself.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/5</link>
        <pubDate>Wed, 05 Apr 2006 00:58:19 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-5</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Pwnd Pwnd]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pwnd">@Pwnd</a> wrote:</p>
          <blockquote>
              <p>It's for use with a classloader.<br>First off it'd be good to know what BCEL is.  </p>

<p>If you do, great!  I'm not this far yet; I'm still regexing;P</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/4</link>
        <pubDate>Mon, 03 Apr 2006 14:25:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-4</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Wenakko Wenakko]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/wenakko">@Wenakko</a> wrote:</p>
          <blockquote>
              <p>Can you clear up a bit what is this?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/3</link>
        <pubDate>Mon, 03 Apr 2006 12:03:16 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-3</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Pwnd Pwnd]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pwnd">@Pwnd</a> wrote:</p>
          <blockquote>
              <p>Thank you &lt;3</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/2</link>
        <pubDate>Sat, 01 Apr 2006 22:23:45 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-2</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
      <item>
        <title>BCEL: Java&#39;s Swiss Army knife</title>
        <dc:creator><![CDATA[@Krichevskoy Krichevskoy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/krichevskoy">@Krichevskoy</a> wrote:</p>
          <blockquote>
              <p>For use with a brain and a ClassLoader</p>

<p>This was several more specific methods, but I found myself writing basically the same thing again. I parameterized the pattern and the target method - the sky's the limit...</p>

<p></p><pre><code class="lang-auto">    public MethodGen deleteCodeBlockPattern(String pattern, MethodGen mg) {
        InstructionList il = mg.getInstructionList();
        InstructionFinder finder = new InstructionFinder(il);
        InstructionHandle next = null;
        for(java.util.Iterator i = finder.search(pattern); i.hasNext(); ) {
        InstructionHandle[] match = (InstructionHandle[])i.next();
        InstructionHandle   first = match[0];
        InstructionHandle   last  = match[match.length - 1];

        if((next = last.getNext()) == null)
            break;

        try {
        	ConstantPoolGen cpg = mg.getConstantPool();
			int idxPrintln = cpg.lookupMethodref("java.io.PrintStream","println","(Ljava/lang/String;)V");
			int idxSystemout = cpg.lookupFieldref("java.lang.System","out","Ljava/io/PrintStream;");
			il.insert(new INVOKEVIRTUAL(idxPrintln));
			il.insert(new PUSH(cpg, "Code has been removed here."));
			il.insert(new GETSTATIC(idxSystemout));
            il.delete(first, last);
        } catch(TargetLostException e) {
            InstructionHandle[] targets = e.getTargets();
            for(int c = 0; c &lt; targets.length; c++) {
                InstructionTargeter[] targeters = targets[c].getTargeters();

                for(int j = 0; j &lt; targeters.length; j++)
                    targeters[j].updateTarget(targets[c], next);
            }
        }
    }

    return mg;
}[/code]
A useful pattern for those who can't be bothered to write an applet loader:
[code]
"ALOAD GETFIELD IFNULL ALOAD GETFIELD SIPUSH SIPUSH " +
"INVOKEVIRTUAL ALOAD GETFIELD (LDC | LDC_W) INVOKEVIRTUAL";</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971/1</link>
        <pubDate>Sat, 01 Apr 2006 04:12:00 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-971-1</guid>
        <source url="https://forum.moparisthebest.com/t/bcel-javas-swiss-army-knife/971.rss">BCEL: Java&#39;s Swiss Army knife</source>
      </item>
  </channel>
</rss>
