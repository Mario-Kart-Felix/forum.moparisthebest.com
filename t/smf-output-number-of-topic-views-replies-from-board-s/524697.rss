<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>[SMF] Output number of topic views/replies from board(s)</title>
    <link>https://forum.moparisthebest.com/t/smf-output-number-of-topic-views-replies-from-board-s/524697</link>
    <description>Apparently this is useful to some people. This will put a bit of a strain on your database depending on how many boards, topics, and posts your forum has so use it wisely.
 
This function will output the total number of topic views and replies from certain board(s) within two set dates.
 
[code=php]function ssi_getNumViewsAndReplies($idBoard, $timestamp1, $timestamp2, $childLevel = 0, $output_method = &#39;echo&#39;) {

    global $smcFunc;
    
    if (!is_numeric($timestamp1) || !is_numeric($timestamp2) || empty($idBoard))
        return -1;
    
    $boards = array($idBoard);
    if ($childLevel &gt; 0) {
        $query_parameters_joins = &#39;&#39;;
        $query_parameters_where = &#39;&#39;;
        for ($i = 1; $i &lt; $childLevel; $i++) {
            $query_parameters_joins .= &#39;LEFT JOIN {db_prefix}boards AS childLevel&#39; . $i . &#39;Board ON (childLevel&#39; . $i . &#39;Board.id_parent IN (&#39; . ($i == 1 ? &#39;childBoard&#39; : &#39;childLevel&#39; . ($i - 1) . &#39;Board&#39;) . &#39;.id_board)) &#39;;
            $query_parameters_where .= &#39; OR requestedBoard.id_board IN (childLevel&#39; . $i . &#39;Board.id_board)&#39;;
        }

        // Retrieve all child boards, and child boards of child boards who inherit from parent
        // !! SLOW
        $request = $smcFunc[&#39;db_query&#39;](&#39;&#39;,
            &#39;SELECT requestedBoard.id_board
            FROM {db_prefix}boards AS requestedBoard
            INNER JOIN {db_prefix}boards AS childBoard ON (childBoard.id_parent = {int:parentId})
            &#39; . $query_parameters_joins . &#39;
            WHERE requestedBoard.id_board IN (childBoard.id_board)
            &#39; . $query_parameters_where,
            array(
                &#39;parentId&#39; =&gt; $idBoard
            )
        );
    
        while ($row = $smcFunc[&#39;db_fetch_assoc&#39;]($request)) {
            $boards[] = $row[&#39;id_board&#39;];
        }
    
        $smcFunc[&#39;db_free_result&#39;]($request);
    }
    
    // Next, retrieve all the topics in the boards where the timestamp is between two dates.
    // Once found, just output num_views
    $request = $smcFunc[&#39;db_query&#39;](&#39;&#39;,
        &#39;SELECT t.num_views, t.num_replies
        FROM {db_prefix}topics AS t
        INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)
        WHERE t.id_board IN ({array_int:boards_list}) AND m.poster_time BETWEEN {int:date1} AND {int:date2}&#39;,
        array(
            &#39;boards_list&#39; =&gt; $boards,
            &#39;date1&#39; =&gt; $timestamp1,
            &#39;date2&#39; =&gt; $timestamp2
        )
    );
    
    // Your total number of views in this variable
    $num_views = 0;
    $num_replies = 0;
    while ($row = $smcFunc[&#39;db_fetch_assoc&#39;]($request)) {
        $num_views += $row[&#39;num_views&#39;];
        $num_replies += $row[&#39;num_replies&#39;];
    }

    $smcFunc[&#39;db_free_result&#39;]($request);
    if ($output_method == &#39;echo&#39;) {
        echo $num_views . &#39;&lt;br /&gt;&#39; . $num_replies;    
    }
    
    return array(&#39;views&#39; =&gt; $num_views, &#39;replies&#39; =&gt; $num_replies);
}[/code]

Example of usage (board id 5, between any time, include all child boards and child of child boards (level 2)):
 
[code=php]ssi_getNumViewsAndReplies(5, 0, 9999999999, 2);[/code]</description>
    
    <lastBuildDate>Thu, 11 Jul 2013 23:58:58 +0000</lastBuildDate>
    <category>General Programming</category>
    <atom:link href="https://forum.moparisthebest.com/t/smf-output-number-of-topic-views-replies-from-board-s/524697.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>[SMF] Output number of topic views/replies from board(s)</title>
        <dc:creator><![CDATA[@justaguy justaguy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/justaguy">@justaguy</a> wrote:</p>
          <blockquote>
              <p>Apparently this is useful to some people. This will put a bit of a strain on your database depending on how many boards, topics, and posts your forum has so use it wisely.</p>
<p>This function will output the total number of topic views and replies from certain board(s) within two set dates.</p>
<p>[code=php]function ssi_getNumViewsAndReplies($idBoard, $timestamp1, $timestamp2, $childLevel = 0, $output_method = ‘echo’) {</p>
<pre><code>global $smcFunc;

if (!is_numeric($timestamp1) || !is_numeric($timestamp2) || empty($idBoard))
    return -1;

$boards = array($idBoard);
if ($childLevel &gt; 0) {
    $query_parameters_joins = '';
    $query_parameters_where = '';
    for ($i = 1; $i &lt; $childLevel; $i++) {
        $query_parameters_joins .= 'LEFT JOIN {db_prefix}boards AS childLevel' . $i . 'Board ON (childLevel' . $i . 'Board.id_parent IN (' . ($i == 1 ? 'childBoard' : 'childLevel' . ($i - 1) . 'Board') . '.id_board)) ';
        $query_parameters_where .= ' OR requestedBoard.id_board IN (childLevel' . $i . 'Board.id_board)';
    }

    // Retrieve all child boards, and child boards of child boards who inherit from parent
    // !! SLOW
    $request = $smcFunc['db_query']('',
        'SELECT requestedBoard.id_board
        FROM {db_prefix}boards AS requestedBoard
        INNER JOIN {db_prefix}boards AS childBoard ON (childBoard.id_parent = {int:parentId})
        ' . $query_parameters_joins . '
        WHERE requestedBoard.id_board IN (childBoard.id_board)
        ' . $query_parameters_where,
        array(
            'parentId' =&gt; $idBoard
        )
    );

    while ($row = $smcFunc['db_fetch_assoc']($request)) {
        $boards[] = $row['id_board'];
    }

    $smcFunc['db_free_result']($request);
}

// Next, retrieve all the topics in the boards where the timestamp is between two dates.
// Once found, just output num_views
$request = $smcFunc['db_query']('',
    'SELECT t.num_views, t.num_replies
    FROM {db_prefix}topics AS t
    INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)
    WHERE t.id_board IN ({array_int:boards_list}) AND m.poster_time BETWEEN {int:date1} AND {int:date2}',
    array(
        'boards_list' =&gt; $boards,
        'date1' =&gt; $timestamp1,
        'date2' =&gt; $timestamp2
    )
);

// Your total number of views in this variable
$num_views = 0;
$num_replies = 0;
while ($row = $smcFunc['db_fetch_assoc']($request)) {
    $num_views += $row['num_views'];
    $num_replies += $row['num_replies'];
}

$smcFunc['db_free_result']($request);
if ($output_method == 'echo') {
    echo $num_views . '&lt;br /&gt;' . $num_replies;    
}

return array('views' =&gt; $num_views, 'replies' =&gt; $num_replies);
</code></pre>
<p>}[/code]</p>
<p>Example of usage (board id 5, between any time, include all child boards and child of child boards (level 2)):</p>
<pre><code class="lang-auto"></code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/smf-output-number-of-topic-views-replies-from-board-s/524697/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/smf-output-number-of-topic-views-replies-from-board-s/524697/1</link>
        <pubDate>Thu, 11 Jul 2013 23:58:58 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-524697-1</guid>
        <source url="https://forum.moparisthebest.com/t/smf-output-number-of-topic-views-replies-from-board-s/524697.rss">[SMF] Output number of topic views/replies from board(s)</source>
      </item>
  </channel>
</rss>
