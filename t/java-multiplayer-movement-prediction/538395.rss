<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Java Multiplayer Movement Prediction</title>
    <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395</link>
    <description>Hey

I&#39;m still working on my 2d multiplayer game with java/lwjgl. [url=http://www.moparisthebest.com/smf/index.php/topic,656271.0.html][i]Previous topic[/i][/url]

[b]Edit:[/b] It is a 2d sidescroller using keyboard as controller

[b]Note:[/b] [i]please correct me if I&#39;m making a mistake somewhere :)
[/i]
So now that I got my server/client to work I&#39;m trying to make movement work. 
So first of all I&#39;ve seen some people talk about the different prediction algorithms that I could use in this.
You have server sided and client sided prediction algorithms. 

Afther reading a bit I quickly discovered that server sided is the best for synchronizing the game between the server/clients. It makes movement really &#39;jerky&#39; and is barely used.
Client sided makes the client get ahead of the server. This would give smooth movement for the local player but would also require some smoothing algorithms on ( server/client? ) side. 

Depending on [url=http://www.gabrielgambetta.com/fpm3.html][b]this[/b] (Scroll down)[/url] article I guess I shouldn&#39;t be using &quot;Death Reckoning&quot; as player movement speed can change instantly. Is this correct?

[b]Note:[/b] [i]I&#39;m trying to achieve something similar to the movement of minecraft/terraria/... so that I could use input from the keyboard and that it would feel like the movement is real time.[/i]

[b]Note:[/b][i] I&#39;m also using TCP for everything[/i]

If anyone could help me or give me some more info about this subject that would be greatly appreciated!
Thanks!</description>
    
    <lastBuildDate>Mon, 13 Jan 2014 19:57:37 +0000</lastBuildDate>
    <category>General Programming</category>
    <atom:link href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@DefLegende DefLegende]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/deflegende">@DefLegende</a> wrote:</p>
          <blockquote>
              <p>Hey sorry for late reply <img src="https://forum.moparisthebest.com/images/emoji/twitter/confused.png?v=5" title=":confused:" class="emoji" alt=":confused:"></p>
<p>First of all thank you for the detailed reply.</p>
<p>So I finally managed to get the basic network movement to work.<br>
Now I just need to solve the jumping of clients when they changed their direction etc.<br>
I’m assuming this can be done using linear interpolation or linear extrapolation. But I’m not sure which one to choose.</p>
<p>When I move the local player I make the input directly visible for the local client. Now when the server sends back the movement sync packet it sometimes difference then the predicted position of the client.<br>
What should I do in this case? (atm I’m just syncing the position of the server but I guess I could ignore these right? or at least in some radius?)</p>
<p>I’m also going to post my current position prediction system as I think I’m missing something.<br>
Why do I think this because in many example’s I see people multiplying their velocity * delay time etc or using lerp but I’m doing it in a totally different way.</p>
<pre><code class="lang-auto">private void updateInput(UpdateInfo e) {

        boolean left = isKeyDown(KEY_Q);
        boolean right = isKeyDown(KEY_D);
        boolean up = isKeyDown(KEY_Z);
        boolean down = isKeyDown(KEY_S);
        
        // Check if client state has changed
        boolean updateMovement = ((left != l) || (right != r) || (down != d) || (up != u));

        l = left;
        r = right;
        u = up;
        d = down;

        // MOVE_NEG = -1 // MOVE_NORM = 0 // MOVE_POS = 1
        // mv_speed = 5f;
        this.movex = (left ? MovePacket.MOVE_NEG : MovePacket.MOVE_NORM) + (right ? MovePacket.MOVE_POS : MovePacket.MOVE_NORM);
        this.deltax = (left ? -mv_speed : 0) + (right ? mv_speed : 0);

        this.movey = (up ? MovePacket.MOVE_NEG : MovePacket.MOVE_NORM) + (down ? MovePacket.MOVE_POS : MovePacket.MOVE_NORM);
        this.deltay = (up ? -mv_speed : 0) + (down ? mv_speed : 0);

        if (updateMovement)
            this.socket.sendPacket(compensateLagg(new MovePacket(this.id, this.x, this.y, this.movex, this.movey, this.deltax, this.deltay)));

    }
    // double frameTime = 1000/60;
    // ping = the total roundtrip time in ms 
    // the 50 ms is the additional time it takes for the server to send back the movement packet
    // server sends it at 10 Hz. So it could be that when the movement packet arrives the server sends it back immediatly or it has to wait onother 100ms. So the average in this case is 50 ms.
    private MovePacket compensateLagg(MovePacket p) {
        double updates = (this.ping + 50) / frameTime;
        for (double t = 0; t &lt;= updates; t += frameTime) {
            p.x += p.deltax;
            p.y += p.deltay;
        }

        return p;
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/7</link>
        <pubDate>Mon, 13 Jan 2014 19:57:37 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-7</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@mod_taharok Taharok]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mod_taharok">@mod_taharok</a> wrote:</p>
          <blockquote>
              <p>For keyboard input, I would approach it like this: if you press a key, it adjusts your velocity. Your physics integrator handles adding velocity to your position based on your frame time. Client-side prediction for something like this can be as simple as just moving the player without waiting for the server to move it for you. When you press the key, that sends the “I want to move in this direction” packet. The server adjusts the velocity server side and integrates just like the client. The server is always right, however. So every n number of frames, the server sends a position packet telling the client where it should be at that point. The client adjusts the position and continues integrating (this can cause a skip, though you can use things like linear interpolation to make it seem more smooth). Depending on the frequency of these position update packets and latency of the network will correlate with how often the client skips. Generally for something simple like this (with proper integration), it may not skip at all, or just once. Finally, when the player releases a key, the client sends the “I have stopped moving in this direction” packet and the server ends integration. The slight trick with ending, though, is the client should CONTINUE moving the player until the server confirms it received the packet, with the final synchronize position. Otherwise, the client will predict immediate stop walking, in which case the latency time for the server to receive the stop walking packet and stop integrating, the server will already have slightly integrated the player’s position, causing either a desynchronization in position or the server will send a final sync position packet that will cause the client to jump. This is also a slight issue for starting to talk, as well. Though, if you wait for the server to confirm “start walking,” there will be a slight delay. If you don’t want the movement to begin immediately, that’s what you would do. You can almost guarantee synchronization if you do. Otherwise, you can have immediate moving with a possible slight twitch after the first sync position packet.</p>
<p>If you want me to go into more detail, I can.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/6</link>
        <pubDate>Sun, 12 Jan 2014 19:26:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-6</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@DefLegende DefLegende]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/deflegende">@DefLegende</a> wrote:</p>
          <blockquote>
              <p>It’ll use the keyboard for movement.</p>
<p>What I’m doing on the client side.</p>
<p>[ul][li]I take input @ 60Hz[/li]<br>
[li]Check if input is different then previous check. <span class="bbcode-i">(Key pressed/released etc)</span>[/li]<br>
[li]If input is different I queue a new MovementPacket with the movement predictions in[/li][/ul]</p>
<p>What I’m doing on the client side afther I received a movement packet from the server.</p>
<p>[ul][li]Update the state locally[/li][/ul]</p>
<p>What I’m doing on the server side</p>
<p>[ul][li]Server rebroadcasting each players state @ 10 Hz if the player has changed his state[/li][/ul]</p>
<p>[hr]</p>
<p>Now to see this in code.<br>
Client:<span class="bbcode-i"> (I think I’m doing something wrong in the CompensateLagg(MovementPacket) function)</span></p>
<pre><code class="lang-auto">private void updateInput(UpdateInfo e) {

        boolean left = isKeyDown(KEY_Q);
        boolean right = isKeyDown(KEY_D);
        boolean up = isKeyDown(KEY_Z);
        boolean down = isKeyDown(KEY_S);

        boolean updateMovement = ((left != l) || (right != r) || (down != d) || (up != u));

        l = left;
        r = right;
        u = up;
        d = down;

        if (left &amp;&amp; !right) {
            this.movex = MovePacket.MOVE_NEG;
            this.deltax = -mv_speed;
        } else if (!left &amp;&amp; right) {
            this.movex = MovePacket.MOVE_POS;
            this.deltax = mv_speed;
        } else
            this.movex = MovePacket.MOVE_NORM;

        if (up &amp;&amp; !down) {
            this.movey = MovePacket.MOVE_NEG;
            this.deltay = -mv_speed;
        } else if (!up &amp;&amp; down) {
            this.movey = MovePacket.MOVE_POS;
            this.deltay = mv_speed;
        } else
            this.movey = MovePacket.MOVE_NORM;

        if (updateMovement) {
            MovePacket p = compensateLagg(new MovePacket(this.id, this.x, this.y, this.movex, this.movey, this.deltax, this.deltay));

            this.socket.sendPacket(p);
        }
    }

    private MovePacket compensateLagg(MovePacket p) {

        double updates = this.ping / frameTime;
        double t;
        for (t = 0; t &lt;= updates; t += frameTime) {
            p.deltax *= xdrag;
            p.deltay *= ydrag;

            if (p.movex == MovePacket.MOVE_NEG)
                p.deltax = -mv_speed;
            else if (p.movex == MovePacket.MOVE_POS)
                p.deltax = mv_speed;

            if (p.movey == MovePacket.MOVE_NEG)
                p.deltay = -mv_speed;
            else if (p.movex == MovePacket.MOVE_POS)
                p.deltay = mv_speed;

            p.x += deltax;
            p.y += deltay;
        }

        return p;
    }</code></pre>
<p>MovementPacketHandler (Client side):</p>
<pre><code class="lang-auto">@Override
    public void handle(CurrPlayer p, PlayerSocket s) {
        if (this.playerId == p.id) {
            p.x = x;
            p.y = y;
            p.movex = movex;
            p.movey = movey;
            p.deltax = deltax;
            p.deltay = deltay;
        } else {
            World w = World.getWorld();
            Player pid = w.getPlayer(this.playerId);
            if (pid != null) {
                pid.x = x;
                pid.y = y;
                pid.movex = movex;
                pid.movey = movey;
                pid.deltax = deltax;
                pid.deltay = deltay;
            }
        }
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/5</link>
        <pubDate>Sun, 12 Jan 2014 10:41:54 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-5</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@mod_taharok Taharok]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mod_taharok">@mod_taharok</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="3" data-topic="538395">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/deflegende/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> DefLegende:</div>
<blockquote>
<p>Well it is going to be a 2d sidescroller</p>
</blockquote>
</aside>
<p>Like a sidescrolling platformer? Point and click? Is it key-based movement?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/4</link>
        <pubDate>Sun, 12 Jan 2014 10:06:00 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-4</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@DefLegende DefLegende]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/deflegende">@DefLegende</a> wrote:</p>
          <blockquote>
              <p>Well it is going to be a 2d sidescroller</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/3</link>
        <pubDate>Sun, 12 Jan 2014 08:49:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-3</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@mod_taharok Taharok]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/mod_taharok">@mod_taharok</a> wrote:</p>
          <blockquote>
              <p>I can’t even begin to give any advice unless I know what type of game you’re working on. That changes quite a bit.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/2</link>
        <pubDate>Sun, 12 Jan 2014 02:57:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-2</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
      <item>
        <title>Java Multiplayer Movement Prediction</title>
        <dc:creator><![CDATA[@DefLegende DefLegende]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/deflegende">@DefLegende</a> wrote:</p>
          <blockquote>
              <p>Hey</p>
<p>I’m still working on my 2d multiplayer game with java/lwjgl. <a href="http://www.moparisthebest.com/smf/index.php/topic,656271.0.html" data-bbcode="true" rel="nofollow noopener"><span class="bbcode-i">Previous topic</span></a></p>
<p><span class="bbcode-b">Edit:</span> It is a 2d sidescroller using keyboard as controller</p>
<p><span class="bbcode-b">Note:</span> <span class="bbcode-i">please correct me if I’m making a mistake somewhere <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"><br>
</span><br>
So now that I got my server/client to work I’m trying to make movement work.<br>
So first of all I’ve seen some people talk about the different prediction algorithms that I could use in this.<br>
You have server sided and client sided prediction algorithms.</p>
<p>Afther reading a bit I quickly discovered that server sided is the best for synchronizing the game between the server/clients. It makes movement really ‘jerky’ and is barely used.<br>
Client sided makes the client get ahead of the server. This would give smooth movement for the local player but would also require some smoothing algorithms on ( server/client? ) side.</p>
<p>Depending on <a href="http://www.gabrielgambetta.com/fpm3.html" data-bbcode="true" rel="nofollow noopener"><span class="bbcode-b">this</span> (Scroll down)</a> article I guess I shouldn’t be using “Death Reckoning” as player movement speed can change instantly. Is this correct?</p>
<p><span class="bbcode-b">Note:</span> <span class="bbcode-i">I’m trying to achieve something similar to the movement of minecraft/terraria/… so that I could use input from the keyboard and that it would feel like the movement is real time.</span></p>
<p><span class="bbcode-b">Note:</span><span class="bbcode-i"> I’m also using TCP for everything</span></p>
<p>If anyone could help me or give me some more info about this subject that would be greatly appreciated!<br>
Thanks!</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395/1</link>
        <pubDate>Fri, 10 Jan 2014 20:56:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-538395-1</guid>
        <source url="https://forum.moparisthebest.com/t/java-multiplayer-movement-prediction/538395.rss">Java Multiplayer Movement Prediction</source>
      </item>
  </channel>
</rss>
