<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>New Design, New Prospects</title>
    <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036</link>
    <description>About two weeks Tom and I had a discussion about this moving forward and he gave me an ultimatum. I had two weeks (starting from the point I started writing code) to create a new design to help us move forward.

[url=https://gitlab.com/mopar/server/tree/master]This is the current design[/url]

The idea is to break apart each of the services into separate services and use gRPC to link each and post/dispatch client messages along with any messages we may be required to send. However there are plenty of APIs in various different languages to connect to a gRPC based service (Go, Node, C#, C++, etc). 

I&#39;m posting this to get some feedback, mostly from the veteran members and from the newer members when the content system goes live. This is just the first service, please note you will not be able to build the server from Maven just yet because of the way gRPC is structured. They are idiots when it comes to dependency/plugin management so that is something I&#39;ll have to look into. (ie, You require netty 5 for some desired features BUT WAIT you need to use 4.1 because of a few utility classes)

Tests will be required for pull requests.

Currently this is the game core.

The world is currently backed by quad tree organized in blocks (8x8) to hold references to entities currently active in the world, and also entity events such as when an entity is created or removed. Currently there is no event for when an entity is updated however that is a future possibility it just doesn&#39;t agree with trying to adhere to KISS (since the world would have to subscribe/listen to entity changes or the entity itself would have to write a message to the world).

From the subscriber, you can listen for additions, removals, and updates which keeps track of entities that are currently marked to be within view. The protocol design for creating, removing various entities actually adheres to a similar pattern except for obviously locales, still graphics, and ground items. The difference is how these updates are encoded obviously. 

The objective here is to have a good foundation to move forward on so that we are as efficient as possible. Thanks guys.</description>
    
    <lastBuildDate>Sun, 05 Jul 2015 03:27:13 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@pure2ownage Pure_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pure2ownage">@pure2ownage</a> wrote:</p>
          <blockquote>
              <p> jmood: sinisoul times up <a href="https://www.moparisthebest.com/smf/index.php/topic,670952.msg4488623.html#msg4488623" rel="nofollow noopener">https://www.moparisthebest.com/smf/index.php/topic,670952.msg4488623.html#msg4488623</a></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/30">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/30</link>
        <pubDate>Sun, 05 Jul 2015 03:27:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-30</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>[quote=“Pure_, post:28, topic:552036”][quote author=sini link=topic=670952.msg4488801#msg4488801 date=1436044564]<br>
I dont know if any of you follow my development thread but given 2 weeks I feel as if I got far enough to call it successful.<br>
[/quote]It’s more fun to circlejerk tho[/quote]</p>
<p>It bothers me that people count me out more than in <img src="https://forum.moparisthebest.com/images/emoji/twitter/frowning.png?v=5" title=":frowning:" class="emoji" alt=":frowning:"> I took the past few days off to recollect my thoughts and Ill be hitting down login, world list, and game updating soon.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/29">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/29</link>
        <pubDate>Sun, 05 Jul 2015 00:02:17 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-29</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@pure2ownage Pure_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pure2ownage">@pure2ownage</a> wrote:</p>
          <blockquote>
              <p>[quote=“sini, post:27, topic:552036”]I dont know if any of you follow my development thread but given 2 weeks I feel as if I got far enough to call it successful.[/quote]It’s more fun to circlejerk tho</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/28">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/28</link>
        <pubDate>Sat, 04 Jul 2015 22:36:40 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-28</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>I dont know if any of you follow my development thread but given 2 weeks I feel as if I got far enough to call it successful.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/27">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/27</link>
        <pubDate>Sat, 04 Jul 2015 21:16:04 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-27</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>[quote=“Davidi2, post:25, topic:552036”][quote author=Death Style link=topic=670952.msg4488623#msg4488623 date=1435896194]<br>
time’s up<br>
[/quote][/quote]</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/26">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/26</link>
        <pubDate>Sat, 04 Jul 2015 12:49:20 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-26</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@davidi2 Davidi2]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/davidi2">@davidi2</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="24" data-topic="552036">
<div class="title">
<div class="quote-controls"></div>
 Death Style:</div>
<blockquote>
<p>time’s up</p>
</blockquote>
</aside>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/25">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/25</link>
        <pubDate>Fri, 03 Jul 2015 04:27:42 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-25</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@Death_Style Death Style]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/death_style">@Death_Style</a> wrote:</p>
          <blockquote>
              <p>time’s up</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/24">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/24</link>
        <pubDate>Fri, 03 Jul 2015 04:03:14 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-24</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>This is going to be a rather long post. So buckle up.</p>
<p>Here is the current code: <a href="https://gitlab.com/mopar/server/tree/master" rel="nofollow noopener">https://gitlab.com/mopar/server/tree/master</a></p>
<p>I came into this design hoping to create a simple way to help establish service responsibility through different service-server modules by using protobufs to help construct request, response, and model messages backed by a framework of code. I quickly ran into how difficult it was to cleanly build protobuf messages and the question of what messages would be needed to help people emulate the game world with the provided data from the game server. These weren’t major set backs, however I knew I needed to take the design in a different direction from being directly dependant on protobuf messages and gRPC. That coupled with the fact there may be up to X services and no service framework I knew it’d be inefficient to code and design future services I may need in the future.</p>
<p>So, I went back to the drawing board and scrapped some of the code. I scrapped any 1:1 client messages which held data to write back to game clients and I scrapped some code involving extraneous features like step records, scenes, and observers. I wasn’t sure how I wanted to synchronize the state with connecting clients, and frankly just wanted to push a proof of concept. I kept any required code that obviously is needed in order to properly emulate a game service.</p>
<p>The new goal now was to properly lay out a service framework which could use a basic model to lay out all service transactions and the results of those transactions. This is the result.</p>
<p><span class="bbcode-u">Callbacks and the Request/Response</span></p>
<p>I knew off the bat that I wanted to keep the communication with services as simple as possible and to help people be efficient with responsive code. I resorted to a request, response, callback model where a user could queue a service request with a provided callback and get a response and handle the response callback. This responsive design could allow users to string nested callbacks together to query or update service data as needed with of course there being a core set of requests and responses for each service. Requests are expected to be submitted and handled asynchronously to the thread that submitted the request however if it’s ever needed request aggregation could be a product of more complex calculations that require multiple requests.</p>
<p>An example:</p>
<pre><code class="lang-auto">// We receive response when the request is processed
service.submit(new HelloRequest("How are you service?"), (res) -&gt; System.out.println("I got this response: " + res));
...

void handleHelloRequest(HelloRequest request, Callback callback) {
    callback.call(new HelloResponse("I am great!"));
}</code></pre>
<p><span class="bbcode-u">Game Service Features</span></p>
<ul>
<li>Ability to evaluate/load/execute Lua scripts.</li>
<li>Interactions</li>
</ul>
<p>The entire game service is structured to be wrapped by the lua script environment and the bindings for the environment reflect this. People are encouraged to load and execute scripts as needed for their own functionality. Interactions such as player, npc, etc menu actions can be registered from the lua script environment or to the service itself. Although this design is not oriented towards supporting java functionality and most modules that include content helpers will be loaded into the lua script environment on initialization.</p>
<pre><code class="lang-auto">service.eval(new EvalScriptRequest("return world:time()", (res) -&gt; System.out.println("The current world time is: " + res.getResult()));</code></pre>
<p><span class="bbcode-u">Protocol Implementations</span></p>
<p>From this design it’s entirely possible to wrap this framework in a custom RS2 protocol implementation and simple submit requests as messages are read from the client. If you even wanted to you could accept various protocol messages, decode them into requests, and submit them to the server. It’s possible to run each service on a single application however I would want to implement a round robin executor implementation before anyone wanted to accomplish that. Some services, like the game service, however need their own dedicated thread. The design is very flexible in that regard.</p>
<p>If the services all ran on a single application they would be considered more virtual, unless of course you had bindings for each that exposed a port to communicate with the service.</p>
<p>There are some core features I didn’t touch on such as player profiles but that needs to be fleshed out a bit more before I discuss that. That also is more relevant to player profile storage. Soon to come!</p>
<p>Edit:</p>
<p>I’ll be using both gitlabs (because its actually pretty awesome) and github, I want the metrics github supports+travisci so check out:</p>
<p><a href="https://github.com/Hadyn/mopar" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Hadyn/mopar</a></p>
<p>Edit <span class="hashtag">#2:</span></p>
<p>I repackaged most of the source, working on the RS2 server piece right now. For example:</p>
<pre><code class="lang-auto">package io.mopar.rs2.msg;

import io.mopar.rs2.msg.handshake.UpdateHandshakeMessage;
import io.mopar.rs2.net.packet.Packet;
import io.mopar.rs2.net.packet.PacketMetaList;

/**
 * @author Hadyn Fitzgerald
 */
public class DefaultCodecInitializer implements CodecInitializer {

    /**
     * Constructs a new {@link DefaultCodecInitializer};
     */
    public DefaultCodecInitializer() {}

    @Override
    public void initialize(MessageCodec codec, PacketMetaList incomingPackets, PacketMetaList outgoingPackets) {
        registerMessageDecoders(codec, incomingPackets);
    }

    /**
     * Register all of the message decoders to the provided codec.
     *
     * @param codec The message codec.
     * @param incomingPackets The incoming packets.
     */
    private void registerMessageDecoders(MessageCodec codec, PacketMetaList incomingPackets) {
        codec.registerMessageDecoder(incomingPackets.getId("update_handshake"), this::decodeUpdateHandshake);
    }

    /**
     * Decodes an update service handshake message.
     *
     * @param packet The packet to decode the message from.
     * @return The decoded update service handshake message.
     */
    private UpdateHandshakeMessage decodeUpdateHandshake(Packet packet) {
        return new UpdateHandshakeMessage(packet.getBuffer().readInt());
    }
}
</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/23">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/23</link>
        <pubDate>Sun, 21 Jun 2015 13:11:58 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-23</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>yeah I built it, If you are serious about using these depends someone on the team is going to have to update one of the existing maven auto compile protobuf plugins or else people are going to have a bad time.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/22">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/22</link>
        <pubDate>Sat, 20 Jun 2015 07:15:29 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-22</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>Check library folder, I had to build the dependency myself and the latest gRPC build is not pushed to maven. You can build it yourself and import the binaries however the one used for the project is on the repo. Requires 8.0.0. It’s a pain in the ass, the gRPC-java team is brain dead when it comes to assuring their latest stable release is on maven.</p>
<p>Note to build the protobuf files you need protoc, and the gRPC plugin. There isn’t a maven plugin right now, and the ones they list are outdated for their most recent revision. :\ You can pull the binaries from the build (gRPC).</p>
<pre><code class="lang-auto">git clone https://github.com/grpc/grpc-java.git
cd grpc-java
./gradlew</code></pre>
<p>There’s an issue detailing this all, I will come up with a solution on how to fix this eventually.</p>
<p>I may eventually just create a distribution of the generated protobuf/grpc classes so that people don’t need to do this however if dependencies change you’re kinda shit out of luck.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/21">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/21</link>
        <pubDate>Sat, 20 Jun 2015 06:32:23 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-21</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>ps some package appear to be missing from the rep. specifically import io.grpc.transport.netty.NegotiationType;<br>
import io.grpc.transport.netty.NettyChannelBuilder;</p>
<p>import static io.mopar.game.model.EntityEventListener.filterForType;</p>
<p>I checked the POM file if you are using GRPC its not in the depends</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/20</link>
        <pubDate>Sat, 20 Jun 2015 06:12:04 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-20</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>[quote=“Miss Silabsoft, post:18, topic:552036”][quote author=sini link=topic=670952.msg4487054#msg4487054 date=1434752580]</p>
<aside class="quote">
<blockquote>
<p>where is the source to this new source? I want to steal it and reopen soul split</p>
</blockquote>
</aside>
<p>You’re such a fudgeing troll.</p>
<p><aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://assets.gitlab-static.net/assets/favicon-075eba76312e8421991a0c1f89a89ee81678bcde72319dd3e8047e2a47cd3a42.ico" class="site-icon" width="32" height="32">
      <a href="https://gitlab.com/mopar/server/tree/master" target="_blank" rel="nofollow noopener">GitLab</a>
  </header>
  <article class="onebox-body">
    <img src="https://assets.gitlab-static.net/assets/gitlab_logo-7ae504fe4f68fdebb3c2034e36621930cd36ea87924c11ff65dbcb8ed50dca58.png" class="thumbnail onebox-avatar" width="128" height="128">

<h3><a href="https://gitlab.com/mopar/server/tree/master" target="_blank" rel="nofollow noopener">Files · master · mopar / server</a></h3>

<p>GitLab.com</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
[/quote]</p>
<p>birds of a feather</p>
<pre><code>/**
 * The size.
 */
private int size;[/quote]
</code></pre>
<p>Writing specifics is hard. Write in generic ‘duh’ comments, then fill it in later when everything is cemented.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/19</link>
        <pubDate>Sat, 20 Jun 2015 06:07:17 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-19</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>[quote=“sini, post:17, topic:552036”][quote author=Miss Silabsoft link=topic=670952.msg4487008#msg4487008 date=1434726441]<br>
where is the source to this new source? I want to steal it and reopen soul split<br>
[/quote]</p>
<p>You’re such a fudgeing troll.</p>
<p><a href="https://gitlab.com/mopar/server/tree/master%5B/quote%5D" class="onebox" target="_blank" rel="nofollow noopener">https://gitlab.com/mopar/server/tree/master[/quote]</a></p>
<p>birds of a feather</p>
<pre><code>/**
 * The size.
 */
private int size;</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/18</link>
        <pubDate>Sat, 20 Jun 2015 05:54:24 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-18</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="15" data-topic="552036">
<div class="title">
<div class="quote-controls"></div>
 Miss Silabsoft:</div>
<blockquote>
<p>where is the source to this new source? I want to steal it and reopen soul split</p>
</blockquote>
</aside>
<p>You’re such a fucking troll.</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://assets.gitlab-static.net/assets/favicon-075eba76312e8421991a0c1f89a89ee81678bcde72319dd3e8047e2a47cd3a42.ico" class="site-icon" width="32" height="32">
      <a href="https://gitlab.com/mopar/server/tree/master" target="_blank" rel="nofollow noopener">GitLab</a>
  </header>
  <article class="onebox-body">
    <img src="https://assets.gitlab-static.net/assets/gitlab_logo-7ae504fe4f68fdebb3c2034e36621930cd36ea87924c11ff65dbcb8ed50dca58.png" class="thumbnail onebox-avatar" width="128" height="128">

<h3><a href="https://gitlab.com/mopar/server/tree/master" target="_blank" rel="nofollow noopener">Files · master · mopar / server</a></h3>

<p>GitLab.com</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/17</link>
        <pubDate>Fri, 19 Jun 2015 22:23:00 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-17</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@justaguy justaguy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/justaguy">@justaguy</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="12" data-topic="552036">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/lin/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> Lin:</div>
<blockquote>
<p>While your system is pretty flexible, don’t you think there’s a lot of overhead for something as simple as adding a player? You’re creating new instances and doing lots of calling. I don’t know how Java works since creating small objects on the heap is less expensive than doing it in a native language, but you’re adding more work to the garbage collector and unless the methods get inlined, that’s a lot of unnecessary stack manipulation. The key to speed I found in my C# server that supported 5k players was to sacrifice neat systems like what you’ve made and do everything the hard way. Micro-optimizations (made because of profiling, of course) were actually what allowed me to achieve the results I did.</p>
</blockquote>
</aside>
<p>I would imagine allocating any object on the heap in Java is going to be <span class="bbcode-i">more</span> expensive than any systems language which isn’t garbage collected. I think a lot of people don’t realize how expensive garbage collection really is. Anyhow, if those optimizations gave you that much of a performance boost I wouldn’t consider it a micro-optimization; something like doing myVar++ instead of myVar += 1; would be. <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/16</link>
        <pubDate>Fri, 19 Jun 2015 15:31:48 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-16</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>where is the source to this new source? I want to steal it and reopen soul split</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/15</link>
        <pubDate>Fri, 19 Jun 2015 15:07:21 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-15</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>I rather have a flexible system and micro optimize when everything is finished.</p>
<p>Appending to a list, appending to the reference space, on movement to a new block, deleting reference and reappending the reference. &lt;- Cost of adding any entity</p>
<p>I don’t think that is much overhead, considering the features go beyond just scanning for which players are nearby a subscriber. Such as determining entities within a specific area, which, most of the areas involved in this are small (3x3 off the top of my head) so you’ll only have to scan a single block and then filter entity references of a specific type. Instead of say looping through an entire list of entities which god help you if there are 5,000 npcs+ currently active in the world. It’s sacrificing some memory for faster computations obviously. Memory is cheap, and this doesn’t come close to crossing the threshold I’m willing to wager would make it a bloated application.</p>
<p>Edit:</p>
<p>I had a cool idea of what you COULD do with this setup. You could stream the messages from the server, and log them and make backups for specific times. <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Cause you technically could log the current world time to the message <img src="https://forum.moparisthebest.com/images/emoji/twitter/stuck_out_tongue.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<p>Edit <span class="hashtag">#2:</span></p>
<p>Finished streams, <a href="http://pastie.org/private/6tohhchbctzg0s1ohvygw" rel="nofollow noopener">http://pastie.org/private/6tohhchbctzg0s1ohvygw</a></p>
<p>Currently streams when players are added, still graphics are recreated, when the player scene was rebuilt (ie: you move into a new map). RPC currently has streaming capabilities, and allows for you to register a player. <img src="https://forum.moparisthebest.com/images/emoji/twitter/stuck_out_tongue_winking_eye.png?v=5" title=":stuck_out_tongue_winking_eye:" class="emoji" alt=":stuck_out_tongue_winking_eye:"></p>
<p>From here I just need to determine the messages for entity updating (and block updates). Then start working on the content system. Plus write unit tests. Those damn unit tests.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/14</link>
        <pubDate>Thu, 18 Jun 2015 09:07:38 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-14</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@Death_Style Death Style]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/death_style">@Death_Style</a> wrote:</p>
          <blockquote>
              <p>sorry what</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/13</link>
        <pubDate>Wed, 17 Jun 2015 22:16:34 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-13</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@Lin Lin]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lin">@Lin</a> wrote:</p>
          <blockquote>
              <p>While your system is pretty flexible, don’t you think there’s a lot of overhead for something as simple as adding a player? You’re creating new instances and doing lots of calling. I don’t know how Java works since creating small objects on the heap is less expensive than doing it in a native language, but you’re adding more work to the garbage collector and unless the methods get inlined, that’s a lot of unnecessary stack manipulation. The key to speed I found in my C# server that supported 5k players was to sacrifice neat systems like what you’ve made and do everything the hard way. Micro-optimizations (made because of profiling, of course) were actually what allowed me to achieve the results I did.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/12</link>
        <pubDate>Wed, 17 Jun 2015 16:59:37 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-12</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>The nice thing is that you can use it standalone if you want <img src="https://forum.moparisthebest.com/images/emoji/twitter/stuck_out_tongue.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"> The only thing stopping you using this for 317-560~ is just the platform that streams responses and sends requests.</p>
<p>and since gRPC is cross platform you can write that service in ~any language you fuckers desire~</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/11</link>
        <pubDate>Wed, 17 Jun 2015 13:11:04 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-11</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@pure2ownage Pure_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/pure2ownage">@pure2ownage</a> wrote:</p>
          <blockquote>
              <p>Your update design is quite neat, I’m looking forward to this.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/10</link>
        <pubDate>Wed, 17 Jun 2015 12:58:55 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-10</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <p>[quote=“Eyeownyew, post:8, topic:552036”][quote author=Miss Silabsoft link=topic=670952.msg4486826#msg4486826 date=1434520516]<br>
really you only have 5 days before you get bored<br>
[/quote]<br>
every time<br>
will he ever prove us wrong? find out next time on Dragonball Z™[/quote]</p>
<p>Correctly decompiles runescript to lua, needs support for arrays.</p>
<p><a href="https://github.com/Hadyn/moo" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Hadyn/moo</a></p>
<p>Correctly loads to login, needs scripts to be converted to lua</p>
<p><a href="https://github.com/Hadyn/tekk" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Hadyn/tekk</a></p>
<p>And this takes precedence above both of those because my client rewrite will take AGES. Both projects Ive been working on and updating now for two months.</p>
<p>So? 5 days? 2 months? What is it?</p>
<p>Demo -</p>
<p>Edit:</p>
<pre><code class="lang-auto">package io.mopar.game;


import io.grpc.ServerImpl;
import io.grpc.stub.StreamObserver;
import io.grpc.transport.netty.NegotiationType;
import io.grpc.transport.netty.NettyChannelBuilder;
import io.grpc.transport.netty.NettyServerBuilder;
import io.mopar.game.model.*;
import io.mopar.game.model.Step;
import io.mopar.game.proto.GameServiceGrpc;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.net.SocketAddress;
import java.util.List;
import java.util.stream.Collectors;

import static io.mopar.game.proto.GameProtobuf.*;

/**
 * Created by hadyn on 6/16/15.
 */
public class GameServer implements GameServiceGrpc.GameService {

    private static final Logger logger = LoggerFactory.getLogger(GameServer.class);

    private Player player = new Player();

    /**
     * The world.
     */
    private World world = new World();

    /**
     * The rpc server.
     */
    private ServerImpl rpcServer;

    private EntitySubscriber&lt;StillGraphic&gt; stillGraphicSubscriber;
    private EntitySubscriber&lt;Player&gt; playerSubscriber;

    @Override
    public void stream(StreamRequest request, StreamObserver&lt;GameResponse&gt; observer) {
        stillGraphicSubscriber.append(new SubscriberHandler&lt;StillGraphic&gt;() {
            @Override
            public void addedEntity(World world, StillGraphic entity) {
                // Stream whenever a still graphic is spawned
                GameResponse response = GameResponse.newBuilder().setType(GameResponse.Type.BLOCK_UPDATE)
                        .setBlockUpdate(BlockUpdate.newBuilder()
                                .setBlockX(entity.getPosition().getBlockX())
                                .setBlockY(entity.getPosition().getBlockY())
                                .addMessages(EntityMessage.newBuilder()
                                        .setType(EntityMessage.Type.SPAWN_STILL_GRAPHIC)
                                        .setSpawnStillGraphic(SpawnStillGraphic.newBuilder()
                                                .setGraphicId(entity.getGraphicId())))).build();
                observer.onValue(response);
            }

            @Override
            public void updatedEntity(World world, StillGraphic entity) {

            }

            @Override
            public void removedEntity(World world, StillGraphic entity) {

            }
        });

        playerSubscriber.append(new SubscriberHandler&lt;Player&gt;() {
            @Override
            public void addedEntity(World world, Player entity) {
                System.out.println("Player fell in to view!");
            }

            @Override
            public void updatedEntity(World world, Player entity) {
                List&lt;Step&gt; steps = entity.getStepsAtTime(world.getTime());
                GameResponse response = GameResponse.newBuilder().setType(GameResponse.Type.PLAYER_MOVED)
                        .setPlayerMoved(PlayerMoved.newBuilder()
                                .addAllSteps(steps.stream().map(step -&gt; PathStep.newBuilder()
                                        .setDx(step.getDeltaX())
                                        .setDy(step.getDeltaY())
                                        .build()).collect(Collectors.toList()))
                                .build()).build();
                observer.onValue(response);
            }

            @Override
            public void removedEntity(World world, Player entity) {
                System.out.println("Player fell out of view!");
            }
        });
    }

    void loop() {
        boolean bool = true;
        world.addPlayer(player);
        for(;;) {
            long start = System.currentTimeMillis();

            // Spawn a new still graphic at 0,0
            world.addStillGraphic(new StillGraphic(1));

            player.addStep(Step.NORTH);

            // Update and reset the world state for the next tick
            world.update();


            // Updates the subscriber, does not rebuild the local list
            stillGraphicSubscriber.update(new Position(), false);
            playerSubscriber.update(new Position(), bool);
            bool = false;

            world.reset();


            // Sleep until the next clock cycle
            long elapsed = System.currentTimeMillis() - start;
            if(elapsed &lt; 600L) {
                try {
                    Thread.sleep(600L - elapsed);
                } catch (InterruptedException ex) {}
            }
        }
    }

    /**
     * Starts the game server.
     *
     * @param port The port to bind.
     */
    public void start(int port) {
        start(new InetSocketAddress(port));
    }

    /**
     * Starts the game server.
     *
     * @param address The socket address.
     */
    public void start(SocketAddress address) {
        // Create a new subscriber that scans a 32x32 area, and another that scans an 128 by 128 area.
        stillGraphicSubscriber = world.createSubscriber(StillGraphic.class, 16);
        playerSubscriber = world.createSubscriber(Player.class, 64);

        try {
            rpcServer = NettyServerBuilder.forAddress(address)
                    .addService(GameServiceGrpc.bindService(this))
                    .build().start();
            logger.info("Successfully started server on {}", address);

            // Stream responses from the server
            GameServiceGrpc.newStub(NettyChannelBuilder.forAddress(address)
                    .negotiationType(NegotiationType.PLAINTEXT).build())
                    .stream(StreamRequest.getDefaultInstance(), new StreamObserver&lt;GameResponse&gt;() {
                        @Override
                        public void onValue(GameResponse response) {
                            System.out.println(response);
                        }

                        @Override
                        public void onError(Throwable throwable) {}

                        @Override
                        public void onCompleted() {}
                    });

            // Loop forever!
            loop();
        } catch (IOException ex) {
            logger.error("Failed to bind server socket", address);
        }
    }

    public static void main(String[] args) throws IOException {
        GameServer server = new GameServer();
        server.start(5555);
    }
}
</code></pre>
<p>Started on figuring out the response messages and message streaming, any omitted values are assumed to be 0. So obviously a block update message contains the block coordinates.</p>
<pre><code class="lang-auto">[main] INFO io.mopar.game.GameServer - Successfully started server on 0.0.0.0/0.0.0.0:5555
Player fell in to view!
block_update {
  messages {
    spawn_still_graphic {
      graphic_id: 1
    }
  }
}

type: PLAYER_MOVED
player_moved {
  steps {
    dy: 1
  }
}</code></pre>
<pre><code class="lang-auto">syntax = "proto3";

option java_package = "io.mopar.game.proto";
option java_outer_classname = "GameProtobuf";
option java_generic_services = true;

service GameService {
	rpc Stream (StreamRequest) returns (stream GameResponse);
}

message StreamRequest {

}

message GameResponse {
	enum Type {
		BLOCK_UPDATE = 0;
		PLAYER_MOVED = 1;
	}

	Type type = 1;
	int64 client_id = 2;

	BlockUpdate block_update = 3;
	PlayerMoved player_moved = 4;
}

message BlockUpdate {
	int32 block_x = 1;
	int32 block_y = 2;
	repeated EntityMessage messages = 3;
}

message EntityMessage {
	enum Type {
		SPAWN_STILL_GRAPHIC = 0;
	}

	Type type = 1;

	SpawnStillGraphic spawn_still_graphic = 2;
}

message SpawnStillGraphic {
	int32 graphic_id = 1;
	int32 delay = 2;
	int32 height = 3;
}

message PlayerMoved {
	repeated PathStep steps = 1;
}

message PathStep {
	int32 dx = 1;
	int32 dy = 2;
}</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/9</link>
        <pubDate>Wed, 17 Jun 2015 12:34:29 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-9</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@eyeownyew Eyeownyew]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/eyeownyew">@eyeownyew</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="6" data-topic="552036">
<div class="title">
<div class="quote-controls"></div>
 Miss Silabsoft:</div>
<blockquote>
<p>really you only have 5 days before you get bored</p>
</blockquote>
</aside>
<p>every time<br>
will he ever prove us wrong? find out next time on Dragonball Z™</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/8</link>
        <pubDate>Wed, 17 Jun 2015 07:40:41 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-8</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@sinisoul sini]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/sinisoul">@sinisoul</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="6" data-topic="552036">
<div class="title">
<div class="quote-controls"></div>
 Miss Silabsoft:</div>
<blockquote>
<p>really you only have 5 days before you get bored</p>
</blockquote>
</aside>
<p>cant you ever be pleased <img src="https://forum.moparisthebest.com/images/emoji/twitter/frowning.png?v=5" title=":frowning:" class="emoji" alt=":frowning:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/7</link>
        <pubDate>Wed, 17 Jun 2015 07:40:05 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-7</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
      <item>
        <title>New Design, New Prospects</title>
        <dc:creator><![CDATA[@silabsoft RuneAgent]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/silabsoft">@silabsoft</a> wrote:</p>
          <blockquote>
              <p>really you only have 5 days before you get bored</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/new-design-new-prospects/552036/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/new-design-new-prospects/552036/6</link>
        <pubDate>Wed, 17 Jun 2015 05:55:16 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-552036-6</guid>
        <source url="https://forum.moparisthebest.com/t/new-design-new-prospects/552036.rss">New Design, New Prospects</source>
      </item>
  </channel>
</rss>
