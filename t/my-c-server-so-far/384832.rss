<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>My C server so far</title>
    <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832</link>
    <description>Source code can be found here: https://github.com/Lothy/Dionysus

I&#39;ve only added it to github this early because I need some feedback -- it doesn&#39;t actually run yet (well, a client can successfully connect to it and reach the login screen, but that&#39;s it).

I thought my current packet writing API was great, but didn&#39;t consider setting the size of the packets after writing all of the appropriate data. Libevent API doesn&#39;t support direct access to the underlying uchar array in a defined manner (if at all), so I need to redo it.
This means that I&#39;m going to need to write data into uchar arrays that I control directly before sending the data using Libevent.

Fortunately Libevent supports sending the data in a uchar * by passing it in as a pointer, which means the data isn&#39;t copied several times before actually being sent. 
I can pass a pointer to a callback function as well which will be notified when the uchar * has been written.
One obvious solution to this problem is that I simply malloc two uchar * for each game tick.
I don&#39;t really want to do this though, as I don&#39;t believe mallocing/freeing potentially several KB per player (up to 2k players) per game tick (600ms) is ideal.

On the other hand, if you check out my bit_packer files (https://github.com/Lothy/Dionysus/blob/master/include/bit_packer.h and https://github.com/Lothy/Dionysus/blob/master/src/bit_packer.c) you&#39;ll see that I have a bit_buffer struct.
I could alternatively have an array of a similar struct which contains an underlying uchar *.
I would then have a integer acting as a bitfield to indicate which elements in the array are still in use (marked with a 1 bit) and which are &#39;free&#39; to use for a new write (0 bit).
The upside here is that I&#39;m no longer constantly allocating and freeing a potentially large amount of memory.

The reason I thought of this is because of the Libevent API.
Specifically, the evbuffer_add_reference function (documentation here: http://www.monkey.org/~provos/libevent/doxygen-2.0.1/buffer_8h.html#8572c7c382489635be20d251039b8673).
When I pass a uchar * in, it will always read from index 0 -- this rules out use of a true circular buffer.


Thoughts and opinions?
Also, for those who are C programmers (I&#39;m guessing abraham, super_ and mopar plus maybe frank_ if he sees this), comment on the code. 
Evil_ ran it through Valgrind a few days ago and it reported no memory leaks, so that&#39;s a positive start in my opinion. :P

With regards to &#39;best practice&#39;, I know that I need to move some variable declarations from header files to the respective source files. I&#39;ll get to that, but I&#39;m more interested in your thoughts on how I can handle the packet writing.

Second question: How does the game tick work client-side? What would happen if I changed the server&#39;s tick from say 600ms to 100ms (and, as a consequence, changed the sending of position updates and so on only every 6th tick to ensure correct movement speed).

Thanks for the help guys.</description>
    
    <lastBuildDate>Sat, 16 Apr 2011 06:24:52 +0000</lastBuildDate>
    <category>Community Inside Talk</category>
    <atom:link href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@meiscooldude meiscooldude]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/meiscooldude">@meiscooldude</a> wrote:</p>
          <blockquote>
              <p>[quote=“Lothy, post:25, topic:384832”]Boils down to a few things:</p>
<p>a) I’ve never written anything non-trivial in C (or C++ - but I don’t like C++ enough to use it)<br>
b) I wanted to change this, because I was sick of being one of these newfag programmers that ONLY uses C#/Java. Both of these languages are quite good (although now that I’ve come into function pointers, the lack of them in java pisses me off a lot), but using them exclusively is pretty bad imo.<br>
c) Because I wanted to see a server that made use of Lua for scripting<br>
d) The RS emulation scene deserves a native solution just like the WoW scene<br>
e) Because I’m a mushroom cloud laying motherfucker, motherfucker![/quote]</p>
<p>=D!</p>
<p>Edit:</p>
<p>Just happy to see something like this</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/38">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/38</link>
        <pubDate>Sat, 16 Apr 2011 06:24:52 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-38</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>The byte ordering doesn’t matter as long as it is read in the same way that it was written to the stream.<br>
Every single client released in the wild makes use of the obfuscated protocol, which is why my server should be able to operate with them out of the box.<br>
With that said though, anyone at any time can refactor a client so that it only uses big endian and then modify the plugin file accordingly.</p>
<p>Regarding the value’s sign, no. Think about it for a second – if -128 is cast to an unsigned short, what will the value equal? Ballpark answer: somewhere around 65500. That’s certainly not a valid absolute x value for use on runescape’s world map.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/37">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/37</link>
        <pubDate>Thu, 14 Apr 2011 02:36:35 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-37</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@frank frank_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/frank">@frank</a> wrote:</p>
          <blockquote>
              <p>should the temp value be an unsigned short?</p>
<p>ps using the obfuscated protocol is still a good idea right… right?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/36">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/36</link>
        <pubDate>Wed, 13 Apr 2011 23:26:05 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-36</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Hi guys, it’s been a while.</p>
<p>Latest commit lets you log in and walk around, but there’s a curious ‘bug’ (of sorts) which I can’t figure out.</p>
<p>Those familiar with the protocol will know that the first 5 bytes of a walk request packet in version 508 make up two shorts (the absolute x and y of the tile that you clicked) and a byte (which indicates whether or not you had the ctrl key pressed when you clicked the tile).</p>
<p>Following that is the rest of the path.</p>
<p>Anyway, when playing with it I realised that, when clicking on certain tiles, the first short is wildly off.<br>
Here’s some sample output:</p>
<pre><code class="lang-auto">-127 3430
-128 3430
3197 3430
3197 3430
-127 3430
3196 3430
3196 3444
3196 3419
-123 3430
3191 3430
3195 3428
3198 3430
-128 3430
3198 3430
3199 3429
3199 3430
3197 3430
3197 3430
3198 3430
3199 3430
-128 3430
3199 3430
-127 3430
3199 3430
-128 3430
-128 3430
3199 3430</code></pre>
<p>Does anyone know what’s happening? The functions that read from the underlying evbuffer are fine, and it returns the correct value <em>most</em> of the time. But for some reason those first two bytes (which are read as b[0] - 128 | b[1] &lt;&lt; 8) are 0 0.</p>
<p>Notably isn’t an issue when I log in to Blake’s server, Osiris.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/35">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/35</link>
        <pubDate>Tue, 12 Apr 2011 16:35:44 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-35</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@moparisthebest Moparisthebest]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/moparisthebest">@moparisthebest</a> wrote:</p>
          <blockquote>
              <p>[quote=“Lothy, post:30, topic:384832”]I don’t actually have access to a windows system to build and test the code on, so it’s pretty futile for me to cater to windows at this stage.<br>
I’m really hoping that someone chooses to come on board at a later stage for that once it’s a working product. Worst case though, it is on my TODO list.[/quote]</p>
<p>I actually build a decent amount of windows code, and never actually on windows.  Basically ever linux distribution has a package for mingw, and you can use it to build windows executables.  Then of course there is WINE to test them under.  But also, like you said, I don’t know how much I’d worry about it at this stage.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/34">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/34</link>
        <pubDate>Sat, 02 Apr 2011 20:36:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-34</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Jython super_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/jython">@Jython</a> wrote:</p>
          <blockquote>
              <p>that item definition stuff looks rather poorly hacked together, and have you considered writing your own lexer/parser?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/33">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/33</link>
        <pubDate>Fri, 01 Apr 2011 17:11:56 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-33</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Cheese_Police c|p]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/cheese_police">@Cheese_Police</a> wrote:</p>
          <blockquote>
              <p>For the fixed size item list, I was referring more to there being less than 14000 items than there being more (older revisions, RT3/RT4).  I would probably have it either be a config option or specified by a module (maybe have support for different revisions be loaded as modules, which can take care of setting protocol de/encoders and anything else).</p>
<p>Supporting modules on Windows isn’t too hard.</p>
<p>[code=c]HMODULE mod;<br>
int (*fn)();</p>
<p>mod = LoadLibrary(full_module_name); /* you might need to specify LoadLibraryA explicitly depending on encoding <em>/<br>
if (mod == NULL) {<br>
/</em> oh no… */<br>
}</p>
<p>fn = (int (<em>(</em>)())) GetProcAddress(mod, “module_init”); /* same as above with GetProcAddressA <em>/<br>
/</em> … */[/code]</p>
<p>For finding modules in a directory</p>
<p>[code=c]WIN32_FIND_DATA ffd;<br>
HANDLE fh;<br>
const char <em>search_path = "modules/</em>.dll";</p>
<p>fh = FindFirstFile(search_path, &amp;ffd);<br>
if (fh == INVALID_HANDLE_VALUE) {<br>
/* oh no… */<br>
}</p>
<p>do {<br>
/* would be good to make this check a bit safer/robust <em>/<br>
/</em> we filter for *.dll anyway, but for the sake of example… <em>/<br>
if (strstr(ffd.cFileName, “.dll”) != NULL) {<br>
/</em> load it up */<br>
}<br>
} while (FindNextFile(fh, &amp;ffd) != 0);</p>
<p>FindClose(fh);[/code]</p>
<p>In regards to the static path size, 2000 is much more reasonable, but I was getting at using something like MAX_PATH on Windows.  I did just look into it though, and apparently MAX_PATH on Windows is pretty much pointless, and consistency among unix-like systems is pretty bad (some define PATH_MAX and FILENAME_MAX, others may not define them and you need to use pathconf or fpathconf to find it, however it can potentially return a ridiculously huge value or -1, indicating that it isn’t bounded).  So at that, I would go for 2048 and call it a day.</p>
<p>strlcat is what I was referring to.  I didn’t know it isn’t included in glibc, I’ve been using BSD-like systems for a while now.<br>
You have a few options here.</p>
<p>[ul][li]Do something like this (from a BSD strcat manpage):[/li][/ul]</p>
<p>[code]SECURITY CONSIDERATIONS<br>
The strcat() function is easily misused in a manner which enables malicious users to arbitrarily change a running program’s functionality through a buffer overflow attack.  (See the<br>
FSA.)</p>
<pre><code> Avoid using strcat().  Instead, use strncat() or strlcat() and ensure that no more characters are copied to the destination buffer than it can hold.

 Note that strncat() can also be problematic.  It may be a security concern for a string to be truncated at all.  Since the truncated string will not be as long as the original, it may
 refer to a completely different resource and usage of the truncated resource could result in very incorrect behavior.  Example:

 void
 foo(const char *arbitrary_string)
 {
         char onstack[8] = "";

 #if defined(BAD)
         /*
          * This first strcat is bad behavior.  Do not use strcat!
          */
         (void)strcat(onstack, arbitrary_string);        /* BAD! */
 #elif defined(BETTER)
         /*
          * The following two lines demonstrate better use of
          * strncat().
          */
         (void)strncat(onstack, arbitrary_string,
             sizeof(onstack) - strlen(onstack) - 1);
 #elif defined(BEST)
         /*
          * These lines are even more robust due to testing for
          * truncation.
          */
         if (strlen(arbitrary_string) + 1 &gt;
             sizeof(onstack) - strlen(onstack))
                 err(1, "onstack would be truncated");
         (void)strncat(onstack, arbitrary_string,
             sizeof(onstack) - strlen(onstack) - 1);
 #endif
 }
</code></pre>
<p>[/code]<br>
[ul][li]Do some compile time checking or use autoconf (config.h, I wouldn’t really go for that), and do something accordingly (If strlcat is present, go ahead and use it.  If not, implement strlcat using the code above or use <a href="http://www.openbsd.org/cgi-bin/cvsweb/~checkout~/src/lib/libc/string/strlcat.c?rev=1.13;content-type=text%2Fplain" data-bbcode="true" rel="nofollow noopener">strlcat.c</a> with some appropriate modifications).[/li]<br>
[li]Don’t bother checking for existing functions and just implement strlcat as mystrlcat or something.[/li][/ul]</p>
<p>I’m not really sure what I would do to make the writing code better either.  You could try your best to create a pseudo-DSL with macros, but that could get ugly fast.</p>
<p>[code=c]<span class="hashtag">#define</span> P_C(v) ((char) (v))<br>
<span class="hashtag">#define</span> P_S(v) ((char) ((v) &gt;&gt; 8)), ((char) ((v) &amp; 0xff))<br>
<span class="hashtag">#define</span> P_I(v) ((char) ((v) &gt;&gt; 24)), ((char) ((v) &gt;&gt; 16)), <br>
((char) ((v) &gt;&gt; 8)), ((char) ((v) &amp; 0xff))<br>
<span class="hashtag">#define</span> P_END -1</p>
<p>/*<br>
not sure how i would terminate data.  a magic number would be simple, but potentially break with certain packets.<br>
instead of using a char array, maybe use a short array where positive values are simply the unsigned value of the actual byte, and -1 can be a marker for the end of the array.<br>
*/<br>
int c_write(struct circular_buffer <em>buf, char… data) {<br>
/</em> do stuff */<br>
}</p>
<p>void construct_mypacket(struct circular_buffer <em>buf, int foo, short bar) {<br>
/</em> let’s just pretend c_write uses a short array with -1 as a marker */<br>
c_write(buf, P_C(123), P_C(0), P_S(bar), P_I(0xdeadbeef), P_I(foo), P_END);<br>
}[/code]</p>
<p>Well, it’s not much of a DSL, is it?<br>
Ultimately it may just be better to suck it up and use your current API, and if it really becomes a nuisance,  make nifty Lua bindings for packet construction.</p>
<aside class="quote quote-modified" data-post="31" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/blakeman8192/40/5_e05bb34c421432ee4d40de30c10af3e5.png" class="avatar"> blakeman8192:</div>
<blockquote>
<p>[quote author=Lothy link=topic=480598.msg3533334#msg3533334 date=1300371066]although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<p>This so hard.</p>
<p>On another note, you should’ve used C++ if you wanted this to be open-source for the community to use.   It’s just a more common, widely used, and versatile language than C nowadays.[/quote]<br>
Yes, Java not having function pointers is actually a pain in the ass.  Sorry most people don’t like as much boilerplate as you do.</p>
<p>What a crock of shit.  C is still more common/used than C++ is, though the adoption rate is probably less.  What makes C++ more versatile than C?  Some features of C++ would be nice, like exceptions and templates, but much of it isn’t really deal breaking (yes, OOP included, sorry).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/32">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/32</link>
        <pubDate>Fri, 01 Apr 2011 17:07:54 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-32</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@system system]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/system">@system</a> wrote:</p>
          <blockquote>
              <aside class="quote quote-modified" data-post="25" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<aside class="quote quote-modified" data-post="25" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<aside class="quote quote-modified" data-post="25" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<aside class="quote quote-modified" data-post="25" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<aside class="quote quote-modified" data-post="25" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>although now that I’ve come into function pointers, the lack of them in java pisses me off a lot</p>
</blockquote>
</aside>
<p>This so hard.</p>
<p>On another note, you should’ve used C++ if you wanted this to be open-source for the community to use.   It’s just a more common, widely used, and versatile language than C nowadays.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/31">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/31</link>
        <pubDate>Fri, 01 Apr 2011 16:15:09 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-31</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Hey man, thanks for taking the time to look at it in such depth. I’ll try to address things as best I can, and I’ll undoubtedly have questions too before this reply is finished.</p>
<p>Regarding the bit_packer files, particularly the [font=andale mono]free_bit_buffer[/font] function, those two things are intentional.<br>
[font=andale mono]free_char_buffer[/font] actually has that function signature because it was intended to be a callback that would be used by the libevent API.</p>
<p>My original design involved providing a struct bit_buffer which would then be written to, and then committed to libevent. Once that commit was made, my code could free the bit_buffer – when libevent was finished writing the underlying char *, it would then invoke that callback to free it as well.</p>
<p>I decided that this was rather poor design, so bit_packer.h/c are artifacts that I haven’t gotten around to removing yet. I’ve now actually moved the bit packer functions into circular_buffer.c, and they write to the buffer in there.<br>
Sorry about that, but if nothing else at least it’s blatantly obvious now that I made the right decision in ditching that approach.</p>
<p>As for the bit regarding the semantics of [font=andale mono]write_bits[/font], I agree with you. [font=andale mono]cwrite_bits[/font] in circular_buffer.c follows your suggestion.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/circular_buffer.c</span><br>
Hopefully this macro is right now: WRAP_WRITE_PTR(x, y) ((x) % (y))</p>
<p>As for the rest, I’m not sure how I could apply macros in place of functions for the writing to the buffer. I’ll keep it in mind though and do some searching, because there is a large amount of code in there and it would be ideal to improve it where possible.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/config.c</span><br>
I haven’t gotten far with this. Originally I was just playing around seeing how I could parse it. I was actually going to use a lexer, but they all seem to be under GPL (my code, on the other hand, is licensed under the BSD license).<br>
It’s low priority at the moment, mostly because I just want to get it to a working stage.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/item.c</span><br>
I presume you’re talking about the following:</p>
<pre><code class="lang-auto"></code></pre>
<p>As far as I can remember, there are less than 14000 unique items in the game at the moment. I guess I can increase it to 15k or more to future proof it for a while, but I don’t really see the value in making it too much larger than the current item count.</p>
<p>For now, I’ve defined a value as 15000:</p>
<pre><code class="lang-auto">#ifndef MAX_ITEM_DEFINITIONS
#define MAX_ITEM_DEFINITIONS 15000
#endif</code></pre>
<p>Down the track I’ll either a) document it so that people know that they can define the value at build time or, better yet, b) fix configuration loading up nicely and have it set there.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/linkedlist.c</span><br>
Done. Thanks for pointing that out.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/listener.c</span><br>
I’ve changed [font=andale mono]load_event_base[/font]. I’ve also moved the disconnection code to its own function (well, the calls to free the bufferevent and client structs).<br>
Whether this is what you meant by disconnecting cleanly, I’m not entirely sure.<br>
I’ve followed your advice too with regards to the client structure, and it now has its own allocation/deallocation functions (client_create() and client_free()).</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/module_loader.c</span><br>
This is a tricky one for me. <img src="https://forum.moparisthebest.com/images/emoji/twitter/stuck_out_tongue.png?v=5" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"> As you’ve probably noticed, the only windows-related code is found in the [font=andale mono]load_event_base[/font] function. It’s actually only there because I based that code heavily, if not completely, on their example code.</p>
<p>I don’t actually have access to a windows system to build and test the code on, so it’s pretty futile for me to cater to windows at this stage.<br>
I’m really hoping that someone chooses to come on board at a later stage for that once it’s a working product. Worst case though, it is on my TODO list.</p>
<p>Thanks for catching the lack of [font=andale mono]closedir[/font] calls; I’ve fixed that, and I’ve removed the call to exit() as well.</p>
<p>What are the alternatives to strcat? I know that Theo de Raadt wrote a few functions, specifically strlcat and strlcpy, for OpenBSD. These haven’t been adopted in glibc though, and likely never will be.<br>
According to the wikipedia article (<a href="http://en.wikipedia.org/wiki/Strlcat" rel="nofollow noopener">http://en.wikipedia.org/wiki/Strlcat</a>), strncat and strncpy are fairly shit.<br>
Are there any others that I’ve missed?<br>
For what it’s worth, I’ve ensured that all of the char arrays that I use are null-terminated.</p>
<p>Anyway, I’ve changed it so that [font=andale mono]full_module_name[/font] is allocated on the heap and then freed after the call to [font=andale mono]dlopen[/font]; this should stop any potential buffer overflows.</p>
<p>I imagine the most ideal way to do module loading would be by defining a few macros, with definitions depending on whether it was being built on windows or a unix-like system.<br>
I’ll get to that down the track.</p>
<p>[hr]</p>
<p><span class="bbcode-b">src/packet_decoder.c and src/packet_sender.c</span><br>
Fixed.</p>
<p><span class="bbcode-b">src/region.c</span><br>
Fixed, thanks for that. I wasn’t exactly sure how the allocation of n-dimensional arrays worked.</p>
<p><span class="bbcode-b">src/server.c</span><br>
Fixed. I’ve removed the test code too.</p>
<p>Again, thank you so much for all of that feedback. Obviously not many people on this forum make use of C, so your input is extremely valuable to me.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/30">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/30</link>
        <pubDate>Fri, 01 Apr 2011 10:53:15 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-30</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Cheese_Police c|p]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/cheese_police">@Cheese_Police</a> wrote:</p>
          <blockquote>
              <p>I have no idea why I looked into this as much as I did, but here we go…</p>
<p><span class="bbcode-b">src/bit_packer.c</span><br>
[hr]</p>
<p>[ul][li][font=andale mono]free_bit_buffer[/font] doesn’t free the buffer allocated[/li]<br>
[li][font=andale mono]free_bit_buffer[/font] and [font=andale mono]free_char_buffer[/font] have inconsistent signatures ([font=andale mono]int[/font] vs [font=andale mono]void[/font] return values).  Is [font=andale mono]free_char_buffer[/font] needed?[/li]<br>
[li][font=andale mono]write_bits[/font] <a href="https://github.com/Lothy/Dionysus/blob/master/src/bit_packer.c#L64" data-bbcode="true" rel="nofollow noopener">@64</a>:  This code should have nothing to do with players directly.  If the function fails, return with an appropriate value and let the calling code take care of it.[/li][/ul]</p>
<p><span class="bbcode-b">src/circular_buffer.c</span><br>
[hr]</p>
<p>[ul][li][font=andale mono]WRAP_WRITE_PTR[/font] should surround its arguments with parentheses: (((x) % (y)).[/li]<br>
[li]Writing to the buffer looks like it could get pretty disgusting (due to long names).  It’s not really avoidable, but it might be worth your time to come up with something to make it more readable (macros?).[/li][/ul]</p>
<p><span class="bbcode-b">src/config.c</span><br>
[hr]</p>
<p>[ul][li]Instead of having a fixed list of options and retaining them as individual global variables, store options in a table (even arbitrary tag names).[/li]<br>
[li]The parsing code should be a bit more flexible (whitespace, possibly allow for comments);  some sanity checks would be good too (bad syntax).[/li][/ul]</p>
<p><span class="bbcode-b">src/item.c</span><br>
[hr]<br>
[ul][li]A fixed amount of items is understandable, but will you always need the same amount? (different revisions)[/li][/ul]</p>
<p><span class="bbcode-b">src/linkedlist.c</span><br>
[hr]<br>
[ul][li][font=andale mono]linkedlist_create[/font] should zero the structure it allocates.[/li]<br>
[li][font=andale mono]linkedlist_insert_tail[/font] should zero the structure it allocates.[/li][/ul]</p>
<p><span class="bbcode-b">src/listener.c</span><br>
[hr]<br>
[ul][li][font=andale mono]load_event_base[/font] should return a null pointer instead of calling [font=andale mono]exit[/font].[/li]<br>
[li][font=andale mono]sock_write_cb[/font] and [font=andale mono]sock_event_cb[/font] should cleanly disconnect and safely deallocate the client (cleanup function for the client structure).[/li][/ul]</p>
<p><span class="bbcode-b">src/module_loader.c</span><br>
[hr]<br>
[ul][li]You should support different platforms (Windows) appropriately:  use POSIX API when available, don’t assume ‘.so’ suffix.[/li]<br>
[li][font=andale mono]load_modules[/font] doesn’t [font=andale mono]closedir[/font] when it returns after error.  In addition, exit shouldn’t be used in the event of failure.[/li]<br>
[li][font=andale mono]load_module[/font] has a fixed (and really short!) length char array for the path.  [font=andale mono]strcat[/font] should be avoided in favor of more secure alternatives.[/li][/ul]</p>
<p><span class="bbcode-b">src/packet_decoder.c</span><br>
[hr]<br>
[ul][li][font=andale mono]set_login_decoder[/font], [font=andale mono]set_packet_decoder_table[/font], and [font=andale mono]set_packet_sizes_table[/font] shouldn’t [font=andale mono]exit[/font] on failure.[/li][/ul]</p>
<p><span class="bbcode-b">src/packet_sender.c</span><br>
[hr]<br>
[ul][li][font=andale mono]set_send_packet_table[/font] shouldn’t [font=andale mono]exit[/font] on failure.[/li][/ul]</p>
<p><span class="bbcode-b">src/region.c</span><br>
[hr]<br>
[ul][li][font=andale mono]init_region_list[/font] can just zero the whole region list at the same time ([font=andale mono]sizeof(struct region) * REGION_COUNT * REGION_COUNT * REGION_HEIGHT[/font]).[/li][/ul]</p>
<p><span class="bbcode-b">src/server.c</span><br>
[hr]<br>
[ul][li]Tests should be completely separate from the main source tree.[/li]<br>
[li][font=andale mono]set_player_update_function[/font] and [font=andale mono]set_npc_update_function[/font] shouldn’t [font=andale mono]exit[/font] on failure.[/li][/ul]</p>
<p>I understand this is still fairly new, and that a lot of things are just hacked together or prototyped, which is fine.  It would be good to check out the way you write code, consistency in naming/signatures and leaning more towards ‘Do one thing and do it well’ will (hopefully) remove some of the pains with writing something like this.</p>
<p>However, it looks OK so far.  You may want to look into <a href="http://software.schmorp.de/pkg/libev.html" data-bbcode="true" rel="nofollow noopener">libev</a> as an alternative to libevent.  It’s updated somewhat often and has something else good about it which I forget, ask Mopman.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/29">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/29</link>
        <pubDate>Fri, 01 Apr 2011 02:10:30 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-29</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@xEnt xEnt]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xent">@xEnt</a> wrote:</p>
          <blockquote>
              <p>looks nice lothy keep it up legend</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/28">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/28</link>
        <pubDate>Sun, 27 Mar 2011 04:45:33 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-28</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Because Java’s poor man’s function pointers are, for all intents and purposes, implementing an interface over and over again. That’s as close as it comes.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/27">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/27</link>
        <pubDate>Sat, 26 Mar 2011 07:02:33 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-27</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@thiefmn6092 thiefmn6092]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/thiefmn6092">@thiefmn6092</a> wrote:</p>
          <blockquote>
              <p>hey Lothy, nice project, I checked it out</p>
<p><img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> I will talk to you in IRC about some ideas I have</p>
<p>out of curiosity, why do you think you need function pointers so much?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/26">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/26</link>
        <pubDate>Sat, 26 Mar 2011 01:08:47 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-26</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Boils down to a few things:</p>
<p>a) I’ve never written anything non-trivial in C (or C++ - but I don’t like C++ enough to use it)<br>
b) I wanted to change this, because I was sick of being one of these newfag programmers that ONLY uses C#/Java. Both of these languages are quite good (although now that I’ve come into function pointers, the lack of them in java pisses me off a lot), but using them exclusively is pretty bad imo.<br>
c) Because I wanted to see a server that made use of Lua for scripting<br>
d) The RS emulation scene deserves a native solution just like the WoW scene<br>
e) Because I’m a mushroom cloud laying motherfucker, motherfucker!</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/25">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/25</link>
        <pubDate>Thu, 17 Mar 2011 14:11:06 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-25</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Rixxx Rix_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rixxx">@Rixxx</a> wrote:</p>
          <blockquote>
              <p>Out of curiosity, why are you writing this server in C?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/24">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/24</link>
        <pubDate>Thu, 17 Mar 2011 11:49:12 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-24</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Metho_D Method]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/metho_d">@Metho_D</a> wrote:</p>
          <blockquote>
              <p>[quote=“Graham, post:22, topic:384832”][quote author=boomer216 link=topic=480598.msg3531361#msg3531361 date=1300205264]<br>
I actually read in a recent developer blog on their Engine, that they’ve added the ability for game logic to process in 50ms ticks for some of their newer content. At least I think it was 50ms if my memory is correct. But other then that, up until rev 600+, they’ve confirmed that all their logic is processed in 600ms ticks.<br>
[/quote]</p>
<p>That’s interesting. Do you have a link to it? I did some quick searching but couldn’t find it…[/quote]</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="http://www.runescape.com/img/global/favicon.ico?1" class="site-icon" width="32" height="32">
      <a href="http://services.runescape.com/m=forum/forums.ws?25,26,405,62276896" target="_blank" rel="nofollow noopener">RuneScape</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="http://www.runescape.com/img/microsite/social-share-fb.jpg" class="thumbnail"></div>

<h3><a href="http://services.runescape.com/m=forum/forums.ws?25,26,405,62276896" target="_blank" rel="nofollow noopener">RuneScape Forum - Community Forums for Clans, Feedback &amp; Discussion</a></h3>

<p>Join the discussion on the official RuneScape forum. Share your thoughts with the community, ask questions, find help, learn about events and much more.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Specifically:</p>
<blockquote>Q. As we know and stated by Andrew the game runs at 600ms intervals (one tick). Is there a reason for this exact number? Could the game benefit from lower interval, for example 300ms?
<p>A. Some upcoming features in the server tick at a 50ms rate. The overall 600ms tick remains, as the content relies on having this time interval available as a base, but we’re not limited by it.<br>
Mod_jackh</p>
</blockquote>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/23">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/23</link>
        <pubDate>Tue, 15 Mar 2011 22:09:02 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-23</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Graham Graham]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/graham">@Graham</a> wrote:</p>
          <blockquote>
              <aside class="quote quote-modified" data-post="21" data-topic="384832">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/boomer216/40/409_1.png" class="avatar"> boomer216:</div>
<blockquote>
<p>I actually read in a recent developer blog on their Engine, that they’ve added the ability for game logic to process in 50ms ticks for some of their newer content. At least I think it was 50ms if my memory is correct. But other then that, up until rev 600+, they’ve confirmed that all their logic is processed in 600ms ticks.</p>
</blockquote>
</aside>
<p>That’s interesting. Do you have a link to it? I did some quick searching but couldn’t find it…</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/22">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/22</link>
        <pubDate>Tue, 15 Mar 2011 19:53:35 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-22</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@boomer216 boomer216]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/boomer216">@boomer216</a> wrote:</p>
          <blockquote>
              <p>[quote=“Lothy, post:20, topic:384832”]Okay, I’ll look into that later. That’s probably something that Blake is going to need to add to Osiris as well, seeing as the code above is completely based on his.</p>
<p>Thanks.[/quote]</p>
<p>lol if only blake had the motivation to look into that sort of stuff.<br>
he completely refuses to open a client’s source code, most of the update blocks i added.</p>
<p>[quote=“Graham, post:8, topic:384832”]In terms of your question about the ticks Lothy, I’m reasonably sure that the official RuneScape server does all game logic processing in multiples of the 600ms tick so there shouldn’t be any need to lower it.</p>
<p>The update server I wrote for 317 is still up on GitHub and hasn’t been removed yet - <a href="https://github.com/apollo-rsps/jagcached.%5B/quote" rel="nofollow noopener">https://github.com/apollo-rsps/jagcached.[/quote</a>]</p>
<p>I actually read in a recent developer blog on their Engine, that they’ve added the ability for game logic to process in 50ms ticks for some of their newer content. At least I think it was 50ms if my memory is correct. But other then that, up until rev 600+, they’ve confirmed that all their logic is processed in 600ms ticks.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/21">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/21</link>
        <pubDate>Tue, 15 Mar 2011 16:07:44 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-21</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Okay, I’ll look into that later. That’s probably something that Blake is going to need to add to Osiris as well, seeing as the code above is completely based on his.</p>
<p>Thanks.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/20</link>
        <pubDate>Sun, 13 Mar 2011 22:18:41 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-20</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Metho_D Method]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/metho_d">@Metho_D</a> wrote:</p>
          <blockquote>
              <p>You’re missing the first player update block (indicated by 0x100). It’s used for agility and other purposes, and people generally call it “force movement”.</p>
<p>Everything else seems to be in order.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/19</link>
        <pubDate>Sun, 13 Mar 2011 16:48:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-19</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>Just finished writing a function to append player update blocks to the circular buffer.<br>
If anyone wants to have a quick look over it to make sure I haven’t made any silly mistakes, feel free to: <a href="https://github.com/Lothy/Dionysus/blob/master/src/protocols/508.c" rel="nofollow noopener">https://github.com/Lothy/Dionysus/blob/master/src/protocols/508.c</a></p>
<p>In particular, I need clarification that I have a) included all update blocks, b) have them all in the right order (although wrote a quick class as part of Blake’s server and used the comparator to sort a list of all player and npc update block implementations, and then printed them out in order).</p>
<p>Here’s the code if you CBF going to github for some reason :rolleyes:</p>
<pre><code class="lang-auto">int append_player_update_blocks(struct player *player,
        struct circular_buffer *cbuf)
{
    int i;
    int hp_ratio;
    int app_block_start_index;
    unsigned char app_block_size;
    struct item *equip_item;
    struct item_definition *item_def;

    if (player-&gt;update_flags &amp; PUFLAG_SECONDARY_HIT_UPDATE_REQUIRED) {
        cwrite_byte_S(cbuf, player-&gt;secondary_damage.amount);
        cwrite_byte_A(cbuf, player-&gt;secondary_damage.type);
    }

    if (player-&gt;update_flags &amp; PUFLAG_FACE_MOB_UPDATE_REQUIRED) {
        cwrite_short_B(cbuf, player-&gt;mob_to_face);
    }

    if (player-&gt;update_flags &amp; PUFLAG_FORCED_CHAT_UPDATE_REQUIRED) {
        player-&gt;forced_chat[MAX_FORCED_CHAT_LEN - 1] = '\0';
        cwrite_string(cbuf, player-&gt;forced_chat);
    }

    if (player-&gt;update_flags &amp; PUFLAG_GRAPHICS_UPDATE_REQUIRED) {
        cwrite_short_B(cbuf, player-&gt;graphic.graphic_id);
        cwrite_int_M(cbuf, player-&gt;graphic.height);
    }

    if (player-&gt;update_flags &amp; PUFLAG_FACE_POSITION_UPDATE_REQUIRED) {
        cwrite_short_L(cbuf, (player-&gt;face_position_abs_x * 2) + 1);
        cwrite_short_BA(cbuf, (player-&gt;face_position_abs_y * 2) + 1);
    }

    if (player-&gt;update_flags &amp; PUFLAG_CHAT_UPDATE_REQUIRED) {
        cwrite_short_BA(cbuf, player-&gt;chat.effects);
        cwrite_byte_C(cbuf, player-&gt;rights);
        cwrite_byte_C(cbuf, player-&gt;chat.message_len);
        player-&gt;chat.message[MAX_CHAT_LEN - 1] = '\0';
        for (i = 0; i &lt; player-&gt;chat.message_len; ++i) {
            cwrite_byte(cbuf, player-&gt;chat.message[i]);
        }
    }

    if (player-&gt;update_flags &amp; PUFLAG_ANIM_UPDATE_REQUIRED) {
        cwrite_short_B(cbuf, player-&gt;animation.anim_id);
        cwrite_byte_S(cbuf, player-&gt;animation.delay);
    }

    if (player-&gt;update_flags &amp; PUFLAG_APPEARANCE_UPDATE_REQUIRED) {
        app_block_start_index = cwrite_byte(cbuf, 0); /* Placeholder */

        cwrite_byte(cbuf, player-&gt;appearance.gender);
        if ((player-&gt;appearance.gender &amp; 0x2) == 2) {
            cwrite_byte(cbuf, 0);
            cwrite_byte(cbuf, 0);
        }
        cwrite_byte(cbuf, player-&gt;appearance.skull_icon);
        cwrite_byte(cbuf, player-&gt;appearance.head_icon);

        if (player-&gt;appearance.npc_id == -1) {
            for (i = 0; i &lt; 4; ++i) {
                equip_item = &amp;player-&gt;equipped_items[i];
                if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                    item_def = get_item_definition(equip_item-&gt;item_id);
                    cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
                }
                else {
                    cwrite_byte(cbuf, 0);
                }
            }

            /* Chest slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_CHEST];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                item_def = get_item_definition(equip_item-&gt;item_id);
                cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_CHEST]);
            }

            /* Shield slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_SHIELD];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                item_def = get_item_definition(equip_item-&gt;item_id);
                cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
            }
            else {
                cwrite_byte(cbuf, 0);
            }

            /* Arms slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_CHEST];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                if (!is_full_body(equip_item-&gt;item_id)) {
                    cwrite_short_B(cbuf, 0x100
                            + player-&gt;appearance.looks[APPEARANCE_ARMS]);
                }
                else {
                    cwrite_byte(cbuf, 0);
                }
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_ARMS]);
            }

            /* Legs slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_LEGS];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                item_def = get_item_definition(equip_item-&gt;item_id);
                cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_LEGS]);
            }

            /* Head slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_HAT];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                if (is_full_helm(equip_item-&gt;item_id) || is_full_mask(
                        equip_item-&gt;item_id)) {
                    cwrite_byte(cbuf, 0);
                }
                else {
                    cwrite_short_B(cbuf, 0x100
                            + player-&gt;appearance.looks[APPEARANCE_HEAD]);
                }
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_HEAD]);
            }

            /* Hands slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_HANDS];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                item_def = get_item_definition(equip_item-&gt;item_id);
                cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_HANDS]);
            }

            /* Feet slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_FEET];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                item_def = get_item_definition(equip_item-&gt;item_id);
                cwrite_short_B(cbuf, 32768 + item_def-&gt;equip_id);
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_FEET]);
            }

            /* Beard slot */
            equip_item = &amp;player-&gt;equipped_items[EQUIPMENT_HAT];
            if (equip_item-&gt;item_id != NO_ITEM_EQUIPPED) {
                if (is_full_mask(equip_item-&gt;item_id)) {
                    cwrite_byte(cbuf, 0);
                }
                else {
                    cwrite_short_B(cbuf, 0x100
                            + player-&gt;appearance.looks[APPEARANCE_BEARD]);
                }
            }
            else {
                cwrite_short_B(cbuf, 0x100
                        + player-&gt;appearance.looks[APPEARANCE_BEARD]);
            }
        }
        else {
            cwrite_short_B(cbuf, -1);
            cwrite_short_B(cbuf, player-&gt;appearance.npc_id);
        }

        for (i = 0; i &lt; 7; ++i) {
            cwrite_byte(cbuf, player-&gt;appearance.colours[i]);
        }

        /* Animation indices */
        cwrite_short_B(cbuf, player-&gt;appearance.stand_anim);
        cwrite_short_B(cbuf, 0x337);
        cwrite_short_B(cbuf, player-&gt;appearance.walk_anim);
        cwrite_short_B(cbuf, 0x334);
        cwrite_short_B(cbuf, 0x335);
        cwrite_short_B(cbuf, 0x336);
        cwrite_short_B(cbuf, player-&gt;appearance.run_anim);

        cwrite_long_B(cbuf, player-&gt;username_hash);
        cwrite_byte(cbuf, player-&gt;combat_level);
        cwrite_short_B(cbuf, 0);

        /*
* We now need to write the size of the appearance
* update block into the placeholder that we
* set aside at the start.
* As we're using a circular buffer, we have to test
* for wraparound and deal with it.
*/
        if (cbuf-&gt;write_offset &gt; app_block_start_index) { /* No wraparound */
            app_block_size = cbuf-&gt;write_offset - app_block_start_index;
            cbuf-&gt;buffer[app_block_start_index] = app_block_size;
        }
        else { /* Wraparound occurred */
            app_block_size = cbuf-&gt;write_offset;
            app_block_size += sizeof(cbuf-&gt;buffer) - app_block_start_index;
            cbuf-&gt;buffer[app_block_start_index] = app_block_size;
        }
    }

    if (player-&gt;update_flags &amp; PUFLAG_PRIMARY_HIT_UPDATE_REQUIRED) {
        if (player-&gt;cur_skill_levels[SKILL_HITPOINTS] &lt; 0) {
            player-&gt;cur_skill_levels[SKILL_HITPOINTS] = 0;
        }

        hp_ratio = (player-&gt;cur_skill_levels[SKILL_HITPOINTS] * 255)
                / player-&gt;max_skill_levels[SKILL_HITPOINTS];
        if (hp_ratio &gt; 255) {
            hp_ratio = 255;
        }

        cwrite_byte_S(cbuf, player-&gt;primary_damage.amount);
        cwrite_byte_S(cbuf, player-&gt;primary_damage.type);
        cwrite_byte_S(cbuf, hp_ratio);
    }
    return 1;
}

int append_npc_update_blocks(struct npc *npc, struct circular_buffer *cbuf)
{
    if (npc-&gt;update_flags &amp; NUFLAG_FACE_MOB_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_NPC_TRANSFORM_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_FORCED_CHAT_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_ANIM_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_GRAPHICS_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_SECONDARY_HIT_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_FACE_POSITION_UPDATE_REQUIRED) {

    }

    if (npc-&gt;update_flags &amp; NUFLAG_PRIMARY_HIT_UPDATE_REQUIRED) {

    }
    return 1;
}</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/18</link>
        <pubDate>Sun, 13 Mar 2011 14:45:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-18</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@lothy Lothy]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/lothy">@lothy</a> wrote:</p>
          <blockquote>
              <p>On a happy note, I’ve just made some changes following frank_'s advice.<br>
Previously I was using an if block to check for wraparound. Now the code uses the modulo operator for all wraparound detection (bitpacker as well).</p>
<p>Basically that part of the code should perform a lot better.<br>
Hopefully I’ll have some time to make some more major progress on Wednesday and Thursday, as those two are uni-free (and with any luck I’ll actually be well rested lol).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/17</link>
        <pubDate>Mon, 07 Mar 2011 15:03:51 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-17</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@moparisthebest Moparisthebest]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/moparisthebest">@moparisthebest</a> wrote:</p>
          <blockquote>
              <p>I’ll have a go at that later and report back, it would be great if it was that simple. <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/16</link>
        <pubDate>Mon, 07 Mar 2011 02:19:41 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-16</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Metho_D Method]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/metho_d">@Metho_D</a> wrote:</p>
          <blockquote>
              <p>At first glance, the only thing that looks problematic is your dumpFile method in the Main class (org.moparscape.cacheutils.v508.Main). It appears that you sometimes write more data to the file than you should. At the end of all files in the cache (with the exception of those with index = 255), a two-byte version value is appended that is used to see if a file is outdated and should be requested. The server doesn’t send this data with the file – the client appends it after the file has been received. If this is the problem, you should be able to fix it by modifying the loop on line 141 to go from [0…data.length - 2] instead of [0…data.length] if index != 255.</p>
<p>Hope that helps.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/15</link>
        <pubDate>Mon, 07 Mar 2011 01:04:37 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-15</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
      <item>
        <title>My C server so far</title>
        <dc:creator><![CDATA[@Jython super_]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/jython">@Jython</a> wrote:</p>
          <blockquote>
              <p>[quote=“Metho D, post:13, topic:384832”][quote author=Moparisthebest link=topic=480598.msg3521696#msg3521696 date=1299445830]</p>
<aside class="quote">
<blockquote>
<aside class="quote">
<blockquote>
<p>The 317 update server in MoparScape 4 works perfectly as well, it’s the 508 no one seems to be able to get right.</p>
</blockquote>
</aside>
<p>I didn’t have any problems implementing an update server for one of the newer clients (600+), and I don’t think 508 is very different.</p>
</blockquote>
</aside>
<p>Do you care to share it? Or at least have a look at mine and see where I went wrong?<br>
[/quote]</p>
<p>I don’t know if I still have it, but I can take a look at yours if you provide the code.[/quote]</p>
<p>maybe you should read his thread.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/my-c-server-so-far/384832/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/my-c-server-so-far/384832/14</link>
        <pubDate>Sun, 06 Mar 2011 23:14:24 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-384832-14</guid>
        <source url="https://forum.moparisthebest.com/t/my-c-server-so-far/384832.rss">My C server so far</source>
      </item>
  </channel>
</rss>
