<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/bcel-issues-calling-a-synthetic-method/437662 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 04:55:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>[BCEL] Issues calling a synthetic method - General Programming - moparisthebest.com</title>
    <meta name="description" content="Alright, I started to experiment with this stuff again.  

[code=java]/*  * To change this template, choose Tools | Templates  * and open the template in the editor.  */ package bceltest; 

import java.io.IOException; im&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="437662.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;[BCEL] Issues calling a synthetic method&#39;" href="437662.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/bcel-issues-calling-a-synthetic-method/437662" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/bcel-issues-calling-a-synthetic-method/437662" />
<meta property="og:title" content="[BCEL] Issues calling a synthetic method" />
<meta name="twitter:title" content="[BCEL] Issues calling a synthetic method" />
<meta property="og:description" content="Alright, I started to experiment with this stuff again.  [code=java]/*   To change this template, choose Tools | Templates and open the template in the editor.  */  package bceltest;  import java.io.IOException;  import java.util.logging.Level;  import java.util.logging.Logger;  import org.apache.bcel.;  import org.apache.bcel.classfile.;  import org.apache.bcel.generic.*;  /**  *    @author Owner  */  public class BCELTest {  /**    @param args the command line arguments  */  public static void..." />
<meta name="twitter:description" content="Alright, I started to experiment with this stuff again.  [code=java]/*   To change this template, choose Tools | Templates and open the template in the editor.  */  package bceltest;  import java.io.IOException;  import java.util.logging.Level;  import java.util.logging.Logger;  import org.apache.bcel.;  import org.apache.bcel.classfile.;  import org.apache.bcel.generic.*;  /**  *    @author Owner  */  public class BCELTest {  /**    @param args the command line arguments  */  public static void..." />
<meta property="article:published_time" content="2012-03-27T21:45:34+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="437662.html">[BCEL] Issues calling a synthetic method</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/general-programming.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>General Programming</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/n3ss3s.html'><span itemprop='name'>n3ss3s</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2012-03-27T21:45:34Z'>
            <time itemprop='dateModified' datetime='2016-08-02T16:51:28Z' class='post-time'>
              August 2, 2016,  4:51pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Alright, I started to experiment with this stuff again.</p>
<p>[code=java]/*</p>
<ul>
<li>To change this template, choose Tools | Templates</li>
<li>and open the template in the editor.<br>
*/<br>
package bceltest;</li>
</ul>
<p>import java.io.IOException;<br>
import java.util.logging.Level;<br>
import java.util.logging.Logger;<br>
import org.apache.bcel.<em>;<br>
import org.apache.bcel.classfile.</em>;<br>
import org.apache.bcel.generic.*;</p>
<p>/**<br>
*</p>
<ul>
<li>
<p><span class="mention">@author</span> Owner<br>
*/<br>
public class BCELTest {</p>
<p>/**</p>
<ul>
<li>
<p><a class="mention" href="../../u/param.html">@param</a> args the command line arguments<br>
*/<br>
public static void main(String[] args) {<br>
// TODO code application logic here<br>
String path = “C:/Users/Owner/Documents/NetBeansProjects/BCELTest/build/classes/bceltest/BCELTest.class”;<br>
try {<br>
ClassParser classParser = new ClassParser(path);<br>
JavaClass javaClass = classParser.parse();</p>
<pre><code> ClassGen classGen = new ClassGen("Frankenstein", "java.lang.Object", "Frankenstein.java", Constants.ACC_PUBLIC, null);
 ConstantPoolGen constantPoolGen = classGen.getConstantPool();
 InstructionList instructionList = new InstructionList();

 Method xm = javaClass.getMethods()[2]; // 2 = dummyMethod
 MethodGen mg = new MethodGen(xm, "Frankenstein", new ConstantPoolGen(javaClass.getConstantPool()));
 System.out.println(mg.getMethod().getCode());
 INVOKEVIRTUAL iv = new INVOKEVIRTUAL(constantPoolGen.addMethodref(mg));
 //mg.setMaxLocals();
 //mg.setMaxStack(); I don't need these for a pre made method do I?
 classGen.addMethod(mg.getMethod());

 mg = new MethodGen(Constants.ACC_PUBLIC | Constants.ACC_STATIC, Type.VOID, new Type[]{new ArrayType(Type.STRING, 1)}, new String[]{"args"}, "main", "Frankenstein", instructionList, constantPoolGen);

 instructionList.append(new GETSTATIC(constantPoolGen.addFieldref("java.lang.System", "out", "Ljava/io/PrintStream;")));
 instructionList.append(new LDC(constantPoolGen.addString("IT'S ALIVE")));
 instructionList.append(iv);
 instructionList.append(new RETURN());
 mg.setMaxLocals();
 mg.setMaxStack();
 classGen.addMethod(mg.getMethod());
 
 for (Method m : classGen.getMethods()) {
     System.out.println("-- Method name: " + m.getName() + " : "+m.getSignature()); // It admits that dummyMethod exists.
     for (Type t : m.getArgumentTypes())
         System.out.println("---- "+t);
 }
 System.out.println(mg.getMethod().getCode());
 classGen.getJavaClass().dump("C:/Users/Owner/Desktop/Frankenstein.class");
</code></pre>
<p>} catch (IOException ex) {<br>
Logger.getLogger(BCELTest.class.getName()).log(Level.SEVERE, null, ex);<br>
}<br>
}</p>
</li>
</ul>
<p>public void dummyMethod(String s) {<br>
System.out.println(s + " z0mg");<br>
}<br>
}[/code]</p>
</li>
</ul>
<p>The source you’re looking at is the code of BCELTest.class (in the path variable inside the main method), and what I’m trying to do here is create a new class with BCEL, with 2 methods - a copy of dummyMethod and a main method which calls dummyMethod.</p>
<p>When I run Frankenstein.class, turns out there is no constant pool entry <span class="hashtag">#130</span>. Any ideas on why does it think so? (I’m assuming because I used the old CP to create the MethodGen, but how else…?)</p>
<p><code>Exception in thread "main" java.lang.ClassFormatError: Illegal constant pool ind
ex 130 for method name in class file Frankenstein
        at java.lang.ClassLoader.defineClass1(Native Method)
        at java.lang.ClassLoader.defineClass(Unknown Source)
        at java.security.SecureClassLoader.defineClass(Unknown Source)
        at java.net.URLClassLoader.defineClass(Unknown Source)
        at java.net.URLClassLoader.access$100(Unknown Source)
        at java.net.URLClassLoader$1.run(Unknown Source)
        at java.net.URLClassLoader$1.run(Unknown Source)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.net.URLClassLoader.findClass(Unknown Source)
        at java.lang.ClassLoader.loadClass(Unknown Source)
        at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)
        at java.lang.ClassLoader.loadClass(Unknown Source)
        at sun.launcher.LauncherHelper.checkAndLoadMain(Unknown Source)</code></p>
<p>Leaving all the other fuckups I’ve probably done there aside, are there some general issues when snatching a method and inserting it into another class?</p>
      </div>

      <meta itemprop='headline' content='[BCEL] Issues calling a synthetic method'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/slavemaster.html'><span itemprop='name'>slavemaster</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2012-03-28T02:28:10Z'>
            <time itemprop='dateModified' datetime='2016-08-02T16:51:44Z' class='post-time'>
              August 2, 2016,  4:51pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>You’re damn right the entry doesn’t exist. You can’t simply copy the method code because all of the pointers into the constant pool are invalidated.<br>
You may think that this is copying the constant pool:</p>
<p><code>
            MethodGen mg = new MethodGen(xm, "Frankenstein", new ConstantPoolGen(javaClass.getConstantPool()));</code><br>
… and you’d be wrong. This constant pool is used internally for resolving constant pool references and potentially adding UTF8 entries for the names of various classes and attributes as well as class entries for exception types. If you want the references to resolve normally with minimal effort, you can set Frankenstein’s generative constant pool to a copy of BCELTest’s. Note that your constant pool will be bloated with entries that are unused as a result.</p>
<p>Or, alternatively, you can use ASM which eliminates the constant pool at read-time and recreates it when writing.</p>
      </div>

      <meta itemprop='headline' content='[BCEL] Issues calling a synthetic method'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/bcel-issues-calling-a-synthetic-method/437662 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 04:55:53 GMT -->
</html>
