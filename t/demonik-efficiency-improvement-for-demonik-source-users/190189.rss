<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Demonik Efficiency Improvement: For Demonik source users</title>
    <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189</link>
    <description>Since a lot of servers use the Demonik source now which is the most advanced public release but still contains many inefficiencies and &#39;memory-leaks&#39; (depending on the context you use that term), I figured while I continue to work on the server on localhost for educational purposes, I&#39;d post certain &#39;efficiency enhancements&#39; I come across.

[b]Aggressive NPCs[/b]

This system I coded was very poorly designed. It uses [font=Courier New]AggressiveNpcScanner[/font] in package [font=Courier New]npchandler[/font]. It scans periodically to a set timer invoked inside [font=Courier New]GameEngine[/font], and it scans ALL registered NPCs, and then ALL registered players. What&#39;s wrong with that? Well, if you have, say, 1000 aggressive NPCs spawned, and 100 players online, you&#39;re scanning 1000 x 100 [font=Courier New]Mob[/font]s (equivalent to 100,000 loops [i]per second[/i] in Demonik&#39;s [font=Courier New]GameEngine[/font]). This is an exaggerated example, but when you&#39;re playing on a server like GlowingDagger with a large player and aggressive NPC population, this can become a [i]very[/i] arduous task for the server. And it also has that [font=Courier New]activeNpcs[/font] Vector, I&#39;m not entirely sure why I even added that, but considering the NPCs are never properly removed once added, there&#39;s a good chance that will hinder server performance over a long period of uptime.

My suggestion: move the scanner into the local [font=Courier New]Npc[/font] mob object&#39;s [font=Courier New]updatePosition()[/font] function which is called every 600ms in [font=Courier New]GameEngine[/font] ([font=Courier New]clientUpdater.updateClients()[/font]). This is the same technique RSCDaemon used.

// Note: [font=Courier New]getViewedArea(int x1, int y1, int x2, int y2)[/font] in [font=Courier New]model.ViewArea[/font] must be publicized. 

[font=Courier New]Npc.java[/font]

[code]


    .    .    .


	/**
	 * Searches within a 2-square radius for
	 * any players that can be attacked.
	 *
	 * @return An aggressive NPC Player target.
	 */
	private Player searchForTarget()
	{
		Tile[][] tiles = getViewArea().getViewedArea(2, 2, 2, 2); // 2 is the NPC&#39;s attack radius
		
		for(int x = 0; x &lt; tiles.length; x++)
		{
			for(int y = 0; y &lt; tiles[x].length; y++)
			{
				Tile tile = tiles[x][y];
				
				if(tile != null)
				{
					for(Player pl : tile.getPlayers())
					{
						// Check if the player can be attacked, and if they&#39;re within this NPC&#39;s loc roam
						// area (with a leniency of 4 squares).
						if(pl.isBusy() || System.currentTimeMillis() - pl.getCombatTimer() &lt; 3000 ||
						   pl.getLocation().getX() &gt; getLoc().maxX() + 4 ||
						   pl.getLocation().getX() &lt; getLoc().minX() - 4 ||
						   pl.getLocation().getY() &gt; getLoc().maxY() + 4 ||
						   pl.getLocation().getY() &lt; getLoc().minY() - 4)
						continue; // Out of bounds or unattackable
						
						iif(pl.getCombatLevel() &lt; (getCombatLevel() * 2) + 1 || getLocation().inWilderness())
							return pl;
					}
				}
			}
		}
		
		return null;
	}

	/**
	 * Moves the NPC. If the NPC is aggressive, then it
	 * will perform a short scan of the tiles immediately
	 * surrounding it for players.
	 */
	public void updatePosition() 
	{
		try
		{
			if(isBusy() || inCombat()) // This NPC is already busy.
				return;
				
			// Aggressive scanning
			{
				if(getDef().isAggressive() || getLocation().inNormalWilderness()) // If NPC is aggressive and/or in wildy
				{
					Player target = null;
					
					if(System.currentTimeMillis() - getCombatTimer() &gt;= 3000 &amp;&amp; (target = searchForTarget()) != null)
					{
						world.getDelayedEventHandler().add(new com.rscd.event.AttackMobEvent(this, target));
						return; // Don&#39;t continue to regular movement.
					}
				}
			}
			// Regular movement
			{
				if(System.currentTimeMillis() - lastMovement &gt; 2500) 
				{
					if(DataConversions.random(0, 2) == 1) 
					{
						int x = DataConversions.random(loc.minX(), loc.maxX());
						int y = DataConversions.random(loc.minY(), loc.maxY());
						
						if(world.getTile(x, y).isWalkable() &amp;&amp; !world.getTile(x, y).hasGameObject() &amp;&amp; world.getTile(x, y).getNpcs().size() == 0) // If the tile is walkable and there&#39;s no npcs on it.
							setPath(x, y, new byte[0], new byte[0]);
					}
					
					super.setLastMoved();
				}
				
				super.updatePosition();
			}
		} catch(Exception e)
		{
			e.printStackTrace();
			Logger.log(&quot;Strange error with &quot; + getDef().getName() + &quot;&#39;s updatePosition(): &quot; + e.getMessage());
		}
	}


    .    .    .


[/code]

Done. Remove [font=Courier New]npchandler.AggressiveNpcScanner[/font] and all its references from [font=Courier New]GameEngine[/font] and [font=Courier New]packethandler.WalkRequest[/font].

All I can be bothered to suggest today, I&#39;ll post more during the week. Feel free to post your own efficiency improvements for other developers to consider.

&lt;3, punKrockeR.</description>
    
    <lastBuildDate>Wed, 19 Mar 2008 16:49:17 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Peter Peeter]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/peter">@Peter</a> wrote:</p>
          <blockquote>
              <p>Punk, could you PM me your MSN?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/23">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/23</link>
        <pubDate>Wed, 19 Mar 2008 16:49:17 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-23</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>Ahhh, so you’re talking about optimizing the ViewArea’s getPlayersInView(), I thought you were talking only about the aggressive NPC system. I understand what you mean now, and I think I agree. Scanning each tile would probably use more resources than scanning the entire player base, even if there was 100-300 players, but it’s hard to test properly.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/22">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/22</link>
        <pubDate>Wed, 19 Mar 2008 16:40:19 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-22</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@system system]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/system">@system</a> wrote:</p>
          <blockquote>
              <p>What I mean is the following:</p>
<p>For players (Entity.java and ViewArea.java):</p>
<p>[code]public final boolean getIsWithinRadius(Entity comparisonEntity, int radius) {<br>
return getIsWithinRadius(comparisonEntity.getCurrentPosition(), radius);<br>
}</p>
<p>public final boolean getIsWithinRadius(Tile comparisonTile, int radius) {<br>
int deltaX = comparisonTile.getX() - currentPosition.getX();<br>
int deltaY = comparisonTile.getY() - currentPosition.getY();</p>
<pre><code> return (deltaX &gt;= -radius &amp;&amp; deltaX &lt; radius) &amp;&amp; (deltaY &gt;= -radius &amp;&amp; deltaY &lt; radius);
</code></pre>
<p>}[/code]</p>
<p>[code]public static List getPlayersInView(Player referencedPlayer) {<br>
List players = new ArrayList();</p>
<pre><code> if(referencedPlayer == null) {
      return players;
 }
 
 for(Player player : World.getInstance().getPlayers()) {
      if(player != null &amp;&amp; referencedPlayer.getIsWithinRadius(player, 14) &amp;&amp; referencedPlayer != player) {
           players.add(player);
      }
 }
 
 return players;
</code></pre>
<p>}[/code]</p>
<p>For NPCs:<br>
The standard RSCD-Tile-checking algorithm. Same as I guess you used in Demonik?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/21">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/21</link>
        <pubDate>Wed, 19 Mar 2008 14:36:40 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-21</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>Hmm, it wasn’t my idea, it was commented out in the original eggsampler RSCD source. I didn’t think about NPC/players, and I guess they realised after coding it and commented it out. I guess you could tap into the owner Mob’s watchedEntities.hasChanged() stuff instead of using coordinates as the cache’s decider, but it’s probably not worth the trouble considering it takes less than 1 millisecond to calculate the view area in most (if not all) cases, so the cache idea is probably useless.</p>
<p>And ephemeral, you’re saying you think the old method would be more efficient?</p>
<pre><code class="lang-auto">for(Player p : world.getPlayers())
{
    if(within2squaresOfNpc(p.getLocation())
    {
        // aggro npc handling
    }
}</code></pre>
<p>I guess it would be faster on a small scale server, but personally, I reckon it’d be faster on more populated servers to consider only the NPC’s surrounding tiles and their player entities individually like the example I posted rather than scanning the entire world, but I haven’t actually tested the performance like I did with ViewArea, so I could be wrong.</p>
<p>Whichever method people choose to use, I’d still give the AggressiveNpcScanner a brush-up since it wasn’t coded to be efficient, only to work regardless of how badly it affects performance.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/20">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/20</link>
        <pubDate>Wed, 19 Mar 2008 09:44:16 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-20</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Stork Stork]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/stork">@Stork</a> wrote:</p>
          <blockquote>
              <p>ephemeral, it might be the Sake, or it might be that you aren’t making any sense. Either way I don’t get it.</p>
<p>Rancid, nice idea with the cached viewarea, that works great if stuff around you isn’t moving - so for objects it’ll work, npcs/players I don’t see how it would.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/19">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/19</link>
        <pubDate>Wed, 19 Mar 2008 05:35:08 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-19</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@system system]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/system">@system</a> wrote:</p>
          <blockquote>
              <p>It would probably be better to iterate through all Player-entities, NPC-entities or such, and check to see if they are within the referenced Players view instead. I mean, all Tiles are pretty much static, and always there, so in average it would require more loops to be done at all times, instead of just using the current amount of either Players or NPCs.</p>
<p>I find this to be a more efficient way, but I am not sure about everyone else…</p>
<p>Perhaps you can combine both methods, and use the original RSCD-way on NPCs, and the other on Players.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/18">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/18</link>
        <pubDate>Tue, 18 Mar 2008 16:28:36 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-18</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>[quote=“Peter, post:11, topic:190189”]So far so well <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Hope it stands.</p>
<p>Just a side note,</p>
<pre><code class="lang-auto">if(pl.getCombatLevel() &lt; (getCombatLevel() * 2) + 1 || getLocation().inWilderness())
     return pl;</code></pre>
<p>Otherwise wilderness NPCs won’t attack higher combat people (disables AFKing at axes for high levels etc).[/quote]</p>
<p>Shit, sorry, I fixed that after posting the code and forget to update the post, thanks.</p>
<aside class="quote no-group" data-post="10" data-topic="190189">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/stork/40/5_6bca9977b612b7aeef77ba1ec1cd67b3.png" class="avatar"> Stork:</div>
<blockquote>
<p>ViewArea can be improved upon too. Original RSCD had a lot of unnecessary array copying, dunno if demonik is the same.</p>
</blockquote>
</aside>
<p>I had a look through it, I didn’t see anything that was particularly inefficient. I re-implemented caching the ViewArea:</p>
<p>[code]<br>
private Tile[][] getViewedArea(int x1, int y1, int x2, int y2)<br>
{<br>
int mobX = mob.getX();<br>
int mobY = mob.getY();</p>
<pre><code>	if(mobX == cachedX &amp;&amp; mobY == cachedY &amp;&amp; cachedViewArea != null)
	{
		System.out.println("Returning cached view area for " + (mob instanceof Player ? ((Player)mob).getUsername() : "NPC"));
		return cachedViewArea;
	} else
	{[/code]
</code></pre>
<p>And made it print out the time it took to generate a new clipped ViewArea, but it doesn’t seem to be slow at all:</p>
<blockquote>[java] Returning new view area for Rancid: took 0ms
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning new view area for Rancid: took 0ms
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid
[java] Returning cached view area for Rancid</blockquote>
<p>So I’m not sure how much more ViewArea could be optimized and if it’s worth the trouble.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/17</link>
        <pubDate>Tue, 18 Mar 2008 05:16:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-17</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Peter Peeter]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/peter">@Peter</a> wrote:</p>
          <blockquote>
              <p>[quote=“FloRida, post:15, topic:190189”][quote author=Peter link=topic=253235.msg2116687#msg2116687 date=1205807292]<br>
Few dupes that are included in the V7 source released by Alex/Punk:</p>
<ol>
<li>Type ::logout and drop an item the same time as you enter log out.</li>
<li>Xing during combat saves your account right then, but doesn’t log you out until the fight is over (still drops your items).</li>
<li>Logging in and out fast on low HP and having your mate try to attack you will result in him fighting “null” but still getting your items.</li>
<li>Sending the drop packet over and over really fast.</li>
</ol>
<p>All of these have a very simple fix.</p>
<p>[/quote]<br>
nice finds :)[/quote]</p>
<p>Thanks to all the testers at GD <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/16</link>
        <pubDate>Tue, 18 Mar 2008 02:41:26 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-16</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@FloRida FloRida]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/florida">@FloRida</a> wrote:</p>
          <blockquote>
              <p>[quote=“Peter, post:14, topic:190189”]Few dupes that are included in the V7 source released by Alex/Punk:</p>
<ol>
<li>Type ::logout and drop an item the same time as you enter log out.</li>
<li>Xing during combat saves your account right then, but doesn’t log you out until the fight is over (still drops your items).</li>
<li>Logging in and out fast on low HP and having your mate try to attack you will result in him fighting “null” but still getting your items.</li>
<li>Sending the drop packet over and over really fast.</li>
</ol>
<p>All of these have a very simple fix.[/quote]<br>
nice finds <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/15</link>
        <pubDate>Tue, 18 Mar 2008 02:38:55 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-15</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Peter Peeter]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/peter">@Peter</a> wrote:</p>
          <blockquote>
              <p>Few dupes that are included in the V7 source released by Alex/Punk:</p>
<ol>
<li>Type ::logout and drop an item the same time as you enter log out.</li>
<li>Xing during combat saves your account right then, but doesn’t log you out until the fight is over (still drops your items).</li>
<li>Logging in and out fast on low HP and having your mate try to attack you will result in him fighting “null” but still getting your items.</li>
<li>Sending the drop packet over and over really fast.</li>
</ol>
<p>All of these have a very simple fix.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/14</link>
        <pubDate>Tue, 18 Mar 2008 02:28:12 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-14</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Vrunk Vrunk]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/vrunk">@Vrunk</a> wrote:</p>
          <blockquote>
              <p>[size=16pt]<span class="bbcode-b">Password Encryption</span>[/size]</p>
<p><span class="bbcode-u"><br>
[size=12pt]<span class="bbcode-b">JAVA</span>[/size]</span><br>
PlayerLoader.java</p>
<p>At the top add a constant:</p>
<p><span class="bbcode-b">private static final String	AES_128_KEY	= “Your 128 bit key”;</span></p>
<p>You can always add the AES_128_KEY to be loaded from Conf.java if you wish, i just stuck the constant in playerloader for now.</p>
<p>Add:</p>
<p><code>
import javax.crypto.*;
import javax.crypto.spec.*;</code></p>
<p>Modify:</p>
<p><code>			/** Welcome details **/
			result = Server.db.getQuery("SELECT * FROM `user_credentials` " + whereSQL);
			if(!result.next() || !(p.getPassword()).equalsIgnoreCase(result.getString("pass"))) 
			{
				return 3; // Invalid username or password
			}</code><br>
To</p>
<p>[code]			/** Welcome details * */<br>
result = Server.db.getQuery("SELECT * FROM <code>user_credentials</code> " + whereSQL);<br>
if (!result.next())<br>
{<br>
return 3; // Invalid username or password<br>
}</p>
<pre><code>		/** Password Decryption * */
		Cipher cipher = Cipher.getInstance("AES");
		SecretKeySpec skeySpec = new SecretKeySpec(AES_128_KEY.getBytes(), "AES");
		cipher.init(Cipher.DECRYPT_MODE, skeySpec);
		byte[] encryptedPassword = result.getBytes("pass");
		byte[] decryptedBytes = cipher.doFinal(encryptedPassword);
		String decryptedPassword = new String(decryptedBytes);

		if (!(p.getPassword().equalsIgnoreCase(decryptedPassword)))
		{
			return 3; // Invalid username or password
		}[/code]
</code></pre>
<p><span class="bbcode-u">[size=12pt]<span class="bbcode-b">PHP</span>[/size]</span><br>
Registration.php</p>
<p>Add:<br>
<span class="bbcode-b">$AES_128_KEY = “Your 128 bit key”;</span></p>
<p>Wherever you register your player password to the database, add this instead of <span class="bbcode-b">‘$password1’</span></p>
<p><span class="bbcode-b">AES_ENCRYPT(’$password1’, ‘$AES_128_KEY’)</span></p>
<p><span class="bbcode-u">[size=12pt]<span class="bbcode-b">MySQL</span>[/size]</span><br>
Change your password field to hold “blob” variables. This is very important.</p>
<hr>
<p>Enjoy - I think I’m done with RSC development for a while, since all the servers get shut down so easily, and avoiding trademarks is a bitch. You can generate keys <a href="http://www.andrewscompanies.com/tools/wep.asp" data-bbcode="true" rel="nofollow noopener"><span class="bbcode-b">Here</span></a>, or just make them yourself.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/13</link>
        <pubDate>Mon, 17 Mar 2008 22:55:27 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-13</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@D.Shark D.Shark]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/d.shark">@D.Shark</a> wrote:</p>
          <blockquote>
              <p>Nicely done, didn’t expect anyone to post their methods here so this is a pretty cool selfless post.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/12</link>
        <pubDate>Mon, 17 Mar 2008 21:53:49 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-12</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Peter Peeter]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/peter">@Peter</a> wrote:</p>
          <blockquote>
              <p>So far so well <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Hope it stands.</p>
<p>Just a side note,</p>
<pre><code class="lang-auto">if(pl.getCombatLevel() &lt; (getCombatLevel() * 2) + 1 || getLocation().inWilderness())
     return pl;</code></pre>
<p>Otherwise wilderness NPCs won’t attack higher combat people (disables AFKing at axes for high levels etc).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/11</link>
        <pubDate>Mon, 17 Mar 2008 20:06:09 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-11</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Stork Stork]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/stork">@Stork</a> wrote:</p>
          <blockquote>
              <p>ViewArea can be improved upon too. Original RSCD had a lot of unnecessary array copying, dunno if demonik is the same.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/10</link>
        <pubDate>Mon, 17 Mar 2008 14:30:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-10</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>Thanks Peter. Actually, GD inspired this post, because I was annoyed at how slow AFK training was on its server due to the shit scanning system, lol.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/9</link>
        <pubDate>Mon, 17 Mar 2008 14:04:48 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-9</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Peter Peeter]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/peter">@Peter</a> wrote:</p>
          <blockquote>
              <p>Great, thanks there. I’ll look into it when I get home from Uni.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/8</link>
        <pubDate>Mon, 17 Mar 2008 11:58:29 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-8</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@xEnt xEnt]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xent">@xEnt</a> wrote:</p>
          <blockquote>
              <p>Guys it doesn’t have to be exactly how storkpk was, im sure people wont mind an ingame NPC and not having a control panel. Its not that much difference for now.</p>
<p>Good job punKrockeR</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/7</link>
        <pubDate>Mon, 17 Mar 2008 11:45:28 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-7</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@woooooo woooooo]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/woooooo">@woooooo</a> wrote:</p>
          <blockquote>
              <p>Sorry, tommy has done all the coding so far, as he won’t let me see the source.  But I am also working on one by myself to see if I can do it.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/6</link>
        <pubDate>Mon, 17 Mar 2008 10:31:18 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-6</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@gawdz666 gawdz666]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/gawdz666">@gawdz666</a> wrote:</p>
          <blockquote>
              <aside class="quote no-group" data-post="4" data-topic="190189">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/letter_avatar/woooooo/40/5_6bca9977b612b7aeef77ba1ec1cd67b3.png" class="avatar"> woooooo:</div>
<blockquote>
<p>I’m currently working on a stork replica, having troubles with making a cpanel for it as I know no php at all.  But like I said, you really pushed rsc server development up there man.  I give you major kudos <img src="https://forum.moparisthebest.com/images/emoji/twitter/smiley.png?v=6" title=":smiley:" class="emoji" alt=":smiley:"></p>
</blockquote>
</aside>
<p>^^</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/5</link>
        <pubDate>Mon, 17 Mar 2008 10:11:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-5</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@woooooo woooooo]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/woooooo">@woooooo</a> wrote:</p>
          <blockquote>
              <p>I’m currently working on a stork replica, having troubles with making a cpanel for it as I know no php at all.  But like I said, you really pushed rsc server development up there man.  I give you major kudos <img src="https://forum.moparisthebest.com/images/emoji/twitter/smiley.png?v=6" title=":smiley:" class="emoji" alt=":smiley:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/4</link>
        <pubDate>Mon, 17 Mar 2008 10:01:12 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-4</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>Thanks, and yeah, I agree. Demonik was poorly developed because it was used as a learning tool, meaning it was generally developed using bad habits and techniques which I never really noticed or corrected until the project was finished and I started looking back over it lol. But I strongly encourage everyone to continue private RSC server development (and public development, if you wish to demonstrate your accomplishments and accept the potential risks involved). Coming from personal experience, it’s the most rewarding and most fun Java learning environment for people interested in Java game development who come from a RSC-background (and RS2 dev for people coming from a RS2 background, I guess).</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/3</link>
        <pubDate>Mon, 17 Mar 2008 09:42:52 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-3</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@woooooo woooooo]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/woooooo">@woooooo</a> wrote:</p>
          <blockquote>
              <p>I was saying to people that demonik had too many unnecessary loops.  Good job on the source, and thanks for helping improve RSC servers.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/2</link>
        <pubDate>Mon, 17 Mar 2008 09:28:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-2</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
      <item>
        <title>Demonik Efficiency Improvement: For Demonik source users</title>
        <dc:creator><![CDATA[@Rancid2 Rancid`.]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/rancid2">@Rancid2</a> wrote:</p>
          <blockquote>
              <p>Since a lot of servers use the Demonik source now which is the most advanced public release but still contains many inefficiencies and ‘memory-leaks’ (depending on the context you use that term), I figured while I continue to work on the server on localhost for educational purposes, I’d post certain ‘efficiency enhancements’ I come across.</p>
<p><span class="bbcode-b">Aggressive NPCs</span></p>
<p>This system I coded was very poorly designed. It uses [font=Courier New]AggressiveNpcScanner[/font] in package [font=Courier New]npchandler[/font]. It scans periodically to a set timer invoked inside [font=Courier New]GameEngine[/font], and it scans ALL registered NPCs, and then ALL registered players. What’s wrong with that? Well, if you have, say, 1000 aggressive NPCs spawned, and 100 players online, you’re scanning 1000 x 100 [font=Courier New]Mob[/font]s (equivalent to 100,000 loops <span class="bbcode-i">per second</span> in Demonik’s [font=Courier New]GameEngine[/font]). This is an exaggerated example, but when you’re playing on a server like GlowingDagger with a large player and aggressive NPC population, this can become a <span class="bbcode-i">very</span> arduous task for the server. And it also has that [font=Courier New]activeNpcs[/font] Vector, I’m not entirely sure why I even added that, but considering the NPCs are never properly removed once added, there’s a good chance that will hinder server performance over a long period of uptime.</p>
<p>My suggestion: move the scanner into the local [font=Courier New]Npc[/font] mob object’s [font=Courier New]updatePosition()[/font] function which is called every 600ms in [font=Courier New]GameEngine[/font] ([font=Courier New]clientUpdater.updateClients()[/font]). This is the same technique RSCDaemon used.</p>
<p>// Note: [font=Courier New]getViewedArea(int x1, int y1, int x2, int y2)[/font] in [font=Courier New]model.ViewArea[/font] must be publicized.</p>
<p>[font=Courier New]Npc.java[/font]</p>
<pre><code class="lang-auto">

    .    .    .


	/**
	 * Searches within a 2-square radius for
	 * any players that can be attacked.
	 *
	 * @return An aggressive NPC Player target.
	 */
	private Player searchForTarget()
	{
		Tile[][] tiles = getViewArea().getViewedArea(2, 2, 2, 2); // 2 is the NPC's attack radius
		
		for(int x = 0; x &lt; tiles.length; x++)
		{
			for(int y = 0; y &lt; tiles[x].length; y++)
			{
				Tile tile = tiles[x][y];
				
				if(tile != null)
				{
					for(Player pl : tile.getPlayers())
					{
						// Check if the player can be attacked, and if they're within this NPC's loc roam
						// area (with a leniency of 4 squares).
						if(pl.isBusy() || System.currentTimeMillis() - pl.getCombatTimer() &lt; 3000 ||
						   pl.getLocation().getX() &gt; getLoc().maxX() + 4 ||
						   pl.getLocation().getX() &lt; getLoc().minX() - 4 ||
						   pl.getLocation().getY() &gt; getLoc().maxY() + 4 ||
						   pl.getLocation().getY() &lt; getLoc().minY() - 4)
						continue; // Out of bounds or unattackable
						
						iif(pl.getCombatLevel() &lt; (getCombatLevel() * 2) + 1 || getLocation().inWilderness())
							return pl;
					}
				}
			}
		}
		
		return null;
	}

	/**
	 * Moves the NPC. If the NPC is aggressive, then it
	 * will perform a short scan of the tiles immediately
	 * surrounding it for players.
	 */
	public void updatePosition() 
	{
		try
		{
			if(isBusy() || inCombat()) // This NPC is already busy.
				return;
				
			// Aggressive scanning
			{
				if(getDef().isAggressive() || getLocation().inNormalWilderness()) // If NPC is aggressive and/or in wildy
				{
					Player target = null;
					
					if(System.currentTimeMillis() - getCombatTimer() &gt;= 3000 &amp;&amp; (target = searchForTarget()) != null)
					{
						world.getDelayedEventHandler().add(new com.rscd.event.AttackMobEvent(this, target));
						return; // Don't continue to regular movement.
					}
				}
			}
			// Regular movement
			{
				if(System.currentTimeMillis() - lastMovement &gt; 2500) 
				{
					if(DataConversions.random(0, 2) == 1) 
					{
						int x = DataConversions.random(loc.minX(), loc.maxX());
						int y = DataConversions.random(loc.minY(), loc.maxY());
						
						if(world.getTile(x, y).isWalkable() &amp;&amp; !world.getTile(x, y).hasGameObject() &amp;&amp; world.getTile(x, y).getNpcs().size() == 0) // If the tile is walkable and there's no npcs on it.
							setPath(x, y, new byte[0], new byte[0]);
					}
					
					super.setLastMoved();
				}
				
				super.updatePosition();
			}
		} catch(Exception e)
		{
			e.printStackTrace();
			Logger.log("Strange error with " + getDef().getName() + "'s updatePosition(): " + e.getMessage());
		}
	}


    .    .    .

</code></pre>
<p>Done. Remove [font=Courier New]npchandler.AggressiveNpcScanner[/font] and all its references from [font=Courier New]GameEngine[/font] and [font=Courier New]packethandler.WalkRequest[/font].</p>
<p>All I can be bothered to suggest today, I’ll post more during the week. Feel free to post your own efficiency improvements for other developers to consider.</p>
<p>&lt;3, punKrockeR.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189/1</link>
        <pubDate>Mon, 17 Mar 2008 09:24:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-190189-1</guid>
        <source url="https://forum.moparisthebest.com/t/demonik-efficiency-improvement-for-demonik-source-users/190189.rss">Demonik Efficiency Improvement: For Demonik source users</source>
      </item>
  </channel>
</rss>
