<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/trace-back-value/426560 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 08:44:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Trace back value - General Programming - moparisthebest.com</title>
    <meta name="description" content="I am using the BCEL API to create a deob cleaner and was wondering if anyone knew the best possible way to trace back to find a value that was pushed onto the stack for a current operation: 

       39: sipush        255&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="426560.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Trace back value&#39;" href="426560.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/trace-back-value/426560" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/trace-back-value/426560" />
<meta property="og:title" content="Trace back value" />
<meta name="twitter:title" content="Trace back value" />
<meta property="og:description" content="I am using the BCEL API to create a deob cleaner and was wondering if anyone knew the best possible way to trace back to find a value that was pushed onto the stack for a current operation:        39: sipush        255       42: aload_0              43: getfield      #91                 // Field aByteArray1260:[B       46: aload_0              47: getfield      #93                 // Field anInt1258:I       50: iconst_m1            51: iadd                 52: baload       [b]53: iand[/b] &lt;- Cur..." />
<meta name="twitter:description" content="I am using the BCEL API to create a deob cleaner and was wondering if anyone knew the best possible way to trace back to find a value that was pushed onto the stack for a current operation:        39: sipush        255       42: aload_0              43: getfield      #91                 // Field aByteArray1260:[B       46: aload_0              47: getfield      #93                 // Field anInt1258:I       50: iconst_m1            51: iadd                 52: baload       [b]53: iand[/b] &lt;- Cur..." />
<meta property="article:published_time" content="2011-12-24T02:42:27+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="426560.html">Trace back value</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/general-programming.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>General Programming</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-24T02:42:27Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:44:38Z' class='post-time'>
              August 2, 2016,  2:44pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I am using the BCEL API to create a deob cleaner and was wondering if anyone knew the best possible way to trace back to find a value that was pushed onto the stack for a current operation:</p>
<pre><code class="lang-auto">      39: sipush        255
      42: aload_0       
      43: getfield      #91                 // Field aByteArray1260:[B
      46: aload_0       
      47: getfield      #93                 // Field anInt1258:I
      50: iconst_m1     
      51: iadd          
      52: baload
      [b]53: iand[/b] &lt;- Current operation.</code></pre>
<p>I want to trace to stack back to the SIPUSH 255 instruction so that I can then fix it to be:</p>
<pre><code class="lang-auto">      42: aload_0       
      43: getfield      #91                 // Field aByteArray1260:[B
      46: aload_0       
      47: getfield      #93                 // Field anInt1258:I
      50: iconst_m1     
      51: iadd          
      52: baload    
      /: sipush        255/    
      53: iand  </code></pre>
      </div>

      <meta itemprop='headline' content='Trace back value'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/slavemaster.html'><span itemprop='name'>slavemaster</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-24T04:02:34Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:44:50Z' class='post-time'>
              August 2, 2016,  2:44pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>semaphore wrote something that would be useful for this purpose but I think he posted it in the CM board.<br>
Basically, you can backtrack by analyzing the stack height…</p>
<p><a href="http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#consumeStack(org.apache.bcel.generic.ConstantPoolGen)" class="onebox" target="_blank" rel="nofollow noopener">http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#consumeStack(org.apache.bcel.generic.ConstantPoolGen)</a><br>
<a href="http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#produceStack(org.apache.bcel.generic.ConstantPoolGen)" class="onebox" target="_blank" rel="nofollow noopener">http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#produceStack(org.apache.bcel.generic.ConstantPoolGen)</a></p>
<p>To some degree this can be seen as a limited form of data-flow analysis.</p>
<p>In this particular case:</p>
<pre><code class="lang-auto">/* given:
      ConstantPoolGen pool;
      InstructionHandle iand;
 */
InstructionHandle cursor = iand;
int height = -cursor.consumeStack(pool);
while (height != 0) {
    cursor = cursor.getPrev();
    Instruction instr = cursor.getInstruction();

    /* update the relative stack height */
    height += instr.produceStack(pool);
    height -= instr.consumeStack(pool);
}
InstructionHandle sipush = cursor;

/* height || instruction
    -0 +1 || sipush        255
    -0 +1 || aload_0       
    -1 +1 || getfield      #91                 // Field aByteArray1260:[B
    -0 +1 || aload_0       
    -1 +1 || getfield      #93                 // Field anInt1258:I
    -0 +1 || iconst_m1     
    -2 +1 || iadd          
    -2 +1 || baload
    -2 +1 || iand
 */</code></pre>
<p>To be frank, however, what you really should be looking into is building a primitive expression tree. You can deal with a higher-level abstraction than raw individual instructions.</p>
      </div>

      <meta itemprop='headline' content='Trace back value'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/sinisoul.html'><span itemprop='name'>sinisoul</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-24T05:18:19Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:45:08Z' class='post-time'>
              August 2, 2016,  2:45pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>[quote=“veer, post:2, topic:426560”]semaphore wrote something that would be useful for this purpose but I think he posted it in the CM board.<br>
Basically, you can backtrack by analyzing the stack height…</p>
<p><a href="http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#consumeStack(org.apache.bcel.generic.ConstantPoolGen)" class="onebox" target="_blank" rel="nofollow noopener">http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#consumeStack(org.apache.bcel.generic.ConstantPoolGen)</a><br>
<a href="http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#produceStack(org.apache.bcel.generic.ConstantPoolGen)" class="onebox" target="_blank" rel="nofollow noopener">http://commons.apache.org/bcel/apidocs/org/apache/bcel/generic/Instruction.html#produceStack(org.apache.bcel.generic.ConstantPoolGen)</a></p>
<p>To some degree this can be seen as a limited form of data-flow analysis.</p>
<p>In this particular case:</p>
<pre><code class="lang-auto">/* given:
      ConstantPoolGen pool;
      InstructionHandle iand;
 */
InstructionHandle cursor = iand;
int height = -cursor.consumeStack(pool);
while (height != 0) {
    cursor = cursor.getPrev();
    Instruction instr = cursor.getInstruction();

    /* update the relative stack height */
    height += instr.produceStack(pool);
    height -= instr.consumeStack(pool);
}
InstructionHandle sipush = cursor;

/* height || instruction
    -0 +1 || sipush        255
    -0 +1 || aload_0       
    -1 +1 || getfield      #91                 // Field aByteArray1260:[B
    -0 +1 || aload_0       
    -1 +1 || getfield      #93                 // Field anInt1258:I
    -0 +1 || iconst_m1     
    -2 +1 || iadd          
    -2 +1 || baload
    -2 +1 || iand
 */</code></pre>
<p>To be frank, however, what you really should be looking into is building a primitive expression tree. You can deal with a higher-level abstraction than raw individual instructions.[/quote]</p>
<p>I was thinking the same thing. For the most part I am just practicing analyzing the stack,</p>
<pre><code class="lang-auto">AND {
	ADD {
		LDC
		MUL {
			ADD {
				LDC
				MUL {
					MUL {
						LOAD 3
						LOAD 3
					}
					SIPUSH
				}
			}
			LOAD 3
		}
	}
	LDC
}	</code></pre>
<pre><code class="lang-auto">      23: ldc           #64                 // int 2147483647
      25: iload_3       
      26: sipush        15731
      29: iload_3       
      30: iload_3       
      31: imul          
      32: imul          
      33: ldc           #65                 // int 789221
      35: iadd          
      36: imul          
      37: ldc           #66                 // int 1376312589
      39: iadd         
      40: iand      </code></pre>
<p>And from what you just said I can see where you are coming from.</p>
<p>How are the local parameters for a method referenced in the stack? Just wondering.</p>
      </div>

      <meta itemprop='headline' content='Trace back value'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/slavemaster.html'><span itemprop='name'>slavemaster</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-12-24T05:37:52Z'>
            <time itemprop='dateModified' datetime='2016-08-02T14:45:10Z' class='post-time'>
              August 2, 2016,  2:45pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>From experience, eliminating the stack and introducing temporary stack variables makes dealing with stack-based optimization easier (eliminating dups and swaps). From there you can just simplify and reduce the expression tree until it’s down to something like this:</p>
<pre><code class="lang-auto"></code></pre>
<p>About referencing arguments, they’re stored as local variables so you’d need to push them on the stack with a load instruction taking an appropriate index.<br>
<a href="http://java.sun.com/docs/books/jvms/second_edition/html/Overview.doc.html#15722" class="onebox" target="_blank" rel="nofollow noopener">http://java.sun.com/docs/books/jvms/second_edition/html/Overview.doc.html#15722</a></p>
<blockquote>The Java virtual machine uses local variables to pass parameters on method invocation. On class method invocation any parameters are passed in consecutive local variables starting from local variable 0. On instance method invocation, local variable 0 is always used to pass a reference to the object on which the instance method is being invoked (this in the Java programming language). Any parameters are subsequently passed in consecutive local variables starting from local variable 1.</blockquote>
      </div>

      <meta itemprop='headline' content='Trace back value'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/trace-back-value/426560 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Aug 2019 08:44:53 GMT -->
</html>
