<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Help with NPC chat and Quests</title>
    <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998</link>
    <description>Hello all,

I would like to start adding quests but I&#39;ve only been programming in Python and haven&#39;t used Java in a few months now.

Is it possible, and if so where, should I write a function so that all I have to write in the &lt;NPCname&gt;.class file something like:

NPCspeak(&quot;Hello there, are you lost?&quot;)
NPCspeak(&quot;Or are you looking for something?&quot;)

This would result in the normal conversation...the function would add the wait time between each speech line, etc.

Also what file should I assign players numbers like DRUIDIC_RITUAL == 0 for each quest so when a player has completed a certain stage of the quest, I can write DRUIDIC_RITUAL++ (or however Java increments an integer by 1) to progress the player into the next stage, and once DRUIDIC_RITUAL++ has be executed, that number remains saved to the player, so when they log out their DRUIDIC_RITUAL is the same as when they logged out.</description>
    
    <lastBuildDate>Mon, 25 Feb 2013 08:16:43 +0000</lastBuildDate>
    <category>Runescape</category>
    <atom:link href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@CodeForFame CodeForFame]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/codeforfame">@CodeForFame</a> wrote:</p>
          <blockquote>
              <p>[quote=“yong min, post:16, topic:400998”][quote author=CodeForFame link=topic=498054.msg4237475#msg4237475 date=1361645936]</p>
<aside class="quote">
<blockquote>
<aside class="quote">
<blockquote>
<p>The only system that reads like that, and allows you to use proper delays would be the new system in MoparClassic.</p>
</blockquote>
</aside>
<p>What delays are you insinuating, exactly? Chat dialogue delays? I am more than positive you’ve used this bsh system, therefore you’ll know the delays work more than ok.<br>
[/quote][quote=yong min]<code>public void NpcTalk(String msg) {
                player.informOfNpcMessage(new ChatMessage(npc, msg, player));
                Wait(2000);
        }</code>[/quote]</p>
<p>2000ms is not the proper delay for all npc messages.</p>
</blockquote>
</aside>
<p>What’s proper delay for NPC message?[/quote]They’re all multiples of 600ms. Though, I’m pretty sure there are a few different lengths.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/17">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/17</link>
        <pubDate>Mon, 25 Feb 2013 08:16:43 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-17</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@yong_min yong min]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/yong_min">@yong_min</a> wrote:</p>
          <blockquote>
              <p>[quote=“CodeForFame, post:14, topic:400998”][quote author=yong min link=topic=498054.msg4236544#msg4236544 date=1361596282]</p>
<aside class="quote">
<blockquote>
<p>The only system that reads like that, and allows you to use proper delays would be the new system in MoparClassic.</p>
</blockquote>
</aside>
<p>What delays are you insinuating, exactly? Chat dialogue delays? I am more than positive you’ve used this bsh system, therefore you’ll know the delays work more than ok.<br>
[/quote][quote=yong min]<code>public void NpcTalk(String msg) {
                player.informOfNpcMessage(new ChatMessage(npc, msg, player));
                Wait(2000);
        }</code>[/quote]</p>
<p>2000ms is not the proper delay for all npc messages.[/quote]</p>
<p>What’s proper delay for NPC message?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/16">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/16</link>
        <pubDate>Sat, 23 Feb 2013 21:37:42 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-16</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@Wife_Beater Wife Beater]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/wife_beater">@Wife_Beater</a> wrote:</p>
          <blockquote>
              <p>Regarding BSH scripting, I got it all to work, however if I click off a set of options using the "PickOption(“blah, “blah, blah”);” method and try talking to another npc, the dialogue does not switch npcs. Example: If I talk to a man (ID 011) and click off the set of options, then talk to a guard, the man will be saying the guards lines. How do I fix this?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/15">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/15</link>
        <pubDate>Sat, 23 Feb 2013 20:29:50 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-15</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@CodeForFame CodeForFame]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/codeforfame">@CodeForFame</a> wrote:</p>
          <blockquote>
              <p>[quote=“yong min, post:12, topic:400998”][quote author=CodeForFame link=topic=498054.msg4236349#msg4236349 date=1361580254]<br>
The only system that reads like that, and allows you to use proper delays would be the new system in MoparClassic.<br>
[/quote]</p>
<p>What delays are you insinuating, exactly? Chat dialogue delays? I am more than positive you’ve used this bsh system, therefore you’ll know the delays work more than ok.[/quote]</p><blockquote><code>public void NpcTalk(String msg) {
                player.informOfNpcMessage(new ChatMessage(npc, msg, player));
                Wait(2000);
        }</code></blockquote>
<p>2000ms is not the proper delay for all npc messages.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/14">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/14</link>
        <pubDate>Sat, 23 Feb 2013 18:58:56 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-14</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@Nothing1 -Nothing]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/nothing1">@Nothing1</a> wrote:</p>
          <blockquote>
              <p>Don’t use BSH scripting to make a quests…</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/13">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/13</link>
        <pubDate>Sat, 23 Feb 2013 14:33:59 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-13</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@yong_min yong min]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/yong_min">@yong_min</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="11" data-topic="400998">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/codeforfame/40/3743_1.png" class="avatar"> CodeForFame:</div>
<blockquote>
<p>The only system that reads like that, and allows you to use proper delays would be the new system in MoparClassic.</p>
</blockquote>
</aside>
<p>What delays are you insinuating, exactly? Chat dialogue delays? I am more than positive you’ve used this bsh system, therefore you’ll know the delays work more than ok.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/12">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/12</link>
        <pubDate>Sat, 23 Feb 2013 05:11:22 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-12</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@CodeForFame CodeForFame]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/codeforfame">@CodeForFame</a> wrote:</p>
          <blockquote>
              <p>The only system that reads like that, and allows you to use proper delays would be the new system in MoparClassic.</p>
<p>Here is one example:<br>
<a href="https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/npchandler/ToKaramja.scala" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/npchandler/ToKaramja.scala</a></p>
<p>You can see more here:<br>
<a href="https://github.com/Lothy/MoparClassic/tree/pre-beta/GameServer/src/org/moparscape/msc/gs/npchandler" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Lothy/MoparClassic/tree/pre-beta/GameServer/src/org/moparscape/msc/gs/npchandler</a></p>
<p>To actually bind it, you add a mapping here:<br>
<a href="https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/service/DialogService.scala" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/service/DialogService.scala</a></p>
<p>For quests, you’d end up creating a class for it, and using the player’s instance of the Quests class.</p>
<p>Quests class:<br>
<a href="https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/model/player/attribute/Quests.scala" class="onebox" target="_blank" rel="nofollow noopener">https://github.com/Lothy/MoparClassic/blob/pre-beta/GameServer/src/org/moparscape/msc/gs/model/player/attribute/Quests.scala</a></p>
<p>You could end up doing something like this to increment a quest stage:</p>
<p><code>
player.quests.set(DruidicRitual.id, 1)</code></p>
<p>To create a quest you could do something like this (not entirely sure this would compile as I’m typing this out in the quick reply box):</p>
<p>[code=Scala]<br>
package org.moparscape.msc.gs.quest</p>
<p>object DruidicRitual {<br>
val id = 0<br>
}</p>
<p>class DruidicRitual extends Quest(DruidicRitual.id, “Duidic Ritual”, 0,  4, 9)[/code]</p>
<p>In the Quests class you’d need to add the quest by changing line 7 to this:</p>
<p><code>
  val quests: java.util.List[Quest] = List(new DruidicRitual)</code></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/11">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/11</link>
        <pubDate>Sat, 23 Feb 2013 00:44:14 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-11</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@yong_min yong min]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/yong_min">@yong_min</a> wrote:</p>
          <blockquote>
              <p>[quote=“xrune, post:9, topic:400998”][quote author=yong min link=topic=498054.msg4236106#msg4236106 date=1361571360]</p>
<p>First of all, download the bsh.jar provided below and place it in your ‘lib’ folder, server side.</p>
<p>BSH.JAR : <a href="http://uppit.com/mihylkhldk4e/bsh.jar%5B/quote%5D" rel="nofollow noopener">http://uppit.com/mihylkhldk4e/bsh.jar[/quote]</a></p>
<p>Bad link? it says file not found[/quote]</p>
<p>Grab the bsh.jar out of BeyondRSC or other. Check lib folder.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/10">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/10</link>
        <pubDate>Fri, 22 Feb 2013 23:54:13 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-10</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@xrune xrune]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xrune">@xrune</a> wrote:</p>
          <blockquote>
              <p>[quote=“yong min, post:8, topic:400998”]First of all, download the bsh.jar provided below and place it in your ‘lib’ folder, server side.</p>
<p>BSH.JAR : <a href="http://uppit.com/mihylkhldk4e/bsh.jar%5B/quote%5D" rel="nofollow noopener">http://uppit.com/mihylkhldk4e/bsh.jar[/quote]</a></p>
<p>Bad link? it says file not found</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/9">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/9</link>
        <pubDate>Fri, 22 Feb 2013 23:33:07 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-9</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@yong_min yong min]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/yong_min">@yong_min</a> wrote:</p>
          <blockquote>
              <p>[quote=“xrune, post:7, topic:400998”][quote author=imthenull link=topic=498054.msg4236018#msg4236018 date=1361563655]<br>
use the npc id in the filename too<br>
[/quote]</p>
<p>I did… do u need to add any code to any java files? to get it to work? whats that code he has written above ^^ for?[/quote]</p>
<p>First of all, download the bsh.jar provided below and place it in your ‘lib’ folder, server side.</p>
<p>BSH.JAR : <a href="http://uppit.com/mihylkhldk4e/bsh.jar" rel="nofollow noopener">http://uppit.com/mihylkhldk4e/bsh.jar</a></p>
<p>In the location where your ‘lib’ folder is created, also create a folder called ‘scripts’. Place the ‘scripts’ folder in the same place as the ‘lib’ folder, <span class="bbcode-b">NOT</span> inside it!</p>
<p>Now open your TalkToNpcHandler class, and replace it all with:</p>
<pre><code class="lang-auto">package org.rscdaemon.server.packethandler.client;

import java.lang.reflect.InvocationTargetException;
import java.util.ConcurrentModificationException;

import org.rscdaemon.server.packethandler.PacketHandler;
import org.rscdaemon.server.model.Npc;
import org.rscdaemon.server.model.World;
import org.rscdaemon.server.model.Player;
import org.rscdaemon.server.net.Packet;
import org.rscdaemon.server.event.WalkToMobEvent;
import org.rscdaemon.server.npchandler.NpcHandler;
import org.rscdaemon.server.util.Logger;
import org.rscdaemon.server.states.Action;
import org.apache.mina.common.IoSession;

public class TalkToNpcHandler implements PacketHandler {
	/**
	 * World instance
	 */
	public static final World world = World.getWorld();

	public void handlePacket(Packet p, IoSession session) throws Exception {
		Player player = (Player)session.getAttachment();
		if(player.isBusy()) {
			player.resetPath();
			return;
		}
		player.resetAll();
		final Npc affectedNpc = world.getNpc(p.readShort());
  		if(affectedNpc == null) { // This shouldn't happen
  			return;
  		}
  		player.setFollowing(affectedNpc);
  		player.setStatus(Action.TALKING_MOB);
  		world.getDelayedEventHandler().add(new WalkToMobEvent(player, affectedNpc, 1) {
			public void arrived() {
				owner.resetPath();
				if(owner.isBusy() || owner.isRanging() || !owner.nextTo(affectedNpc) || owner.getStatus() != Action.TALKING_MOB) {
					return;
				}
				owner.resetAll();
				if(affectedNpc.isBusy()) {
					owner.getActionSender().sendMessage(affectedNpc.getDef().getName() + " is currently busy.");
					return;
				}
				affectedNpc.resetPath();
				NpcHandler handler = world.getNpcHandler(affectedNpc.getID());
				int sprite = 0;

				sprite = getSprite(owner.getLocation().getX(), owner.getLocation().getY(), affectedNpc.getLocation().getX(), affectedNpc.getLocation().getY());
				if(sprite != -1)
					owner.setSprite(sprite);
			//	owner.setNeedsUpdate(true);

				// NPC sprite
				sprite = getSprite(affectedNpc.getLocation().getX(), affectedNpc.getLocation().getY(), owner.getLocation().getX(), owner.getLocation().getY());
				if(sprite != -1)
					affectedNpc.setSprite(sprite);

				affectedNpc.resetPath();
				
				if(world.npcScripts.containsKey(affectedNpc.getID())) {
					owner.setBusy(true);
					affectedNpc.blockedBy(owner);
					if(owner.interpreterThread != null) {
						try {
							owner.interpreterThread.stop();
						} catch(Exception e) {

						}
					}

					owner.interpreterThread = new Thread(new Runnable() {
						public void run() {		
							try {
								new org.rscdaemon.server.model.Script(owner, affectedNpc);	
								owner.setBusy(false);

								affectedNpc.unblock();
							} 
							catch(Exception e) {
								if(!(e instanceof InvocationTargetException)) {
									e.printStackTrace();
								}
								System.out.println(affectedNpc.getID());
								affectedNpc.unblock();
								owner.setBusy(false);
							}
						}
					});
					owner.interpreterThread.start();
				} 
				else				
		      		if(handler != null) {
		      			try {
		      				handler.handleNpc(affectedNpc, owner);
		      			}
		      			catch(Exception e) {
						Logger.error("Exception with npc[" + affectedNpc.getIndex() + "] from " + owner.getUsername() + " [" + owner.getCurrentIP() + "]: " + e.getMessage());
						owner.getActionSender().sendLogout();
						owner.destroy(false);
		      			}
		      		}  else{owner.getActionSender().sendMessage("The " + affectedNpc.getDef().getName() + " does not appear interested in talking to you.");}
			}
      	});
	}
	public static int getSprite(int x1, int y1, int x2, int y2) {
	
		int newx = x1 - x2;
		int newy = y1 - y2;

		if(newx == -1 &amp;&amp; newy == -1)
		{
			//TURN SOUTHWEST
			return 3;
		} else
		if(newx == -1 &amp;&amp; newy == 0)
		{
			//TURN WEST
			return 2;
		} else
		if(newx == -1 &amp;&amp; newy == 1)
		{
			//TURN NORTHWEST
			return 1;
		} else
		if(newx == 0 &amp;&amp; newy == 1)
		{
			//TURN NORTH
			return 0;
		} else
		if(newx == 1 &amp;&amp; newy == 1)
		{
			//TURN NORTHEAST
			return 7;
		} else
		if(newx == 1 &amp;&amp; newy == 0)
		{
			//TURN EAST
			return 6;
		} else
		if(newx == 1 &amp;&amp; newy == -1)
		{
			//TURN SOUTHEAST
			return 5;
		} else
		if(newx == 0 &amp;&amp; newy == -1)
		{
			//TURN SOUTH
			return 4;
		}

		return -1;
	}
}</code></pre>
<p><span class="bbcode-b">NOTE:</span> That will also make NPCs turn and face you when you speak to them.</p>
<p>Now open up your Player class, and add the import:</p>
<pre><code class="lang-auto">import bsh.Interpreter;</code></pre>
<p>Still in your Player class, find:</p>
<pre><code class="lang-auto">	public void setSEvent(ShortEvent sEvent) {
		world.getDelayedEventHandler().add(sEvent);
	}</code></pre>
<p>Above that, add:</p>
<pre><code class="lang-auto">	public Thread interpreterThread = null;
	public int lastOption = -2;
	public String[] lastOptions = null;
	public Interpreter interpreter = new Interpreter();</code></pre>
<p>Now open up your World class, and find:</p>
<pre><code class="lang-auto">worldInstance.loadNpcHandlers();</code></pre>
<p>Under that, add:</p>
<pre><code class="lang-auto">worldInstance.loadScripts();</code></pre>
<p>This will make it so that the NPC scripts are loaded upon running the server.</p>
<p>Now still in World class, find:</p>
<pre><code class="lang-auto">	/**
	 * returns the associated npc handler
	 */
	public NpcHandler getNpcHandler(int npcID) {
		return npcHandlers.get(npcID);
	}</code></pre>
<p>Above that, add:</p>
<pre><code class="lang-auto">	public void loadScripts() {
		int npccount = 0;
		int error = 0;
		for(File files : new File("scripts/").listFiles()) {
			try {
				int id = Integer.parseInt(files.getName().substring(0, 3).trim());
				npcScripts.put(id, files.getAbsolutePath());
			} catch(Exception e) {
				error++;
				continue;
			} finally {
				npccount++;
			}
		}
		System.out.println(npccount + " NPC Scripts loaded! " + (error &gt; 1 ? ((error - 1) + " Error scripts") : ""));
	}</code></pre>
<p>You will also need the Script class, which should be added into your ‘model’ folder, server side.</p>
<p><span class="bbcode-b">Script class:</span></p>
<pre><code class="lang-auto">package org.rscdaemon.server.model;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ConcurrentModificationException;

import org.rscdaemon.server.entityhandling.EntityHandler;

import bsh.EvalError;

public class Script {

	public Player player;
	public Npc npc;

	/**
	 * DONT TOUCH THIS. Sets the Player and Npc instances for reach when
	 * scripting.
	 * 
	 * @param p
	 *            - the player
	 * @param n
	 *            - the affected npc
	 */
	public Script(Player p, Npc n) {
		player = p;
		npc = n;

		try {
			player.interpreter.getNameSpace().importObject(this);
			player.interpreter.source(World.getWorld().npcScripts.get(npc
					.getID()));
			player.interpreter.getNameSpace().clear();
		} catch (EvalError e) {
			error();
			// e.printStackTrace();
		} catch (FileNotFoundException e) {
			error();
			// e.printStackTrace();
		} catch (IOException e) {
			error();
			// e.printStackTrace();
		} catch (ConcurrentModificationException cme) {
			System.out.println("got cme");
		} catch (Exception e) {
			error();
			// e.printStackTrace();
		}

	}

	/**
	 * Unblock the NPC/Player if something unhandled happens.
	 */
	private void error() {
		npc.unblock();
		player.setBusy(false);
	}

	/**
	 * Sends a normal Message to the player
	 * 
	 * @param msg
	 *            - the message
	 */
	public void SendMessage(String msg) {
		player.getActionSender().sendMessage(msg);
	}

	/**
	 * Sends a large black box Message to the player
	 * 
	 * @param msg
	 *            - the message
	 */
	public void SendBoxMessage(String msg) {
		player.getActionSender().sendAlert(msg, true);
	}

	/**
	 * Sends a medium or large black box message
	 * 
	 * @param msg
	 *            - the message
	 * @param big
	 *            - true if large box, false if medium
	 */
	public void SendBoxMessage(String msg, boolean big) {
		player.getActionSender().sendAlert(msg, big);
	}

	/**
	 * Add item(s) to the players inventory (This is setup to handle the amount
	 * even when the item is non stackable)
	 * 
	 * @param id
	 *            - the item's ID
	 * @param amount
	 *            - the amount given
	 */
	public void AddItem(int id, int amount) {
		InvItem item = new InvItem(id, amount);
		if (item.getDef().stackable) {
			player.getInventory().add(new InvItem(id, amount));
		} else {
			for (int i = 0; i &lt; amount; i++) {
				player.getInventory().add(new InvItem(id));
			}
		}
		player.getActionSender().sendInventory();
	}

	/**
	 * Says something to the NPC your talking too
	 * 
	 * @param msg
	 *            - the message
	 */
	public void PlayerTalk(String msg) {
		player.informOfChatMessage(new ChatMessage(player, msg, npc));
		Wait(2000);

	}

	/**
	 * the Npc your interacting with says something to you
	 * 
	 * @param msg
	 *            - the message
	 */
	public void NpcTalk(String msg) {
		player.informOfNpcMessage(new ChatMessage(npc, msg, player));
		Wait(2000);
	}

	/**
	 * Sleeps for the default delay (2000)
	 */
	public void Wait() {
		Wait(2000);
	}

	/**
	 * Wait's the delay until the next line is executed
	 */
	public void Wait(int ms) {
		try {
			Thread.currentThread().sleep(ms);
		} catch (InterruptedException e) {
			SendMessage(e.getMessage());
		}
	}

	/**
	 * AUTO EXPANDING arrays (String...) with BeanShell do not yet work. I know
	 * this looks dodgey, but easy-scripting support comes first. Currently set
	 * for 7 options max.
	 */
	public int PickOption(String s1, String s2, String s3, String s4,
			String s5, String s6, String s7) {
		return PickOption(new String[] { s1, s2, s3, s4, s5, s6, s7 });
	}

	public int PickOption(String s1, String s2, String s3, String s4,
			String s5, String s6) {
		return PickOption(new String[] { s1, s2, s3, s4, s5, s6 });
	}

	public int PickOption(String s1, String s2, String s3, String s4, String s5) {
		return PickOption(new String[] { s1, s2, s3, s4, s5 });
	}

	public int PickOption(String s1, String s2, String s3, String s4) {
		return PickOption(new String[] { s1, s2, s3, s4 });
	}

	public int PickOption(String s1, String s2, String s3) {
		return PickOption(new String[] { s1, s2, s3 });
	}

	public int PickOption(String s1, String s2) {
		return PickOption(new String[] { s1, s2 });
	}

	public int PickOption(String s1) {
		return PickOption(new String[] { s1 });
	}

	/**
	 * Sends a question menu, waits for the response.
	 * 
	 * @param strs
	 *            - array of options
	 * @return the option number
	 */
	public int PickOption(String[] strs) {
		try {
			long time = System.currentTimeMillis();
			player.setBusy(false);
			player.lastOption = -2;
			player.setMenuHandler(new MenuHandler(strs) {
				public void handleReply(int option, String reply) {
					if (option &lt; 0 || option &gt;= getOptions().length) {
						npc.unblock();
						player.setBusy(false);
						owner.lastOption = -1;
						return;
					}
					owner.lastOption = option;
				}
			});
			player.getActionSender().sendMenu(strs);
			while (player.lastOption == -2
					&amp;&amp; System.currentTimeMillis() - time &lt; 20000) { // timeout
				Wait(25);
			}
			if (player.lastOption == -1 || player.lastOption == -2) {
				player.setBusy(false);
				npc.unblock();
				return -1;
			}
			player.setBusy(true);
			int newOpt = player.lastOption;
			player.lastOption = -2;
			PlayerTalk(strs[newOpt]);
			return newOpt + 1;
		} catch (Exception e) {

			e.printStackTrace();
			return -1;
		}
	}

	/**
	 * Teleports you from x to y (without a bubble)
	 * 
	 * @param x
	 *            - new x axis
	 * @param y
	 *            - new y axis
	 */
	public void Teleport(int x, int y) {
		player.teleport(x, y, false);
	}

	/**
	 * Removes all the items from inventory that you specify
	 * 
	 * @param id
	 *            - the item id to remove
	 */
	public void RemoveAllItem(int id) {
		RemoveItem(id, player.getInventory().countId(id));
	}

	/**
	 * Checks inventory for items/amounts.
	 * 
	 * @param id
	 *            - the items id
	 * @param amount
	 *            - the amount
	 * @return true if it has the items.
	 */
	public boolean HasItem(int id, int amount) {
		if (EntityHandler.getItemDef(id).stackable) {
			for (InvItem i : player.getInventory().getItems()) {
				if (i.getID() == id &amp;&amp; i.getAmount() &gt;= amount)
					return true;
			}
		} else {
			int count = 0;
			for (InvItem i : player.getInventory().getItems()) {
				if (i.getID() == id)
					count++;
			}
			if (count &gt;= amount)
				return true;
		}
		return false;
	}

	/**
	 * Removes item(s) from your inventory
	 * 
	 * @param id
	 *            - the item id
	 * @param amount
	 *            - the amount
	 */
	public void RemoveItem(int id, int amount) {
		if (EntityHandler.getItemDef(id).stackable) {
			player.getInventory().remove(id, amount);
		} else {
			for (int i = 0; i &lt; amount; i++)
				player.getInventory().remove(id, 1);
		}
		player.getActionSender().sendInventory();
	}

	/**
	 * Adds experience to the selected Stat.
	 * 
	 * @param stat
	 *            - the stat number
	 * @param amount
	 *            - the amount
	 * 
	 */
	public void AddExp(int stat, int amount) {
		player.incExp(stat, amount, false, false);
	}

	/**
	 * Gets the free space in your inventory
	 * 
	 * @return - the free slots
	 */
	public int GetInventoryFreeSpace() {
		return 30 - player.getInventory().size();
	}

	/**
	 * Gets the max level of a stat
	 * 
	 * @param stat
	 * @return
	 */
	public int GetStatMaxLevel(int stat) {
		return player.getMaxStat(stat);
	}

	/**
	 * Gets the current level of a stat
	 * 
	 * @param stat
	 * @return
	 */
	public int GetStatCurLevel(int stat) {
		return player.getCurStat(stat);
	}

	/**
	 * Adds an item to your bank
	 * 
	 * @param id
	 *            - the item id
	 * @param amount
	 *            - the amount
	 */
	public void AddBankItem(int id, int amount) {
		player.getBank().add(new InvItem(id, amount));
	}

	public int CountItem(int id) {
		return player.getInventory().countId(id);
	}

	public static final int ATTACK = 0;
	public static final int DEFENSE = 1;
	public static final int STRENGTH = 2;
	public static final int HITS = 3;
	public static final int RANGED = 4;
	public static final int PRAYER = 5;
	public static final int MAGIC = 6;
	public static final int COOKING = 7;
	public static final int WOODCUT = 8;
	public static final int FLETCHING = 9;
	public static final int FISHING = 10;
	public static final int FIREMAKING = 11;
	public static final int CRAFTING = 12;
	public static final int SMITHING = 13;
	public static final int MINING = 14;
	public static final int HERBLAW = 15;
	public static final int AGILITY = 16;
	public static final int THIEVING = 17;
}</code></pre>
<p>Now open the build.XML file, and find:</p>
<pre><code class="lang-auto">&lt;pathelement location="${lib}/hex-string.jar" /&gt;</code></pre>
<p>Under that, add:</p>
<pre><code class="lang-auto">&lt;pathelement location="${lib}/bsh.jar" /&gt;</code></pre>
<p>Now find:</p>
<pre><code class="lang-auto">&lt;pathelement location="${lib}/xstream.jar" /&gt;</code></pre>
<p>Under  that, add:</p>
<pre><code class="lang-auto">&lt;pathelement location="${lib}/bsh.jar" /&gt;</code></pre>
<p>Your scripts should be saved in the following format:</p>
<blockquote>485 - Bank assistant.BSH</blockquote>
<p>Take note that the name of the NPC has to be EXACT from the NpcDef. You can’t use Bank Assistant, etc.</p>
<p>Also, if you have an NPC ID that is lower than 3 digits, save it as:</p>
<blockquote>031 - Juliet.BSH</blockquote>
<p>If you still need help after following these steps, post again or catch me on Skype.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/8">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/8</link>
        <pubDate>Fri, 22 Feb 2013 22:16:00 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-8</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@xrune xrune]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xrune">@xrune</a> wrote:</p>
          <blockquote>
              <aside class="quote" data-post="6" data-topic="400998">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="https://forum.moparisthebest.com/user_avatar/forum.moparisthebest.com/imthenull/40/1273_1.png" class="avatar"> imthenull:</div>
<blockquote>
<p>use the npc id in the filename too</p>
</blockquote>
</aside>
<p>I did… do u need to add any code to any java files? to get it to work? whats that code he has written above ^^ for?</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/7">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/7</link>
        <pubDate>Fri, 22 Feb 2013 20:18:52 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-7</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@imthenull imthenull]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/imthenull">@imthenull</a> wrote:</p>
          <blockquote>
              <p>use the npc id in the filename too</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/6">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/6</link>
        <pubDate>Fri, 22 Feb 2013 20:07:35 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-6</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@xrune xrune]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/xrune">@xrune</a> wrote:</p>
          <blockquote>
              <p>i tried the bsh method for easyrsc but i cant seem to get it to work, i saved a file with the bsh extension in the script folder and i was wondering what else you need to do to get it to work,</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/5">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/5</link>
        <pubDate>Fri, 22 Feb 2013 20:03:53 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-5</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@cleako cleako]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/cleako">@cleako</a> wrote:</p>
          <blockquote>
              <p>1.) Copy the bsh.jar file from BeyondRSC’s lib folder and put it in your server’s lib folder.<br>
2.) Create a folder in the root of your game server folder named “scripts”<br>
3.) Copy some of the BeyondRSC .bsh files from it’s scripts folder and learn how to write your own.<br>
4.) Create .bsh text files inside the scripts folder (or copy BeyondRSC’s) for your server and edit your server files to read them as explained below:</p>
<p>All you need to do is save them as the names, for example: 098 - Dr Harlow.BSH (the 098 prefix means NPC <span class="hashtag">#98</span>)</p>
<p>Once saved as a BSH extension, just throw them in your ‘scripts’ DIR and run the server. Once you talk to an NPC in game that contains the same ID within the BSH script, it will handle the talking…</p>
<p>From the TalkToNpcHandler class:</p>
<pre><code class="lang-auto">                if(world.npcScripts.containsKey(affectedNpc.getID())) {
                    owner.setBusy(true);
                    affectedNpc.blockedBy(owner);
                    if(owner.interpreterThread != null) {
                        try {
                            owner.interpreterThread.stop();
                        } catch(Exception e) {

                        }
                    }

                    owner.interpreterThread = new Thread(new Runnable() {
                        public void run() {        
                            try {
                                new org.rscdaemon.server.model.Script(owner, affectedNpc);    
                                owner.setBusy(false);

                                affectedNpc.unblock();
                            }
                            catch(Exception e) {
                                if(!(e instanceof InvocationTargetException)) {
                                    e.printStackTrace();
                                }
                                System.out.println(affectedNpc.getID());
                                affectedNpc.unblock();
                                owner.setBusy(false);
                            }
                        }
                    });
                    owner.interpreterThread.start();
                }
                else                
                      if(handler != null) {
                          try {
                              handler.handleNpc(affectedNpc, owner);
                          }
                          catch(Exception e) {
                        Logger.error("Exception with npc[" + affectedNpc.getIndex() + "] from " + owner.getUsername() + " [" + owner.getCurrentIP() + "]: " + e.getMessage());
                        owner.getActionSender().sendLogout();
                        owner.destroy(false);
                          }
                      }  else{owner.getActionSender().sendMessage("The " + affectedNpc.getDef().getName() + " does not appear interested in talking to you.");}
            }
          });
    }</code></pre>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/4">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/4</link>
        <pubDate>Tue, 11 Oct 2011 01:58:57 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-4</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@Arsonist Arsonist]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/arsonist">@Arsonist</a> wrote:</p>
          <blockquote>
              <p>Thanks a lot <img src="https://forum.moparisthebest.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/3">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/3</link>
        <pubDate>Mon, 27 Jun 2011 02:21:26 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-3</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@Nothing1 -Nothing]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/nothing1">@Nothing1</a> wrote:</p>
          <blockquote>
              <p>BeyondRSC had something similar to what you want, but it shouldn’t be used for quests since it’s kind of buggy.<br>
Also RSCA has a nice quest system, also fits in your requirements, just rip it out.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/2">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/2</link>
        <pubDate>Sun, 26 Jun 2011 16:15:19 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-2</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
      <item>
        <title>Help with NPC chat and Quests</title>
        <dc:creator><![CDATA[@Arsonist Arsonist]]></dc:creator>
        <description><![CDATA[
          <p><a href="https://forum.moparisthebest.com/u/arsonist">@Arsonist</a> wrote:</p>
          <blockquote>
              <p>Hello all,</p>
<p>I would like to start adding quests but I’ve only been programming in Python and haven’t used Java in a few months now.</p>
<p>Is it possible, and if so where, should I write a function so that all I have to write in the .class file something like:</p>
<p>NPCspeak(“Hello there, are you lost?”)<br>
NPCspeak(“Or are you looking for something?”)</p>
<p>This would result in the normal conversation…the function would add the wait time between each speech line, etc.</p>
<p>Also what file should I assign players numbers like DRUIDIC_RITUAL == 0 for each quest so when a player has completed a certain stage of the quest, I can write DRUIDIC_RITUAL++ (or however Java increments an integer by 1) to progress the player into the next stage, and once DRUIDIC_RITUAL++ has be executed, that number remains saved to the player, so when they log out their DRUIDIC_RITUAL is the same as when they logged out.</p>
          </blockquote>
          <p><a href="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/1">Read full topic</a></p>
        ]]></description>
        <link>https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998/1</link>
        <pubDate>Sun, 26 Jun 2011 08:10:33 +0000</pubDate>
        <guid isPermaLink="false">forum.moparisthebest.com-post-400998-1</guid>
        <source url="https://forum.moparisthebest.com/t/help-with-npc-chat-and-quests/400998.rss">Help with NPC chat and Quests</source>
      </item>
  </channel>
</rss>
