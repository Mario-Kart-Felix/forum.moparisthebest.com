<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/packet-handling-round-ii-a-generic-decoding-system/316631 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:12 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Packet handling (round II) - a generic decoding system - Community Inside Talk - moparisthebest.com</title>
    <meta name="description" content="So the first thread on packet handling ideas raised some interesting discussions and seemed to attract a little approval (a rare thing for a moparscape thread..) I figured it might be nice to tackle the second problem in&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="316631.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Packet handling (round II) - a generic decoding system&#39;" href="316631.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/packet-handling-round-ii-a-generic-decoding-system/316631" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/packet-handling-round-ii-a-generic-decoding-system/316631" />
<meta property="og:title" content="Packet handling (round II) - a generic decoding system" />
<meta name="twitter:title" content="Packet handling (round II) - a generic decoding system" />
<meta property="og:description" content="So the first thread on packet handling ideas raised some interesting discussions and seemed to attract a little approval (a rare thing for a moparscape thread…) I figured it might be nice to tackle the second problem in another thread…  [size=10pt]How do we decode the packets?[/size]  1. How do we store the decoded packets?  Idea: Use some Map (TreeMap or HashMap - maybe TreeMap has less overhead for small packets? Anything with fast lookups and insertions) to map some arbitrary key string to a ..." />
<meta name="twitter:description" content="So the first thread on packet handling ideas raised some interesting discussions and seemed to attract a little approval (a rare thing for a moparscape thread…) I figured it might be nice to tackle the second problem in another thread…  [size=10pt]How do we decode the packets?[/size]  1. How do we store the decoded packets?  Idea: Use some Map (TreeMap or HashMap - maybe TreeMap has less overhead for small packets? Anything with fast lookups and insertions) to map some arbitrary key string to a ..." />
<meta property="article:published_time" content="2009-11-27T11:34:38+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="316631.html">Packet handling (round II) - a generic decoding system</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/community-inside-talk.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Community Inside Talk</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Stork.html'><span itemprop='name'>Stork</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-27T11:34:38Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:48:11Z' class='post-time'>
              July 31, 2016, 12:48pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>So the first thread on packet handling ideas raised some interesting discussions and seemed to attract a little approval (a rare thing for a moparscape thread…) I figured it might be nice to tackle the second problem in another thread…</p>
<p>[size=10pt]<span class="bbcode-b">How do we decode the packets?</span>[/size]</p>
<p><span class="bbcode-b">1. How do we store the decoded packets?</span><br>
Idea: Use some Map (TreeMap or HashMap - maybe TreeMap has less overhead for small packets? Anything with fast lookups and insertions) to map some arbitrary key string to a value (byte, boolean, byte[], int, short, string, etc). Simple, and it’d work.</p>
<p>Problem: What happens when we encounter more complicated packets, such as ones with arrays of values?<br>
For examples sake, let’s say we have a packet we would normally decode like this:</p>
<p><code>int id = packet.getId();
int playerCount = packet.readShort();
for(int i=0; i&lt;playerCount; i++) {
    int playerId = packet.readShort();
    int somePlayerData = packet.readWhatever();
    //... etc.
}</code><br>
Perhaps we could store some player_count variable, then for each player in the loop, we store them as player_i_id, player_i_somePlayerData, etc. where 0&lt;=i&lt;playerCount.<br>
Any other ideas? I don’t know rs2 well enough to know when this kind of thing occours, or if it even occours often enough to be a problem.</p>
<p><span class="bbcode-b">2. How do we decode simple packets?</span><br>
No problems here. We can use XML, or maybe some arbitrary decoding format. I don’t know shit about xml parsing so I’d fail hard at this, but an existing parser would probably be more robust than anything we can write easily. Note that the order of values in this description is very important.<br>
Artist’s conception:</p>
<p><code>&lt;packet id="41" desc="some made up login packet"&gt;
    &lt;val type="unsigned int16" key="pid" desc="the ID of your player"/&gt;
    &lt;val type="unsigned int8" key="world" desc="the world ID"/&gt;
    &lt;val type="string" key="motd" desc="message of the day from the server"/&gt;
    &lt;!-- ... --!&gt;
&lt;/packet&gt;</code><br>
or maybe…</p>
<p><code>packet=41 { //some made up login packet
    unsigned int16 pid; //player id
    unsigned int8 world; //world id
    string motd; //message of the day
    //...
}</code><br>
The latter is nicer to look at (IMO) but writing a robust parser (e.g. one that produces friendly error messages if the format is wrong) might not be much fun.<br>
So, <span class="bbcode-b">XML or some other format?</span> If another format, how best to implement it? Maybe there’s some parsing engine we can use?</p>
<p><span class="bbcode-b">3. How do we parse complex packets?</span><br>
Stuff like conditional packets, or packets with repeating values and variable sizes.<br>
Perhaps in XML we could do something like apache ant uses in it’s build scripts:</p>
<p><code>&lt;packet id="999" desc="some packet with conditionals"&gt;
    &lt;val type="unsigned int8" key="type" desc="the packet type"/&gt;
    &lt;if keyName="type" equals="0"&gt;
         &lt;val ...&gt;
    &lt;/if&gt;
    &lt;if keyName="type" equals="1"&gt;
         &lt;val ...&gt;
    &lt;/if&gt;
    &lt;!-- etc... --!&gt;
&lt;/packet&gt;</code><br>
Cons: verbose, not much fun.</p>
<p>Perhaps in our language:</p>
<p><code>packet=999: #some conditional packet
    unsigned int8 type #our type
    if type = 0:
        val ...
    if type = 0:
        val ...</code><br>
[I changed syntax cuz I realised python is prettier than java, and more compact.]</p>
<p><span class="bbcode-b">4. Making it efficient.</span><br>
The way I see it, when the server starts up, it parses these descriptions into some abstract data type like:</p>
<p><code>MetaPacket { //metapacket = data about a packet, u see? I just wanted to use 'meta' in something.
    int id;
    List&lt;MetaPacketValue&gt; packetContents;
}
MetaPacketValue { //information about a particular piece of data in the packet
    ValueType t; //bool, byte, short, string, etc
    String keyName; //the name of the value
}</code><br>
And then iterates through the list of MetaPacketValues and consumes data from the packet, putting the data into the Map of some MappedPacket. Only problem with that approach is how does a MetaPacketValue represent a an array of values (like in the example earlier when we had an array of players to update)? I can’t think of a good way to do this.</p>
<p>Ideas, questions, comments? I labelled the points 1-4 to make it easier to reference my ideas. Did I miss out any points? Did I do anything blindingly stupid?</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/lawl.html'><span itemprop='name'>lawl</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-27T17:28:19Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:48:21Z' class='post-time'>
              July 31, 2016, 12:48pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>json would be great for packets</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/lothy.html'><span itemprop='name'>lothy</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-27T21:47:38Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:48:39Z' class='post-time'>
              July 31, 2016, 12:48pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The Maps should be Map&lt;String, Object&gt;. Then we can just pack the entire array into one mapping, such that you’d retrieve it like so:</p>
<pre><code class="lang-auto">int[] items = map.get("items");</code></pre>
<p>Regarding decoding, perhaps it would be better to implement a PacketDecoder interface for each packet opcode than to do it in XML. A PacketDecoder, which would possibly need to change from release to release of the client, would easily be modified – the packet’s associated handling code would obviously remain static.</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Jython.html'><span itemprop='name'>Jython</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-27T22:45:31Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:48:45Z' class='post-time'>
              July 31, 2016, 12:48pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>already done.<br>
stork, ps i implemented it using a thing called a block, where a whole packet structure was just a specialized block, and then you could do like:</p>
<pre><code class="lang-auto">&lt;block count="count_field_name"&gt;&lt;field type="blah" name="xxx"&gt;&lt;/block&gt;</code></pre>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/moparisthebest.html'><span itemprop='name'>moparisthebest</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-28T03:40:51Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:49:02Z' class='post-time'>
              July 31, 2016, 12:49pm
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I love the XML idea, as you said, there are many parsers already written, and many tools already written as well to help us write, read, compare, view, convert etc etc etc these XML files.</p>
<p>Lothy’s idea on mapping to an object is the only way I can think to handle arrays with a Map-like interface.  However, I do like the idea in the other thread to dynamically generate classes from these XML files that would be version specific, that could also easily fix the array problem.</p>
<p>This may be a personal thing, but when you use attributes in XML you have to escape quotation marks ("), and you avoid this problem and I believe it looks cleaner if you avoid them.</p>
<p>Here is your example converted to what I am talking about.<br>
Yours:</p>
<p><code>&lt;packet id="41" desc="some made up login packet"&gt;
    &lt;val type="unsigned int16" key="pid" desc="the ID of your player"/&gt;
    &lt;val type="unsigned int8" key="world" desc="the world ID"/&gt;
    &lt;val type="string" key="motd" desc="message of the day from the server"/&gt;
    &lt;!-- ... --!&gt;
&lt;/packet&gt;</code><br>
to:</p>
<p><code>&lt;packet&gt;
	&lt;id&gt;41&lt;/id&gt;
	&lt;desc&gt;some made up login packet&lt;/desc&gt;
	&lt;val&gt;
		&lt;type&gt;unsigned int16&lt;/type&gt;
		&lt;key&gt;pid&lt;/key&gt;
		&lt;desc&gt;the ID of your player&lt;/desc&gt;
	&lt;/val&gt;
	&lt;val&gt;
		&lt;type&gt;unsigned int8&lt;/type&gt;
		&lt;key&gt;world&lt;/key&gt;
		&lt;desc&gt;the world ID&lt;/desc&gt;
	&lt;/val&gt;
	&lt;val&gt;
		&lt;type&gt;string&lt;/type&gt;
		&lt;key&gt;motd&lt;/key&gt;
		&lt;desc&gt;message of the day from the server&lt;/desc&gt;
	&lt;/val&gt;
	&lt;!-- ... --!&gt;
&lt;/packet&gt;</code></p>
<p>Perhaps a bit more verbose, but no one should be typing these out in a text editor anyway, instead using a tool to do it.  (again, using an XML library the tool would be trivial to write)</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/lothy.html'><span itemprop='name'>lothy</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-28T10:56:25Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:49:27Z' class='post-time'>
              July 31, 2016, 12:49pm
            </time>
        <span itemprop='position'>#6</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Aren’t XML attributes considered deprecated anyway?</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Jython.html'><span itemprop='name'>Jython</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-11-28T21:34:47Z'>
            <time itemprop='dateModified' datetime='2016-07-31T12:50:16Z' class='post-time'>
              July 31, 2016, 12:50pm
            </time>
        <span itemprop='position'>#7</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote no-group quote-modified" data-post="6" data-topic="316631">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forum.moparisthebest.com/lothy/40/51_1.png" class="avatar"> Lothy:</div>
<blockquote>
<p>Aren’t XML attributes considered deprecated anyway?</p>
</blockquote>
</aside>
<p>definitely not[br][br][size=1]Posted on: November 28, 2009, 09:37:14 pm[/size][hr]in my system, messages.xml is parsed into a map of MessageStructures, stored in a MessageStructureRepository.</p>
      </div>

      <meta itemprop='headline' content='Packet handling (round II) - a generic decoding system'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/packet-handling-round-ii-a-generic-decoding-system/316631 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:12 GMT -->
</html>
