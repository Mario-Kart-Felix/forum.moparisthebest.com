<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/update-server/554188 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:59 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Update Server - Runescape - moparisthebest.com</title>
    <meta name="description" content="I have recently been attempting to convert an update server I wrote for a #498 client to be compatible with a #414 client. IIRC correctly every revision after and including #414 should share similar update server propert&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="554188.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Update Server&#39;" href="554188.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/update-server/554188" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/update-server/554188" />
<meta property="og:title" content="Update Server" />
<meta name="twitter:title" content="Update Server" />
<meta property="og:description" content="I have recently been attempting to convert an update server I wrote for a #498 client to be compatible with a #414 client. IIRC correctly every revision after and including #414 should share similar update server properties and send the cache files in a similar way. However I am having difficulty sending the #414 files. The client stops receiving files midway and returns an error code (4). Maybe someone else could see what i’m missing?  I’m currently not answering any file requests that aren’t r..." />
<meta name="twitter:description" content="I have recently been attempting to convert an update server I wrote for a #498 client to be compatible with a #414 client. IIRC correctly every revision after and including #414 should share similar update server properties and send the cache files in a similar way. However I am having difficulty sending the #414 files. The client stops receiving files midway and returns an error code (4). Maybe someone else could see what i’m missing?  I’m currently not answering any file requests that aren’t r..." />
<meta property="article:published_time" content="2015-12-23T22:36:37+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="554188.html">Update Server</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
        itemref="breadcrumb-1"
      >
      <a href="../../c/games.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Games</span>
      </a>
    </div>
    <div id="breadcrumb-1" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/games/runescape.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Runescape</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Vix.html'><span itemprop='name'>Vix</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2015-12-23T22:36:37Z'>
            <time itemprop='dateModified' datetime='2016-08-04T17:12:25Z' class='post-time'>
              August 4, 2016,  5:12pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I have recently been attempting to convert an update server I wrote for a <span class="hashtag">#498</span> client to be compatible with a <span class="hashtag">#414</span> client. IIRC correctly every revision after and including <span class="hashtag">#414</span> should share similar update server properties and send the cache files in a similar way. However I am having difficulty sending the <span class="hashtag">#414</span> files. The client stops receiving files midway and returns an error code (4). Maybe someone else could see what i’m missing?</p>
<p>I’m currently not answering any file requests that aren’t required immediately. The actual cache encoding/decoding is done with Graham’s open-rs.</p>
<p>[code=java5]package <a href="http://com.adamant.net/" rel="nofollow noopener">com.adamant.net</a>;</p>
<p>import io.netty.buffer.ByteBuf;<br>
import io.netty.buffer.Unpooled;<br>
import io.netty.channel.ChannelHandlerContext;<br>
import io.netty.handler.codec.ReplayingDecoder;</p>
<p>import java.io.IOException;<br>
import java.nio.ByteBuffer;<br>
import java.util.List;<br>
import java.util.logging.Logger;</p>
<p>import com.adamant.Adamant;</p>
<p>/**</p>
<ul>
<li>
<p><span class="mention">@author</span> Dylan Vicchiarelli</p>
</li>
<li>
<p>Handles the transmission of cache archives to the game client upon request.<br>
*/<br>
public class UpdateProtocolDecoder extends ReplayingDecoder {</p>
<p>/**</p>
<ul>
<li>Requests an archive to be sent and the transaction is required</li>
<li>immediately.<br>
*/<br>
public static final int IMMEDIATE_PRIORITY_OPCODE = 1;</li>
</ul>
<p>/**</p>
<ul>
<li>Requests an archive to be sent but the transaction isn’t required</li>
<li>to be immediate.<br>
*/<br>
public static final int MILD_PRIORITY_OPCODE = 0;</li>
</ul>
<p>/**</p>
<ul>
<li>Denotes that an error has occurred.<br>
*/<br>
public static final int ERROR_ENCOUNTERED_OPCODE = 4;</li>
</ul>
<p>/**</p>
<ul>
<li>Data is sent in 512 byte blocks, with the magic number being 255.<br>
*/<br>
public static final int MAGIC_NUMBER = 0xFF;</li>
</ul>
<p><a class="mention" href="../../u/override.html">@Override</a><br>
protected void decode(ChannelHandlerContext context, ByteBuf buffer, List collection) throws Exception {</p>
<pre><code> while (buffer.readableBytes() &gt; 0) {

 	/*
 	 * The severity of the demand for an archive.
 	 */
 	final int priority = buffer.readUnsignedByte();

 	final int cache = buffer.readUnsignedByte();
 	final int index = buffer.readShort() &amp; 0xFFFF;

 	switch (priority) {

 	case IMMEDIATE_PRIORITY_OPCODE:
 		serve(context, cache, index);
 		break;

 	case ERROR_ENCOUNTERED_OPCODE:
 		Logger.getLogger(UpdateProtocolDecoder.class.getSimpleName()).info("An error has occured within the Update Server.");
 		break;

 	}
 }
</code></pre>
<p>}</p>
<p>/**</p>
<ul>
<li>
<p>Serves an archive compression to the game client.</p>
</li>
<li>
<p><a class="mention" href="../../u/param.html">@param</a> context The channel responsible for forwarding the compression.</p>
</li>
<li>
<p><a class="mention" href="../../u/param.html">@param</a> index The index identification.</p>
</li>
<li>
<p><a class="mention" href="../../u/param.html">@param</a> container The container identification.</p>
</li>
<li>
<p><span class="mention">@throws</span> IOException The exception thrown if a communication error occurs.<br>
*/<br>
private final void serve(ChannelHandlerContext context, int index, int container) throws IOException {<br>
final ByteBuf buffer = Unpooled.directBuffer();<br>
if (index == MAGIC_NUMBER &amp;&amp; container == MAGIC_NUMBER) {<br>
final ByteBuffer file = Adamant.getCache().createChecksumTable().encode();<br>
buffer.writeByte(MAGIC_NUMBER);<br>
buffer.writeShort(MAGIC_NUMBER);<br>
buffer.writeByte(0);<br>
buffer.writeInt(file.limit());<br>
buffer.writeBytes(file);<br>
context.writeAndFlush(buffer);<br>
return;<br>
}<br>
final ByteBuffer file = Adamant.getCache().getStore().read(index, container);<br>
final int compression = file.get() &amp; 0xFF;<br>
final int length = file.getInt();<br>
final int attributes = compression;<br>
final byte[] payload = new byte[compression != 0 ? length + 4 : length];<br>
System.arraycopy(file.array(), 5, payload, 0, payload.length);<br>
buffer.writeByte(index);<br>
buffer.writeShort(container);<br>
buffer.writeByte(attributes);<br>
buffer.writeInt(length);<br>
int offset = 8;<br>
for (byte data : payload) {<br>
if (offset == 512) {<br>
buffer.writeByte(MAGIC_NUMBER);<br>
offset = 1;<br>
}<br>
buffer.writeByte(data);<br>
offset ++;<br>
}</p>
<p>context.writeAndFlush(buffer);<br>
}<br>
}[/code]</p>
</li>
</ul>
</li>
</ul>
<p>[code=java5]package <a href="http://com.adamant.net/" rel="nofollow noopener">com.adamant.net</a>;</p>
<p>import io.netty.buffer.ByteBuf;<br>
import io.netty.buffer.Unpooled;<br>
import io.netty.channel.ChannelHandlerContext;<br>
import io.netty.handler.codec.ReplayingDecoder;</p>
<p>import java.security.SecureRandom;<br>
import java.util.List;<br>
import java.util.logging.Logger;</p>
<p>/**</p>
<ul>
<li>
<p><span class="mention">@author</span> Dylan Vicchiarelli</p>
</li>
<li>
<p>The class responsible for coordinating and exchanging protocol information with the game client.<br>
*/<br>
public final class ChannelProtocolDecoder extends ReplayingDecoder {</p>
<p>/**</p>
<ul>
<li>Denotes the request for cache archives.<br>
*/<br>
public static final int UPDATE_SERVER_OPCODE = 15;</li>
</ul>
<p>/**</p>
<ul>
<li>Denotes the request for a new connection to the game.<br>
*/<br>
public static final int GAME_SERVER_OPCODE = 14;</li>
</ul>
<p>/**</p>
<ul>
<li>The protocol revision of the game client.<br>
*/<br>
public static final int PROTOCOL_REVISION = 414;</li>
</ul>
<p>/**</p>
<ul>
<li>The status code to kick start the login protocol.<br>
*/<br>
public static final int STATUS_CODE = 0;</li>
</ul>
<p><a class="mention" href="../../u/override.html">@Override</a><br>
protected void decode(ChannelHandlerContext context, ByteBuf buffer, List collection) throws Exception {</p>
<pre><code> final int opcode = buffer.readUnsignedByte();

 switch (opcode) {

 case UPDATE_SERVER_OPCODE:

 	if (buffer.readableBytes() &gt;= 3 &amp;&amp; context.channel().isOpen()) {

 		final int version = buffer.readInt();
 		final ByteBuf response = Unpooled.directBuffer();
 		
 		response.writeByte(version == PROTOCOL_REVISION ? 0 : 6);
 		context.writeAndFlush(response);
 		
 		if (version == PROTOCOL_REVISION) {
 			context.pipeline().replace("protocol-decoder", "update-decoder", new UpdateProtocolDecoder());
 		} else {
 			context.close();
 			Logger.getLogger(ChannelProtocolDecoder.class.getSimpleName()).info("Mismatch between server and client revisions.");
 		}
 	}

 	break;
 	
 case GAME_SERVER_OPCODE:
 	
 	/*
 	 * The name hash. Theorized to help determine
 	 * a proper server.
 	 */
 	buffer.readUnsignedByte();

 	final ByteBuf response = Unpooled.directBuffer();
 	
 	response.writeLong(STATUS_CODE);
 	response.writeLong(new SecureRandom().nextLong());

 	context.writeAndFlush(response);
 	
 	context.pipeline().replace("protocol-decoder", "login-decoder", new LoginProtocolDecoder());
 	break;
 }
</code></pre>
<p>}<br>
}[/code]</p>
</li>
</ul>
<p>Maybe the error is occurring because of something to do with the cache or client? Also ignore my shit code, this is just an echo server right now.</p>
      </div>

      <meta itemprop='headline' content='Update Server'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/update-server/554188 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:59 GMT -->
</html>
