<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/any-way-to-optimize-this/306833 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 09:26:04 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Any way to optimize this? - General Programming - moparisthebest.com</title>
    <meta name="description" content="&amp;lt;?php
echo &amp;#39;&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;Statistics&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;#39;;
$microtime = explode(&amp;quot; &amp;quot;, microtime());
$microtime = $microtime[1];
mysql_connect(&amp;quot;localhost&amp;quot;, &amp;quot;user&amp;quot;, &amp;quot;pass&amp;quot;) or die(mysql_error());
mysql_select_db(&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="306833.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Any way to optimize this?&#39;" href="306833.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/any-way-to-optimize-this/306833" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/any-way-to-optimize-this/306833" />
<meta property="og:title" content="Any way to optimize this?" />
<meta name="twitter:title" content="Any way to optimize this?" />
<meta property="og:description" content="&lt;?php  echo &#39;&lt;html&gt; &lt;head&gt; &lt;title&gt;Statistics&lt;/title&gt; &lt;/head&gt; &lt;body&gt;&#39;;  $microtime = explode(&quot; &quot;, microtime()); $microtime = $microtime[1];  mysql_connect(&quot;localhost&quot;, &quot;user&quot;, &quot;pass&quot;) or die(mysql_error()); mysql_select_db(&quot;dbname&quot;) or die(mysql_error());  $query = mysql_query(&quot;SELECT timestamp FROM tracking ORDER BY timestamp ASC LIMIT 1&quot;); $result = mysql_fetch_array($query); $firstRequest = $result[&#39;timestamp&#39;]; $firstRequestU = $firstRequest;  $query = mysql_query(&quot;SELECT timestamp FROM track..." />
<meta name="twitter:description" content="&lt;?php  echo &#39;&lt;html&gt; &lt;head&gt; &lt;title&gt;Statistics&lt;/title&gt; &lt;/head&gt; &lt;body&gt;&#39;;  $microtime = explode(&quot; &quot;, microtime()); $microtime = $microtime[1];  mysql_connect(&quot;localhost&quot;, &quot;user&quot;, &quot;pass&quot;) or die(mysql_error()); mysql_select_db(&quot;dbname&quot;) or die(mysql_error());  $query = mysql_query(&quot;SELECT timestamp FROM tracking ORDER BY timestamp ASC LIMIT 1&quot;); $result = mysql_fetch_array($query); $firstRequest = $result[&#39;timestamp&#39;]; $firstRequestU = $firstRequest;  $query = mysql_query(&quot;SELECT timestamp FROM track..." />
<meta property="article:published_time" content="2009-10-07T15:22:48+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="306833.html">Any way to optimize this?</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/general-programming.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>General Programming</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/inertia.html'><span itemprop='name'>inertia</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-10-07T15:22:48Z'>
            <time itemprop='dateModified' datetime='2016-07-31T11:34:13Z' class='post-time'>
              July 31, 2016, 11:34am
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <pre><code class="lang-auto">&lt;?php

echo '&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Statistics&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;';

$microtime = explode(" ", microtime());
$microtime = $microtime[1];

mysql_connect("localhost", "user", "pass") or die(mysql_error());
mysql_select_db("dbname") or die(mysql_error());

$query = mysql_query("SELECT timestamp FROM tracking ORDER BY timestamp ASC LIMIT 1");
$result = mysql_fetch_array($query);
$firstRequest = $result['timestamp'];
$firstRequestU = $firstRequest;

$query = mysql_query("SELECT timestamp FROM tracking ORDER BY timestamp DESC LIMIT 1");
$result = mysql_fetch_array($query);
$lastRequest = $result['timestamp'];
$lastValidRequest = strtotime(date("Y", $result['timestamp']).'-'.date("M", $result['timestamp']).'-'.date("d", $result['timestamp']).' 00:00:00')-1;

$activeDays = (($lastValidRequest-$firstRequest)+43)/86400;
$activeDays = 2;

// Get data for all hits
for($d = 1; $d &lt;= $activeDays; $d++) {
  for($h = 0; $h &lt; 24; $h++) {
   $lowerRange = $firstRequest;
   $upperRange = $firstRequest+3600;
   $query = mysql_query("SELECT timestamp FROM tracking WHERE timestamp &gt;= $lowerRange AND timestamp &lt;= $upperRange");
   $requests = mysql_num_rows($query);
   $firstRequest = $lowerRange+3600;
   $results[$d][$h] = $requests;
  }
}

// Get data for unique hits
for($d = 1; $d &lt;= $activeDays; $d++) {
  for($h = 0; $h &lt; 24; $h++) {
   $lowerRange = $firstRequestU;
   $upperRange = $firstRequestU+3600;
   $query = mysql_query("SELECT timestamp FROM tracking WHERE timestamp &gt;= $lowerRange AND timestamp &lt;= $upperRange GROUP BY ip_address");
   $requests = mysql_num_rows($query);
   $firstRequestU = $lowerRange+3600;
   $resultsU[$d][$h] = $requests;
  }
}


// Resolve data stream into hourly averages showing all hits
for($h = 0; $h &lt; 24; $h++) {
  for($d = 1; $d &lt;= $activeDays; $d++) {
    $totals[$h] = $totals[$h]+$results[$d][$h];
  }
  $averages[$h] = round($totals[$h]/$activeDays, 0);
}

// Resolve data stream into hourly averages showing unique hits
for($h = 0; $h &lt; 24; $h++) {
  for($d = 1; $d &lt;= $activeDays; $d++) {
    $totalsU[$h] = $totalsU[$h]+$resultsU[$d][$h];
  }
  $averagesU[$h] = round($totalsU[$h]/$activeDays, 0);
}

echo 'Averages taken from the past '.$activeDays.' days&lt;hr /&gt;';

echo '&lt;table cellpadding=0 cellspacing=0 style="font-size: 14px;"&gt;';

echo '&lt;tr style="text-align: center;"&gt;
        &lt;td style="font-weight: bold;"&gt;Time&lt;/td&gt;
        &lt;td style="font-weight: bold;"&gt;Requests&lt;/td&gt;
        &lt;td style="font-weight: bold;"&gt;Unique&lt;/td&gt;
        &lt;td style="text-align: left; font-weight: bold;"&gt;Percentage of Visitors&lt;/td&gt;
      &lt;/tr&gt;';

for($h=0; $h &lt; 24; $h++) {
  $averagesU[$h] = $averagesU[$h]*1;
  echo '&lt;tr&gt;';
  echo '&lt;td style="text-align: right;"&gt;' . $h . ':00&lt;/td&gt;
        &lt;td style="text-align: center;"&gt;' . $averages[$h] . '&lt;/td&gt;
        &lt;td style="text-align: center;"&gt;' . $averagesU[$h] . '&lt;/td&gt;
        &lt;td style="text-align: left;"&gt;
          &lt;div style="background-color: #FF7E00; width: '.$averages[$h] . 'px; display: inline-block; border: 1px black dotted; border-left: none; height: 20px;"&gt;&lt;div style="background-color: #0247FE; width: ' . $averagesU[$h] . 'px; display: inline-block; border: 1px white dotted; border-left: none; height: 10px; vertical-align: middle;"&gt;&amp;nbsp;&lt;/div&gt;&amp;nbsp;&lt;/div&gt;
        &lt;/td&gt;';

  echo '&lt;/tr&gt;';
}

echo '&lt;/table&gt;';
echo '&lt;/body&gt;&lt;/html&gt;';

?&gt;</code></pre>
<p>This just reports the average hourly usage of my site using a list of IP addresses and unix timestamps from a database.</p>
<p>When I first implemented this it took a few seconds to load, but with just 14 days of stats it takes over 2 minutes to load (obv because its executing a query for each hour of every day, twice). There must be a nicer way to do this. The only option I can think of is running one big query and getting PHP to sort out the data, but I don’t know how to handle data like this in PHP alone.</p>
<p>I’ve added ajax to a new page so it shows a progress bar depending on the days and current progress and I’m thinking of using database caching because the result only changes once every day, but waiting two minutes for the average of just 14 days of results is pretty retarded…</p>
      </div>

      <meta itemprop='headline' content='Any way to optimize this?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/silabsoft.html'><span itemprop='name'>silabsoft</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-10-10T23:27:10Z'>
            <time itemprop='dateModified' datetime='2016-07-31T11:40:20Z' class='post-time'>
              July 31, 2016, 11:40am
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>use a cron write complete calculations in a table, have page just query the calculations.</p>
      </div>

      <meta itemprop='headline' content='Any way to optimize this?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/inertia.html'><span itemprop='name'>inertia</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-10-11T10:40:23Z'>
            <time itemprop='dateModified' datetime='2016-07-31T11:41:32Z' class='post-time'>
              July 31, 2016, 11:41am
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote no-group" data-post="2" data-topic="306833">
<div class="title">
<div class="quote-controls"></div>
 Miss Silabsoft:</div>
<blockquote>
<p>use a cron write complete calculations in a table, have page just query the calculations.</p>
</blockquote>
</aside>
<p>Is that it then? There’s no fast way to collate the data?</p>
      </div>

      <meta itemprop='headline' content='Any way to optimize this?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/TabbyKiller.html'><span itemprop='name'>TabbyKiller</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2009-10-14T00:43:58Z'>
            <time itemprop='dateModified' datetime='2016-07-31T11:46:49Z' class='post-time'>
              July 31, 2016, 11:46am
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>What Miss Silabsoft says turns to truthness</p>
      </div>

      <meta itemprop='headline' content='Any way to optimize this?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/any-way-to-optimize-this/306833 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 09:26:05 GMT -->
</html>
