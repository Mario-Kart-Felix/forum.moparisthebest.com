<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/bash-detect-and-report-file-system-changes/413954 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:12 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>[bash] Detect and report file system changes - Technology - moparisthebest.com</title>
    <meta name="description" content="In light of recent events, you can guess what I wrote this code for.  Basically you give it a known good directory (like where you backed up files to), and then another directory that you would like to verify any changes&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="413954.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;[bash] Detect and report file system changes&#39;" href="413954.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/bash-detect-and-report-file-system-changes/413954" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/bash-detect-and-report-file-system-changes/413954" />
<meta property="og:title" content="[bash] Detect and report file system changes" />
<meta name="twitter:title" content="[bash] Detect and report file system changes" />
<meta property="og:description" content="In light of recent events, you can guess what I wrote this code for.  Basically you give it a known good directory (like where you backed up files to), and then another directory that you would like to verify any changes on, and finally a working directory it will store it’s files in.  Optionally it will mail the report and the diff file to your email address.  Edit the list_files() method to filter out log files or whatever else you DON’T care about changing.  After it runs the files you want w..." />
<meta name="twitter:description" content="In light of recent events, you can guess what I wrote this code for.  Basically you give it a known good directory (like where you backed up files to), and then another directory that you would like to verify any changes on, and finally a working directory it will store it’s files in.  Optionally it will mail the report and the diff file to your email address.  Edit the list_files() method to filter out log files or whatever else you DON’T care about changing.  After it runs the files you want w..." />
<meta property="article:published_time" content="2011-09-08T21:47:05+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="413954.html">[bash] Detect and report file system changes</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/technology.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>Technology</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/moparisthebest.html'><span itemprop='name'>moparisthebest</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-09-08T21:47:05Z'>
            <time itemprop='dateModified' datetime='2016-08-01T14:45:58Z' class='post-time'>
              August 1, 2016,  2:45pm
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>In light of recent events, you can guess what I wrote this code for.  Basically you give it a known good directory (like where you backed up files to), and then another directory that you would like to verify any changes on, and finally a working directory it will store it’s files in.  Optionally it will mail the report and the diff file to your email address.</p>
<p>Edit the list_files() method to filter out log files or whatever else you DON’T care about changing.</p>
<p>After it runs the files you want will be in:<br>
$work_dir/report<br>
$work_dir/files_changed.diff</p>
<p>What I do is list all the files in both directories, list the ones that were added, list the ones that were removed, then take the md5sum of all the files that exist in both folders to detect which ones have changed.  Then I generate a diff file with all of the changes (ignoring whitespace).</p>
<p>You could even run it with crontab to mail you a report every X minutes, that’s what I do.</p>
<pre><code class="lang-auto">#!/bin/bash
dir1=$1
dir2=$2
work_dir=$3
mail_to=$4
mail_from=$5

[ "$mail_from" == "" ] &amp;&amp; mail_from="root"

mkdir -p $work_dir

list_files(){
	find -L . -not -type d -not -type l | egrep -v "^./rdiff-backup-data" | egrep -v '.bash_history$' | egrep -v 'logs/lighttpd/.*\.log$'
}

print_report(){
	[ -s "$2" ] &amp;&amp; (echo -e "$1"; cat "$2"; echo; echo -en "$3") &gt;&gt; $work_dir/report
}

cd $dir1
list_files &gt; $work_dir/dir1.files

cd $dir2
list_files &gt; $work_dir/dir2.files

diff -Naurw $work_dir/dir1.files $work_dir/dir2.files &gt; $work_dir/files.diff

egrep "^\+" $work_dir/files.diff | tail -n+2 | sed "s/^\+//" &gt; $work_dir/files_added
egrep "^-"  $work_dir/files.diff | tail -n+2 | sed "s/^-//" &gt; $work_dir/files_removed
cat $work_dir/dir1.files $work_dir/dir2.files | sort | uniq -d &gt; $work_dir/files_to_checksum
cat $work_dir/dir1.files $work_dir/dir2.files | sort | uniq -u &gt; $work_dir/files_added_or_removed

rm -f $work_dir/dir1.md5
cd $dir1
temp_ifs=$IFS
IFS="
"
for f in $(cat $work_dir/files_to_checksum)
do
	md5sum "$f" &gt;&gt; $work_dir/dir1.md5
done

cd $dir2
cat $work_dir/dir1.md5 | md5sum -c | egrep -v ": OK$" | sed "s/: FAILED$//"  &gt; $work_dir/files_changed

rm -f $work_dir/files_changed.diff
dir1_sed=$(echo $dir1 | sed -e 's/\(\.\|\/\|\*\|\[\|\]\|\\\)/\\&amp;/g')
dir2_sed=$(echo $dir2 | sed -e 's/\(\.\|\/\|\*\|\[\|\]\|\\\)/\\&amp;/g')
for f in $(cat $work_dir/files_changed | sed "s/\.\///")
do
	tmp=$(diff -Naurw "$dir1/$f" "$dir2/$f")
	# just use sed on the first 2 lines, so we know we won't mess up anything else
	echo "$tmp" | head -n2 | sed "s/^--- $dir1_sed/--- a/" | sed "s/^+++ $dir2_sed/+++ b/" &gt;&gt; $work_dir/files_changed.diff
	# copy from lines 3 on down
	echo "$tmp" | tail -n+3 &gt;&gt; $work_dir/files_changed.diff
done
IFS=$temp_ifs

rm -f $work_dir/report
print_report "Files added:\n" "$work_dir/files_added"
print_report "Files removed:\n" "$work_dir/files_removed"
print_report "Files changed:\n" "$work_dir/files_changed" "Diff file: $work_dir/files_changed.diff\n\n"

[ -s "$work_dir/report" ] || attach="no" &amp;&amp; echo -e "No changes!\n" &gt;&gt; $work_dir/report

[ "$mail_to" != "" ] &amp;&amp; ( echo -e "To: $mail_to\nFrom: $mail_from\nSubject: Diff Report\n"; cat $work_dir/report $work_dir/files_changed.diff; echo; [ "$attach" != "no" ] &amp;&amp; uuencode $work_dir/report report.txt; [ -s "$work_dir/files_changed.diff" ] &amp;&amp; uuencode $work_dir/files_changed.diff files_changed.diff.txt ) | sendmail -v $mail_to

exit 0;</code></pre>
<p>Anyway, any comments/suggestions on it?</p>
<p>edit:<br>
You can replace ‘md5sum’ with ‘sha1sum’ seamlessly, but it will take much more time, and it is very non-trivial to make md5 collisions.  I don’t think it’s ever been done in the real-world (only on contrived files), so I think this program is fairly safe using md5 for the time being.</p>
      </div>

      <meta itemprop='headline' content='[bash] Detect and report file system changes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Wizzup.html'><span itemprop='name'>Wizzup</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-10-06T09:03:02Z'>
            <time itemprop='dateModified' datetime='2016-08-01T15:23:26Z' class='post-time'>
              August 1, 2016,  3:23pm
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>May I suggest using tripwire? It’s designed to handle this. <a href="http://sourceforge.net/projects/tripwire/" rel="nofollow noopener">http://sourceforge.net/projects/tripwire/</a></p>
      </div>

      <meta itemprop='headline' content='[bash] Detect and report file system changes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/moparisthebest.html'><span itemprop='name'>moparisthebest</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-10-06T16:34:51Z'>
            <time itemprop='dateModified' datetime='2016-08-01T15:23:33Z' class='post-time'>
              August 1, 2016,  3:23pm
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I’ve actually improved this script a lot since this thread, I need to make it consumable for the public and release it again.  I did look at a few other solutions, but I wasn’t big fans.  Have you used tripwire yourself?</p>
      </div>

      <meta itemprop='headline' content='[bash] Detect and report file system changes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Wizzup.html'><span itemprop='name'>Wizzup</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-10-06T16:51:06Z'>
            <time itemprop='dateModified' datetime='2016-08-01T15:23:33Z' class='post-time'>
              August 1, 2016,  3:23pm
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I’ve merged and configured it, wasn’t too impressed but it seems like the right tool for the job.</p>
      </div>

      <meta itemprop='headline' content='[bash] Detect and report file system changes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Mopman.html'><span itemprop='name'>Mopman</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2011-10-07T17:17:07Z'>
            <time itemprop='dateModified' datetime='2016-08-01T15:24:56Z' class='post-time'>
              August 1, 2016,  3:24pm
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I’ve only ever used the file/directory watcher built into CSF, because its usually cpanel boxen I need to do this on.</p>
<p>This looks interesting as a simple lightweight solution for boxes I don’t want CSF on though</p>
      </div>

      <meta itemprop='headline' content='[bash] Detect and report file system changes'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/bash-detect-and-report-file-system-changes/413954 by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Aug 2019 20:05:12 GMT -->
</html>
